import{cl as D,cm as ie,X as ue,Y as me,d as ce,x as X,cn as Q,ca as Z,f as m,C as V,h as J,c as M,co as K,ad as W,bb as ge,cp as $,b as ee,o,a as d,n as i,k as I,w as te,t as h,l as C,_ as pe}from"./index-B7jvAjdE.js";import{m as ae}from"./actionDebouncer-CJRtFyZn.js";import{a as ne}from"./numberUtils-CkF0oMe2.js";import{M as ye}from"./MInputSwitch-C-Z-JJsG.js";import{M as ve}from"./MInputSingleSelectSwitch-CuptGC6e.js";import{M as fe}from"./MInputTextArea-BMdoSBpm.js";import{a as he}from"./_arrayIncludes-B3ShBz6l.js";function we(){}var Se=1/0,Ie=D&&1/ie(new D([,-0]))[1]==Se?function(s){return new D(s)}:we,be=200;function _e(s,n,b){var e=-1,w=he,v=s.length,f=!0,u=[],a=u;if(v>=be){var S=Ie(s);if(S)return ie(S);f=!1,w=me,a=new ue}else a=u;e:for(;++e<v;){var c=s[e],p=c;if(c=c!==0?c:0,f&&p===p){for(var y=a.length;y--;)if(a[y]===p)continue e;u.push(c)}else w(a,p,b)||(a!==u&&a.push(p),u.push(c))}return u}function le(s){return s&&s.length?_e(s):[]}const Pe=ce({__name:"MessageAudienceForm",props:{isPlayerTargetingSupported:{type:Boolean,default:!0},modelValue:{default:()=>({targetPlayers:[],targetCondition:null,valid:!0})}},emits:["update:modelValue"],setup(s,{expose:n,emit:b}){n();const e=s,w=W(),{data:v}=X(Q()),{data:f,error:u}=X(Z()),a=m();function S(t){return{id:t.info.segmentId,value:{displayName:t.info.displayName,segmentId:t.info.segmentId,estimatedPlayerCount:t.sizeEstimate!=null?`~ ${ne(t.sizeEstimate)} player${t.sizeEstimate!==1?"s":""}`:"Estimate pending..."}}}function c(t){const l=v.value.segments.find(r=>t===r.info.segmentId);return l?S(l).value||null:{displayName:"missing",segmentId:"missing",estimatedPlayerCount:"missing"}}const p=V(v,t=>{t?.segments&&(a.value=t.segments.map(l=>S(l)),a.value.length>0&&K(()=>{p()}))},{immediate:!0}),y=m((e.modelValue.targetCondition?.requireAnySegment??e.modelValue.targetCondition?.requireAllSegments??[]).map(t=>c(t)));V(y,P);const A=m(e.modelValue.targetPlayers.length>0||!!e.modelValue.targetCondition),L=m(e.modelValue.targetCondition?.requireAllSegments?"all":"any");V(L,P);const se=[{label:"All",value:"all"},{label:"Any",value:"any"}],T=m("");J(()=>{e.modelValue.targetPlayers.length>0&&(T.value=e.modelValue.targetPlayers.join(", "))});const k=m(e.modelValue.targetPlayers),N=m([]),O=m(),_=m(!1),E=M(()=>{const t=f.value?.options.find(l=>l.name==="System");return t?t.values.maxTargetPlayersListSize:0});function re(t){A.value=t,P()}const Y=M(()=>!(_.value||e.isPlayerTargetingSupported&&O.value)),z=M(()=>!!(A.value&&(y.value.length>0||k.value.length>0))),oe=M(()=>T.value?_.value?"loading":Y.value?"success":"danger":"default");V(T,t=>{O.value=void 0,N.value=[],_.value=!0,F.requestAction(t)});function q(t,l){const r=le(t.trim().split(",").map(x=>x.trim()));if(r[r.length-1]===""&&r.pop(),r.length>E.value){l({isValid:!1,errorMessage:`Too many players! You entered a list of ${r.length} players but the maximum limit is ${E.value}. Consider using segments instead?`});return}const U=r.filter(x=>!$(x));if(U.length>0){l({isValid:!1,errorMessage:"Not all listed IDs look like valid player IDs!",invalidIds:U});return}w.post("players/bulkValidate",{PlayerIds:r}).then(x=>{const G=x.data,de=G.filter(g=>g.validId&&g.playerData!=null).map(g=>g.playerIdQuery),H=G.filter(g=>!g.validId||g.playerData==null).map(g=>g.playerIdQuery);H.length>0?l({isValid:!1,errorMessage:"Invalid player IDs in list!",invalidIds:H}):l({isValid:!0,validIds:de})})}function B(){}const F=ae({setup:q,cancel:B},t=>{O.value=t.errorMessage,k.value=t.validIds??[],N.value=t.invalidIds??[],_.value=!1,P()},()=>{},500),R=b;function P(){const t={targetPlayers:[],targetCondition:null,valid:!0};if(A.value){if(t.targetPlayers=k.value,y.value.length>0){t.targetCondition={$type:"Metaplay.Core.Player.PlayerSegmentBasicCondition"};const l=y.value.map(r=>r.segmentId);L.value==="all"?t.targetCondition.requireAllSegments=l:t.targetCondition.requireAnySegment=l}(!z.value||!Y.value)&&(t.valid=!1)}R("update:modelValue",t)}const j={props:e,gameServerApi:w,playerSegmentsData:v,runtimeOptionsData:f,runtimeOptionsError:u,segmentOptions:a,makeSegmentOptionFromSegmentInfo:S,makeSegmentOptionFromSegmentId:c,playerSegmentsUnwatch:p,chosenSegments:y,enableTargeting:A,segmentMatchingRule:L,segmentMatchingOptions:se,playerBatchImportString:T,playerList:k,invalidPlayerIds:N,playerListValidationError:O,isPlayerListValidationLoading:_,maxTargetPlayerListSize:E,onEnableTargetingChange:re,isPlayerInputValid:Y,isFormValid:z,playerInputTextAreaVariant:oe,actionHandlerSetup:q,actionHandlerCancel:B,validationDebouncedAction:F,emits:R,update:P,get uniq(){return le},computed:M,nextTick:K,ref:m,watch:V,onMounted:J,get useGameServerApi(){return W},get makeActionDebouncer(){return ae},get MClipboardCopy(){return ge},get MInputSingleSelectSwitch(){return ve},get MInputTextArea(){return fe},get MInputSwitch(){return ye},get abbreviateNumber(){return ne},get useSubscription(){return X},get isValidPlayerId(){return $},get getPlayerSegmentsSubscriptionOptions(){return Q},get getRuntimeOptionsSubscriptionOptions(){return Z}};return Object.defineProperty(j,"__isScriptSetup",{enumerable:!1,value:!0}),j}}),xe={class:"tw-rounded-md tw-border tw-border-neutral-200 tw-bg-neutral-50 tw-p-3"},Ve={class:"tw-flex tw-justify-between"},Me={key:0,class:"tw-mt-2 tw-border-t tw-border-neutral-200 tw-pt-3"},Ce={key:0,class:"tw-w-full tw-text-center"},Ae={key:1,class:"text-muted tw-w-full tw-py-4 tw-text-center tw-italic"},Te={key:2},ke={class:"tw-flex tw-space-x-2"},Oe={class:"tw-flex tw-justify-between"},Le={class:"font-weight-bold"},Ne={class:"tw-text-right"},Ee={class:"tw-mt-1 tw-text-xs tw-text-neutral-400"},Ye={key:0},De={key:1},Xe={key:3,class:"tw-w-full"},ze={class:"tw-mb-1 tw-mt-4"},qe={class:"tw-ml-1 tw-text-xs tw-text-neutral-400"},Be={key:0,class:"tw-mt-1 tw-text-xs tw-text-red-400"},Fe={key:0},Re={key:4,class:"tw-mt-1 tw-text-xs tw-text-red-400"};function je(s,n,b,e,w,v){const f=ee("b-spinner"),u=ee("meta-input-select");return o(),d("div",xe,[i("div",Ve,[n[3]||(n[3]=i("div",{class:"tw-text-sm tw-font-bold tw-leading-6"},"Enable Targeting",-1)),I(e.MInputSwitch,{class:"tw-relative tw-top-1","model-value":e.enableTargeting,name:"targetingEnabled",size:"small","onUpdate:modelValue":e.onEnableTargetingChange},null,8,["model-value"])]),e.enableTargeting?(o(),d("div",Me,[n[5]||(n[5]=i("div",{class:"tw-text-sm tw-font-bold tw-leading-6"},"Select Player Segments",-1)),e.segmentOptions?e.segmentOptions.length===0?(o(),d("div",Ae,"No segments defined in the currently active game configs.")):(o(),d("div",Te,[i("div",ke,[I(e.MInputSingleSelectSwitch,{class:"tw-shrink-0","model-value":e.segmentMatchingRule,options:e.segmentMatchingOptions,size:"small","onUpdate:modelValue":n[0]||(n[0]=a=>e.segmentMatchingRule=a)},null,8,["model-value"]),I(u,{value:e.chosenSegments,options:e.segmentOptions,searchFields:["displayName"],placeholder:"Select player segments...",multiselect:"",onInput:n[1]||(n[1]=a=>e.chosenSegments=a)},{option:te(({option:a})=>[i("div",Oe,[i("div",Le,h(a?.displayName),1),i("div",Ne,h(a?.estimatedPlayerCount),1)])]),selectedOption:te(({option:a})=>[i("div",null,h(a?.displayName),1)]),_:1},8,["value","options"])]),i("div",Ee,[e.segmentMatchingRule==="all"?(o(),d("span",Ye,"Players must match all of the selected segments.")):(o(),d("span",De,"Players must match at least one of the selected segments."))])])):(o(),d("div",Ce,[I(f,{label:"Loading segments..."})])),b.isPlayerTargetingSupported?(o(),d("div",Xe,[i("div",ze,[n[4]||(n[4]=i("span",{class:"tw-text-sm tw-font-bold tw-leading-6"},"Select Individual Players",-1)),i("span",qe,"("+h(e.playerList.length)+"/"+h(e.maxTargetPlayerListSize)+" selected)",1)]),I(e.MInputTextArea,{"model-value":e.playerBatchImportString,variant:e.playerInputTextAreaVariant,disabled:e.maxTargetPlayerListSize===0,placeholder:e.maxTargetPlayerListSize===0?"To use this feature, set a maximum number of target player in your runtime options.":"Comma separated list of IDs: Player:XXXXXXXXXX, Player:YYYYYYYYYY, ...",hintMessage:e.playerBatchImportString&&!e.isPlayerInputValid?e.playerListValidationError:"","onUpdate:modelValue":n[2]||(n[2]=a=>e.playerBatchImportString=a)},null,8,["model-value","variant","disabled","placeholder","hintMessage"]),e.invalidPlayerIds&&e.invalidPlayerIds.length>0?(o(),d("div",Be,[i("span",null,"Invalid player IDs: "+h(e.invalidPlayerIds.slice(0,20).join(", ")),1),e.invalidPlayerIds.length>20?(o(),d("span",Fe,"and "+h(e.invalidPlayerIds.length-20)+" more.",1)):C("",!0),I(e.MClipboardCopy,{contents:e.invalidPlayerIds.join(",")},null,8,["contents"])])):C("",!0)])):C("",!0),!e.isFormValid&&!e.isPlayerListValidationLoading?(o(),d("div",Re,"Select at least one target segment or individual player.")):C("",!0)])):C("",!0)])}const We=pe(Pe,[["render",je],["__file","MessageAudienceForm.vue"]]);export{We as M};
