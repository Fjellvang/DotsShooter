import{d as Y,f as p,c as B,d_ as O,cI as k,ad as V,ak as x,M as z,a0 as J,ac as H,ai as K,s as Q,v as X,a8 as Z,b as F,o as a,e as u,w as o,n as d,k as v,p as n,a as c,F as P,r as D,t as f,l as b,_ as $}from"./index-B7jvAjdE.js";import{M as ee}from"./MActionModalButton-CvWVuTB-.js";import{M as te}from"./MInputSingleFileContents-tOi-WM9p.js";import{M as re}from"./MInputSingleSelectSwitch-CuptGC6e.js";import{M as ie}from"./MInputTextArea-BMdoSBpm.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";import"./MInputSingleFile-Dbi3mt5D.js";import"./MInputHintMessage-DbuBS4Kn.js";import"./index-CDBqmjrS.js";import"./index-B_QkKjtG.js";import"./MInputSimpleSelectDropdown-DIlBEFcs.js";import"./index-qTA83-by.js";import"./debounce-B8gTqdZO.js";import"./isSymbol-B7ZrWRtH.js";const oe=Y({__name:"ImportEntities",setup(T,{expose:t}){t();const M=V(),e=p(""),g=p(),w=p(),y=p(""),m=p(),r=p("ignore");function j(i){r.value=i,I(g.value??e.value).catch(l=>{console.error(l)})}const E=p(),R=B(()=>{if(!((e.value!==""||g.value!==null)&&!w.value))return!!w.value}),N=[{value:"ignore",label:"Ignore"},{value:"overwrite",label:"Overwrite"},{value:"createnew",label:"Create New"}];function G(){e.value="",g.value=void 0,w.value=void 0,m.value=void 0,r.value="ignore"}let h;async function I(i){if(m.value=void 0,w.value=void 0,y.value="",i){let l;try{l=A(i)}catch(s){m.value=new x("Calculating payload failed",s.message);return}try{h&&h.cancel("Request canceled by user interaction."),h=k.CancelToken.source();const s=(await M.post(`/entityArchive/validate?overwritePolicy=${r.value}`,l)).data;s.error?m.value=new x("Validation failed",s.error.message,500,void 0,[{title:"Details",content:s.error.details}]):(w.value=s.entities,s.entities.map(C=>(C.overwriteDiff!==null&&(y.value=C.overwriteDiff),y.value)))}catch(s){k.isCancel(s)?console.log(s):m.value=new x("Validation failed",s.response.data.error.message)}}}const _=O()?.proxy;function L(i,l){return i.status==="Success"&&r.value==="ignore"?l==="preview"?"New entity will be created.":"New entity created.":i.status==="Ignored"?l==="preview"?"Existing entity will be preserved.":`Existing entity ${i.sourceId} has been preserved.`:i.status==="Success"&&r.value==="overwrite"&&i.overwriteDiff!==null?l==="preview"?"Existing entity will be overwritten.":`Existing entity ${i.sourceId} has been overwritten.`:i.status==="Success"&&r.value==="overwrite"&&i.overwriteDiff===null?l==="preview"?"New entity will be created.":"New entity created.":i.status==="Success"&&r.value==="createnew"?l==="preview"?`A new entity will be created from ${i.sourceId}.`:`A new entity ${i.destinationId} has been created. `:""}function W(i){e.value=i,I(i)}function U(i){g.value=i,I(i)}async function q(i){const l=A(i),s=(await M.post(`/entityArchive/import?overwritePolicy=${r.value}`,l)).data;if(s.error)throw new Error(`${s.error.message}
${s.error.details}`);E.value=s.entities,_?.$bvModal.show("import-entities-results-modal")}function A(i){let l;try{l=JSON.parse(i)}catch(s){throw new Error(`Could not parse archive. Got '${s.message}'.`)}if(typeof l!="object")throw new Error(`Entity archive must be an object. Got '${typeof l}'.`);if(Array.isArray(l))throw new Error("Entity archive must be an object. Got 'array'.");if(!("entities"in l))throw new Error("Entity archive must contain entities but none found.");return l}const S={gameServerApi:M,entityArchiveText:e,entityArchiveFile:g,validationResultsObject:w,validationResultDiff:y,displayError:m,overwritePolicy:r,updateOverwritePolicy:j,importResultsObject:E,isFormValid:R,overwritePolicyOptions:N,resetModal:G,get cancelTokenSource(){return h},set cancelTokenSource(i){h=i},validateArchive:I,vueInstance:_,importMessage:L,onEntityArchiveTextChange:W,onEntityArchiveFileChange:U,importArchive:q,calculatePayload:A,get axios(){return k},computed:B,getCurrentInstance:O,ref:p,get useGameServerApi(){return V},get DisplayError(){return x},get MActionModalButton(){return ee},get MBadge(){return z},get MCallout(){return J},get MCard(){return H},get MErrorCallout(){return K},get MInputSingleSelectSwitch(){return re},get MInputSingleFileContents(){return te},get MInputTextArea(){return ie},get MList(){return Q},get MListItem(){return X},get MTextButton(){return Z}};return Object.defineProperty(S,"__isScriptSetup",{enumerable:!1,value:!0}),S}}),ae={class:"tw-flex tw-justify-end"},ne={class:"tw-mb-4"},le={class:"font-weight-bold"},se={key:0},de={class:"tw-text-red-500"},ue={key:0,class:"tw-text-red-500"},ce={key:1},ve={key:3,class:"tw-mt-4"},me={class:"code-box text-monospace border rounded bg-light tw-w-full",style:{"max-height":"20.3rem"}},fe={key:0},pe={key:1},we={key:2},ge={key:0},ye={key:0},he={key:1};function be(T,t,M,e,g,w){const y=F("meta-no-seatbelts"),m=F("fa-icon");return a(),u(e.MCard,{title:"Import Game Entities"},{subtitle:o(()=>t[0]||(t[0]=[d("p",null,"You can use this feature to import an archive of one or more game entities into the current deployment.",-1)])),default:o(()=>[d("div",ae,[v(e.MActionModalButton,{"modal-title":"Import Game Entities",action:()=>e.importArchive(e.entityArchiveFile??e.entityArchiveText),"trigger-button-label":"Open Import Menu","ok-button-label":"Import Archive","ok-button-disabled-tooltip":e.isFormValid?void 0:"Paste in or upload a valid entity archive to proceed.",permission:"api.entity_archive.import",onShow:e.resetModal,"data-testid":"batch-import-entities"},{default:o(()=>[t[4]||(t[4]=d("h6",{class:"tw-mb-1"},"Paste Archive Data",-1)),d("p",ne,[t[2]||(t[2]=n("You can upload the serialized data of an ")),v(e.MBadge,null,{default:o(()=>t[1]||(t[1]=[n("entity archive")]),void 0,!0),_:1}),t[3]||(t[3]=n(" here to import them into the current deployment."))]),v(e.MInputTextArea,{class:"tw-mb-2",label:"Paste in an archive...","model-value":e.entityArchiveText,placeholder:e.entityArchiveFile!=null?"File upload selected":"{'entities':{'player':...",variant:e.isFormValid!==void 0?e.isFormValid?"success":"danger":"default",rows:5,disabled:!!e.entityArchiveFile,"onUpdate:modelValue":e.onEntityArchiveTextChange,"data-testid":"entity-archive-text"},null,8,["model-value","placeholder","variant","disabled"]),v(e.MInputSingleFileContents,{class:"tw-mb-3",label:"...or upload a file...","model-value":e.entityArchiveFile,placeholder:e.entityArchiveText!==""?"Manual paste selected":"Choose or drop an entity archive file",variant:e.isFormValid!==void 0?e.isFormValid?"success":"danger":"default",disabled:e.entityArchiveText!=="","accepted-file-types":".json","onUpdate:modelValue":e.onEntityArchiveFileChange,"data-testid":"entity-archive-file"},null,8,["model-value","placeholder","variant","disabled"]),v(e.MInputSingleSelectSwitch,{"model-value":e.overwritePolicy,options:e.overwritePolicyOptions,label:"Overwrite policy","onUpdate:modelValue":e.updateOverwritePolicy},null,8,["model-value"]),t[5]||(t[5]=d("div",{class:"tw-mt-2 tw-text-xs tw-text-neutral-500"},[d("p",null,"Overwrite policy determines how to deal with conflicting entities during import:"),d("p",{class:"tw-m-0.5"},[d("span",{class:"tw-font-semibold"},"Ignore"),n(" - Duplicate entities will not be imported.")]),d("p",{class:"tw-m-0.5"},[d("span",{class:"tw-font-semibold"},"Overwrite"),n(" - Duplicate entities will overwrite existing ones.")]),d("p",{class:"tw-m-0.5"},[d("span",{class:"tw-font-semibold"},"Create New"),n(" - Duplicate entities will be imported as new entities with new unique ID's.")])],-1))]),"right-panel":o(()=>[t[12]||(t[12]=d("h6",{class:"tw-mb-4"},"Preview Incoming Data",-1)),!e.validationResultsObject&&!e.displayError?(a(),u(e.MCallout,{key:0,title:"Preview",variant:"neutral"},{default:o(()=>[t[7]||(t[7]=n("Paste in a valid ")),v(e.MBadge,null,{default:o(()=>t[6]||(t[6]=[n("entity archive")]),void 0,!0),_:1}),t[8]||(t[8]=n(" from a compatible game version to preview what data will be copied over."))],void 0,!0),_:1})):e.validationResultsObject&&e.validationResultsObject.length>0?(a(),u(e.MList,{key:1,showBorder:""},{default:o(()=>[(a(!0),c(P,null,D(e.validationResultsObject,r=>(a(),u(e.MListItem,{class:"tw-px-3",key:r.sourceId},{"top-right":o(()=>[r.error?(a(),u(e.MBadge,{key:1,variant:"danger"},{default:o(()=>t[10]||(t[10]=[n("Validation error")]),void 0,!0),_:1})):(a(),u(e.MBadge,{key:0,variant:"success"},{default:o(()=>t[9]||(t[9]=[n("Validation ok")]),void 0,!0),_:1}))]),"bottom-left":o(()=>[r.error?(a(),c("span",se,[d("div",de,f(r.error.message),1),r.error.details?(a(),c("div",ue,f(r.error.details),1)):b("",!0)])):(a(),c("span",ce,f(e.importMessage(r,"preview")),1))]),default:o(()=>[d("span",le,"Source: "+f(r.sourceId),1)],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})):(a(),u(e.MCallout,{key:2,title:"Empty Archive"},{default:o(()=>t[11]||(t[11]=[n("Entity archive is empty. Are you sure you pasted the right thing?")]),void 0,!0),_:1})),e.validationResultDiff?(a(),c("div",ve,[d("div",me,[d("pre",null,f(e.validationResultDiff),1)])])):b("",!0),e.displayError?(a(),u(e.MErrorCallout,{key:4,error:e.displayError},null,8,["error"])):b("",!0)]),"bottom-panel":o(()=>[v(y,{class:"tw-mx-auto tw-w-7/12"})]),"result-panel":o(()=>[t[19]||(t[19]=d("p",{class:"tw-mb-4"},"Import complete, below are the results:",-1)),e.importResultsObject&&e.importResultsObject.length>0?(a(),u(e.MList,{key:0,showBorder:""},{default:o(()=>[(a(!0),c(P,null,D(e.importResultsObject,r=>(a(),u(e.MListItem,{class:"tw-px-3",key:r.sourceId},{"top-right":o(()=>[r.status==="Success"?(a(),u(e.MBadge,{key:0,variant:"success"},{default:o(()=>t[13]||(t[13]=[n("Imported")]),void 0,!0),_:1})):r.status==="Error"?(a(),u(e.MBadge,{key:1,variant:"danger"},{default:o(()=>t[14]||(t[14]=[n("Error")]),void 0,!0),_:1})):(a(),u(e.MBadge,{key:2,variant:"warning"},{default:o(()=>t[15]||(t[15]=[n("Skipped")]),void 0,!0),_:1}))]),"bottom-left":o(()=>[n(f(e.importMessage(r)),1)]),"bottom-right":o(()=>[r.status==="Success"?(a(),c("span",ge,[String(r.destinationId).startsWith("Player")?(a(),c("span",ye,[v(e.MTextButton,{to:`/players/${r.destinationId}`},{default:o(()=>t[16]||(t[16]=[n("View player")]),void 0,!0),_:2},1032,["to"])])):String(r.destinationId).startsWith("Guild")?(a(),c("span",he,[v(e.MTextButton,{to:`/guilds/${r.destinationId}`},{default:o(()=>t[17]||(t[17]=[n("View guild")]),void 0,!0),_:2},1032,["to"])])):b("",!0)])):b("",!0)]),default:o(()=>[String(r.destinationId).startsWith("Player")?(a(),c("span",fe,[v(m,{icon:"user"}),n(" "+f(r.destinationId),1)])):String(r.destinationId).startsWith("Guild")?(a(),c("span",pe,[v(m,{icon:"chess-rook"}),n(" "+f(r.destinationId)+"]",1)])):(a(),c("span",we,f(r.destinationId),1))],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})):(a(),u(e.MCallout,{key:1,title:"Empty Archive"},{default:o(()=>t[18]||(t[18]=[n("Empty entity archive. Nothing was imported.")]),void 0,!0),_:1}))]),_:1},8,["action","ok-button-disabled-tooltip"])])],void 0,!0),_:1})}const Te=$(oe,[["render",be],["__file","ImportEntities.vue"]]);export{Te as default};
