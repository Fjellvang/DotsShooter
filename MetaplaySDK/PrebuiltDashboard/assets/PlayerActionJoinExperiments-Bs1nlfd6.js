import{d as U,x as S,f as T,c as l,ad as B,M as z,a8 as R,ae as N,b as E,o as I,e as M,w as g,p,k as v,a as Y,n as i,t as q,l as H,_ as K}from"./index-B7jvAjdE.js";import{M as L}from"./MActionModalButton-CvWVuTB-.js";import{M as Q}from"./MInputSwitch-C-Z-JJsG.js";import{g as P}from"./experiments-phlJ4_07.js";import{a as j}from"./players-CydHenLG.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";import"./index-B_QkKjtG.js";const W=U({__name:"PlayerActionJoinExperiments",props:{playerId:{}},setup(A,{expose:t}){t();const y=A,n=B(),{data:r,refresh:b}=S(j(y.playerId)),{data:m}=S(P()),e=T(d());function d(){return{experimentId:null,variantId:null,isTester:!1}}const u=l(()=>m.value.experiments.length),w=l(()=>r.value.experiments),F=l(()=>Object.values(m.value.experiments).filter(a=>["Inactive","Testing","Ongoing","Paused"].includes(a.phase)&&a.whyInvalid===null).map(a=>({value:a.experimentId,id:Object.keys(r.value.model.experiments.experimentGroupAssignment).includes(a.experimentId)?`${a.displayName} / ${a.experimentId} (already enrolled)`:a.displayName}))),x=l(()=>e.value.experimentId===null?!1:Object.keys(r.value.model.experiments.experimentGroupAssignment).includes(e.value.experimentId)),_=l(()=>{if(e.value.variantId===null||e.value.experimentId===null)return!1;const s=e.value.variantId==="Control group"?null:e.value.variantId;return r.value.model.experiments.experimentGroupAssignment[e.value.experimentId]?.variantId===s}),V=l(()=>!e.value.experimentId||!e.value.variantId?"Please select an experiment and variant.":x.value&&_.value?w.value[e.value.experimentId]?.isPlayerTester!==e.value.isTester?void 0:"No changes detected.":void 0),c=T([]);async function C(s){e.value.experimentId=s;const f=Object.entries(w.value).filter(([o,O])=>O.isPlayerTester);if(e.value.isTester=f.find(([o,O])=>o===e.value.experimentId)!==void 0,x.value?e.value.variantId=r.value.model.experiments.experimentGroupAssignment[e.value.experimentId]?.variantId||"Control group":e.value.variantId=null,c.value=[],!e.value.experimentId||e.value.experimentId==="none")return;const a=await n.get(`/experiments/${e.value.experimentId}`),J=Object.keys(a.data.state.variants).map(o=>({value:o,id:r.value.model.experiments.experimentGroupAssignment[e.value.experimentId]?.variantId===o?`${o} (already enrolled)`:o}));c.value=[{value:"Control group",id:"Control group"},...J]}const{showSuccessNotification:h}=N();async function D(){const s=x.value?`${r.value.model.playerName} changed experiment variant.`:`${r.value.id} enrolled into the experiment.`,f=e.value.variantId==="Control group"?null:e.value.variantId;await n.post(`/players/${r.value.id}/changeExperiment`,{ExperimentId:e.value.experimentId,VariantId:f,IsTester:e.value.isTester}),h(s),b()}function G(){e.value=d(),c.value=[{value:"none",id:"Select an experiment"}]}const k={props:y,gameServerApi:n,playerData:r,playerRefresh:b,experimentsData:m,experimentFormInfo:e,getNewExperimentFormInfo:d,experimentsAvailable:u,playerExperiments:w,experimentOptions:F,alreadyInSelectedExperiment:x,alreadyInSelectedVariant:_,okButtonDisabledTooltip:V,variantOptions:c,updateExperimentSelection:C,showSuccessNotification:h,joinOrUpdateExperiment:D,resetModal:G,computed:l,ref:T,get useGameServerApi(){return B},get MBadge(){return z},get MInputSwitch(){return Q},get MActionModalButton(){return L},get MTextButton(){return R},get useNotifications(){return N},get useSubscription(){return S},get getAllExperimentsSubscriptionOptions(){return P},get getSinglePlayerSubscriptionOptions(){return j}};return Object.defineProperty(k,"__isScriptSetup",{enumerable:!1,value:!0}),k}}),X={key:1},Z={class:"tw-mb-3"},$={class:"tw-mb-3"},ee={class:"tw-mb-3"},te={class:"tw-flex tw-justify-between"};function ne(A,t,y,n,r,b){const m=E("meta-alert"),e=E("meta-input-select"),d=E("meta-no-seatbelts");return I(),M(n.MActionModalButton,{"modal-title":"Join an Experiment",action:n.joinOrUpdateExperiment,"trigger-button-label":"Join Experiment",variant:"warning","ok-button-label":"Save","ok-button-disabled-tooltip":n.okButtonDisabledTooltip,permission:"api.players.edit_experiment_groups",onShow:n.resetModal,"data-testid":"action-join-experiment"},{default:g(()=>[n.experimentsAvailable?(I(),Y("div",X,[i("div",Z,[t[5]||(t[5]=p("You can manually enroll ")),v(n.MBadge,null,{default:g(()=>[p(q(n.playerData.model.playerName),1)],void 0,!0),_:1}),t[6]||(t[6]=p(" in an active experiment, or change their variant in an experiment they are already in."))]),t[10]||(t[10]=i("div",{class:"tw-mb-3 tw-text-xs+ tw-text-neutral-500"},"Note: Players can never leave experiments once enrolled, but you can always change their variant. Moving a player to the control group has the same effect as removing a player from an experiment.",-1)),i("div",$,[t[7]||(t[7]=i("div",{class:"tw-mb-1 tw-font-semibold"},"Experiment",-1)),v(e,{class:"tw-mb-4",value:n.experimentFormInfo.experimentId??"none",options:n.experimentOptions,placeholder:"Select an experiment","no-clear":"",onInput:n.updateExperimentSelection},null,8,["value","options"])]),i("div",ee,[t[8]||(t[8]=i("div",{class:"tw-font-semibold"},"Variant",-1)),v(e,{value:n.experimentFormInfo.variantId??"none",options:n.variantOptions,disabled:!n.experimentFormInfo.experimentId,placeholder:"Select a variant","no-clear":"",onInput:t[0]||(t[0]=u=>n.experimentFormInfo.variantId=u)},null,8,["value","options","disabled"])]),i("div",te,[t[9]||(t[9]=i("div",{class:"tw-font-semibold"},"Tester",-1)),v(n.MInputSwitch,{"model-value":n.experimentFormInfo.isTester,disabled:!n.experimentFormInfo.experimentId,name:"isPlayerTester",size:"small","onUpdate:modelValue":t[1]||(t[1]=u=>n.experimentFormInfo.isTester=u)},null,8,["model-value","disabled"])]),t[11]||(t[11]=i("div",{class:"tw-mb-3 tw-text-xs+ tw-text-neutral-500"},"As a tester, this player can try out the experiment before it is enabled for everyone. This is a great way to test variants before rolling them out!",-1)),n.okButtonDisabledTooltip?H("",!0):(I(),M(d,{key:0,message:"Enrolling a player to an experiment or modifying the variant will force the player to reconnect!"}))])):(I(),M(m,{key:0,title:"No Experiments Available"},{default:g(()=>[t[3]||(t[3]=p("There are no active experiments available in this environment. First, set them up in your game configs and then configure them from the ")),v(n.MTextButton,{to:"/experiments"},{default:g(()=>t[2]||(t[2]=[p("experiments page")]),void 0,!0),_:1}),t[4]||(t[4]=p("."))],void 0,!0),_:1}))]),_:1},8,["ok-button-disabled-tooltip"])}const de=K(W,[["render",ne],["__file","PlayerActionJoinExperiments.vue"]]);export{de as default};
