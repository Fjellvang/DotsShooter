import{d as F,N as p,ck as w,o as f,a as C,n as v,k as c,_ as x,x as O,c as b,f as y,C as B,bG as I,b as A,e as M,w as _,t as V,ab as k,ad as h,ae as U,l as P}from"./index-B7jvAjdE.js";import{M as q}from"./MActionModalButton-CvWVuTB-.js";import{M as z}from"./MInputDateTime-DL6Zd7-d.js";import{M as L}from"./MInputDurationOrEndDateTime-CP-rRAVP.js";import{M as H}from"./MInputText-CzhsT8yb.js";import{M as J}from"./MetaGeneratedForm-BcVgOIy3.js";import{M as E}from"./MessageAudienceForm-Bn0DOLdW.js";import{g as j}from"./analyticsEvents-CRLHbRhO.js";const K=F({__name:"MInputStartDateTimeAndDuration",props:{startDateTime:{},duration:{},disabled:{type:Boolean}},emits:["update:startDateTime","update:duration"],setup(m,{expose:a,emit:o}){a();const t=m,l=o;function s(e){l("update:startDateTime",e)}const r={props:t,emit:l,updateStartDateTime:s,get DateTime(){return p},get Duration(){return w},MInputDateTime:z,MInputDurationOrEndDateTime:L};return Object.defineProperty(r,"__isScriptSetup",{enumerable:!1,value:!0}),r}}),Q={class:"tw-relative tw-z-10 tw-@container"},W={class:"tw-w-full tw-space-y-4 @[700px]:tw-flex @[700px]:tw-space-x-4 @[700px]:tw-space-y-0"};function X(m,a,o,t,l,s){return f(),C("div",Q,[v("div",W,[c(t.MInputDateTime,{class:"tw-flex-shrink-0","model-value":o.startDateTime,label:"Start (UTC)",disabled:o.disabled,"onUpdate:modelValue":a[0]||(a[0]=r=>t.updateStartDateTime(r))},null,8,["model-value","disabled"]),c(t.MInputDurationOrEndDateTime,{class:"tw-grow","model-value":o.duration,referenceDateTime:o.startDateTime,disabled:o.disabled,"onUpdate:modelValue":a[1]||(a[1]=r=>m.$emit("update:duration",r))},null,8,["model-value","referenceDateTime","disabled"])])])}const Y=x(K,[["render",X],["__file","MInputStartDateTimeAndDuration.vue"]]),Z=F({__name:"TriggerConditionForm",props:{modelValue:{}},emits:["update:modelValue"],setup(m,{expose:a,emit:o}){a();const t=m,l=o,{data:s}=O(j()),r=d=>s.value?.find(u=>u.typeCode===d)?.displayName??d.toString(),e=b(()=>s.value?s.value.filter(u=>u.categoryName==="Player"&&u.canTrigger).map(u=>({id:u.typeCode.toString(),value:{displayName:r(u.typeCode),eventTypeCode:u.typeCode}})):[]),n=y();B(()=>t.modelValue,d=>{let i;d&&(i={displayName:r(d.eventTypeCode),eventTypeCode:d.eventTypeCode}),I(n.value,i)||(n.value=i)},{immediate:!0}),B(()=>n.value,d=>{let i;d&&(i={$type:"Metaplay.Server.PlayerTriggerConditionByTriggerType",eventTypeCode:d.eventTypeCode}),I(t.modelValue,i)||l("update:modelValue",i)},{immediate:!0});const g={props:t,emits:l,analyticsEventsData:s,nameFromTypeCode:r,triggerOptions:e,myValue:n,get isEqual(){return I},computed:b,ref:y,watch:B,get useSubscription(){return O},get getAllAnalyticsEventsSubscriptionOptions(){return j}};return Object.defineProperty(g,"__isScriptSetup",{enumerable:!1,value:!0}),g}}),$={key:0,class:"tw-w-full tw-text-center"},tt={key:1,class:"text-muted text-small tw-w-full tw-text-center tw-italic"};function et(m,a,o,t,l,s){const r=A("b-spinner"),e=A("meta-input-select");return t.triggerOptions?t.triggerOptions.length===0?(f(),C("div",tt,"No trigger events defined!")):(f(),M(e,{key:2,value:t.myValue,searchFields:["displayName","eventTypeCode"],options:t.triggerOptions,placeholder:"No trigger condition",onInput:a[0]||(a[0]=n=>t.myValue=n)},{option:_(({option:n})=>[v("div",null,V(n?.eventTypeCode)+": "+V(n?.displayName),1)]),_:1},8,["value","options"])):(f(),C("div",$,[c(r,{label:"Loading trigger events..."})]))}const at=x(Z,[["render",et],["__file","TriggerConditionForm.vue"]]),ot=F({__name:"BroadcastFormButton",props:{buttonText:{},buttonIcon:{default:void 0},prefillData:{default:void 0},editBroadcast:{type:Boolean},broadcastType:{default:"Metaplay.Server.BroadcastMessageContents"},itemName:{default:"Broadcast"},triggeringSupported:{type:Boolean},disabledTooltip:{default:void 0},dataTestid:{default:void 0}},emits:["refresh"],setup(m,{expose:a,emit:o}){a();const t=m,l=h(),s=k(),r=o,e=y(n());function n(){return{name:"",audience:E.props?.modelValue.default(),startAt:p.now(),duration:w.fromObject({days:1}),contents:{},triggerCondition:void 0}}const g=b(()=>!(!e.value.name||e.value.name.length===0)),d=b(()=>{if(!g.value&&!T.value)return"Fill in the required fields to proceed.";if(!g.value)return"Fill in a valid name to proceed.";if(e.value.duration.toMillis()===0)return"The broadcast duration is invalid. Check that it is set correctly to proceed.";if(!e.value.audience.valid)return"The audience targeting is missing or invalid. Check that it is filled out correctly to proceed.";if(!T.value)return"Fill in the broadcast message for all selected locales to proceed."}),{showSuccessNotification:i}=U();async function u(){const D={name:e.value.name,startAt:e.value.startAt.toISO(),endAt:e.value.startAt.plus(e.value.duration).toISO(),targetPlayers:e.value.audience.targetPlayers,targetCondition:e.value.audience.targetCondition,contents:e.value.contents,triggerCondition:e.value.triggerCondition};if(t.prefillData&&t.editBroadcast){D.id=t.prefillData.id,await l.put(`/broadcasts/${D.id}`,D);const S=`${t.itemName} with id ${t.prefillData.id} updated.`;i(S),r("refresh")}else{const S=(await l.post("/broadcasts",D)).data,R=`New ${t.itemName} created with id ${S.id}.`;i(R),r("refresh"),t.prefillData&&await s.push("/broadcasts")}}const T=y(!1);function G(){t.prefillData?(e.value.name=t.editBroadcast?t.prefillData.name:t.prefillData.name+" (copy)",e.value.audience.targetPlayers=t.prefillData.targetPlayers,e.value.audience.targetCondition=t.prefillData.targetCondition,e.value.startAt=t.editBroadcast&&t.prefillData.startAt!==null?p.fromISO(t.prefillData.startAt):p.now(),e.value.duration=t.editBroadcast&&t.prefillData.endAt&&t.prefillData.startAt!==null?p.fromISO(t.prefillData.endAt).diff(p.fromISO(t.prefillData.startAt),["days","minutes","hours"]):w.fromObject({days:1}),e.value.contents=t.prefillData.contents,e.value.triggerCondition=t.prefillData.triggerCondition,T.value=!0):e.value=n()}const N={props:t,gameServerApi:l,router:s,emits:r,broadcastFormInfo:e,getNewBroadcastFormInfo:n,isNameValid:g,okButtonDisabledReason:d,showSuccessNotification:i,createOrUpdateBroadcast:u,contentsValid:T,resetNewBroadcast:G,get DateTime(){return p},get Duration(){return w},computed:b,ref:y,get useRouter(){return k},get useGameServerApi(){return h},get MActionModalButton(){return q},get MInputStartDateTimeAndDuration(){return Y},get MInputText(){return H},get useNotifications(){return U},MetaGeneratedForm:J,MessageAudienceForm:E,TriggerConditionForm:at};return Object.defineProperty(N,"__isScriptSetup",{enumerable:!1,value:!0}),N}}),rt={class:"tw-mb-4"},nt={key:0,class:"tw-mb-4"},it={class:"tw-@container"};function lt(m,a,o,t,l,s){const r=A("fa-icon");return f(),M(t.MActionModalButton,{"modal-title":`${o.buttonText} ${o.itemName}`,action:t.createOrUpdateBroadcast,"trigger-button-label":o.buttonText,"trigger-button-disabled-tooltip":o.disabledTooltip,"ok-button-label":o.editBroadcast?"Update Broadcast":"Start Broadcast","action-button-text":o.buttonText,"ok-button-disabled-tooltip":t.okButtonDisabledReason,permission:"api.broadcasts.edit",onShow:t.resetNewBroadcast,"data-testid":o.dataTestid},{"trigger-button-icon":_(()=>[o.buttonIcon?(f(),M(r,{key:0,class:"tw-h-3.5 tw-w-4 tw-mb-[0.05rem] tw-space-x-2",icon:o.buttonIcon},null,8,["icon"])):P("",!0)]),"right-panel":_(()=>[v("div",it,[c(t.MetaGeneratedForm,{class:"tw-relative tw-z-0",typeName:o.broadcastType,"is-targeting-multiple-players":"",value:t.broadcastFormInfo.contents,page:"BroadcastForm",onInput:a[5]||(a[5]=e=>t.broadcastFormInfo.contents=e),onStatus:a[6]||(a[6]=e=>t.contentsValid=e)},null,8,["typeName","value"])])]),default:_(()=>[c(t.MInputText,{class:"tw-mb-4",label:"Name","model-value":t.broadcastFormInfo.name,variant:t.isNameValid?"success":"danger",placeholder:`${o.itemName} name here...`,"onUpdate:modelValue":a[0]||(a[0]=e=>t.broadcastFormInfo.name=e)},null,8,["model-value","variant","placeholder"]),c(t.MInputStartDateTimeAndDuration,{class:"tw-mb-4",startDateTime:t.broadcastFormInfo.startAt,duration:t.broadcastFormInfo.duration,"onUpdate:startDateTime":a[1]||(a[1]=e=>t.broadcastFormInfo.startAt=e),"onUpdate:duration":a[2]||(a[2]=e=>t.broadcastFormInfo.duration=e)},null,8,["startDateTime","duration"]),v("div",rt,[a[7]||(a[7]=v("h6",null,"Audience",-1)),c(t.MessageAudienceForm,{"model-value":t.broadcastFormInfo.audience,"onUpdate:modelValue":a[3]||(a[3]=e=>t.broadcastFormInfo.audience=e)},null,8,["model-value"])]),o.triggeringSupported?(f(),C("div",nt,[a[8]||(a[8]=v("h6",null,"Triggering",-1)),c(t.TriggerConditionForm,{"model-value":t.broadcastFormInfo.triggerCondition,"onUpdate:modelValue":a[4]||(a[4]=e=>t.broadcastFormInfo.triggerCondition=e)},null,8,["model-value"])])):P("",!0)],void 0,!0),_:1},8,["modal-title","trigger-button-label","trigger-button-disabled-tooltip","ok-button-label","action-button-text","ok-button-disabled-tooltip","data-testid"])}const vt=x(ot,[["render",lt],["__file","BroadcastFormButton.vue"]]);export{vt as B};
