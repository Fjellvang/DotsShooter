import{d as ye,x as J,c as x,b as C,o as d,a as S,n as c,t as B,p as y,k as u,l as g,_ as _e,aj as de,ab as le,f as D,cf as ee,cg as fe,C as te,ch as ue,ak as ne,ad as ce,M as Te,bN as Ee,v as Pe,a8 as je,ae as ge,e as w,w as a,r as me,$ as Fe,F as ve}from"./index-B7jvAjdE.js";import{d as pe}from"./index-DOK9ROJo.js";import{M as Ne,a as Ue}from"./MViewContainer-BTeE2xDT.js";import{M as ze}from"./MInputSingleSelectSwitch-CuptGC6e.js";import{M as U,a as z,c as K,b as oe}from"./metaListUtils-B-xQ0HnD.js";import{g as Q,a as we}from"./gameConfigs-DlpfRS5r.js";import{C as Je}from"./CoreUiPlacement-CPf1fwrN.js";import"./index-CDBqmjrS.js";import"./index-B_QkKjtG.js";import"./MInputSimpleSelectDropdown-DIlBEFcs.js";import"./index-qTA83-by.js";import"./MInputHintMessage-DbuBS4Kn.js";const qe=ye({__name:"GameConfigSelectOption",props:{gameConfigId:{}},setup(r,{expose:n}){n();const A=r,{data:e}=J(Q()),V=x(()=>(e.value??[]).find(O=>O.id===A.gameConfigId)),k={props:A,allGameConfigsData:e,gameConfigFromId:V,computed:x,get useSubscription(){return J},get getAllGameConfigsSubscriptionOptions(){return Q}};return Object.defineProperty(k,"__isScriptSetup",{enumerable:!1,value:!0}),k}}),Ke={style:{"font-size":"0.95rem"}},Qe={class:"font-weight-bold"},We={class:"small font-mono"},Ye={key:0,class:"small"};function He(r,n,A,e,V,k){const O=C("meta-time");return d(),S("div",Ke,[c("div",Qe,B(e.gameConfigFromId?.name??"No name available"),1),c("div",We,B(A.gameConfigId),1),e.gameConfigFromId?(d(),S("div",Ye,[n[0]||(n[0]=y("Built ")),u(O,{date:e.gameConfigFromId?.buildStartedAt},null,8,["date"])])):g("",!0)])}const Xe=_e(qe,[["render",He],["__file","GameConfigSelectOption.vue"]]);var Ce=(r=>(r.Loading="Loading",r.Loaded="Loaded",r.Error="Error",r))(Ce||{}),be=(r=>(r.Added="Added",r.AddedLibrary="Added Library",r.Removed="Removed",r.RemovedLibrary="Removed Library",r.Modified="Modified",r))(be||{}),he=(r=>(r.Unchanged="Unchanged",r.Added="Added",r.Removed="Removed",r))(he||{}),Se=(r=>(r.Diff="Diff",r.Additions="Additions",r.Baseline="Baseline",r.Destination="Destination",r))(Se||{});const Ze=ye({__name:"GameConfigDiffView",setup(r,{expose:n}){n();const A=ce(),e=de(),V=le(),{data:k}=J(we()),{data:O}=J(Q()),m=D(ee(e.query,"baselineRoot")),p=D(ee(e.query,"newRoot"));fe(async()=>{await Promise.all([R(m.value),R(p.value)])}),te(m,async()=>{I.value=P(m.value),I.value||await R(m.value),T()}),te(p,async()=>{o.value=P(p.value),o.value||await R(p.value),T()}),ue(()=>{k.value&&(m.value||(m.value=k.value),p.value||(p.value=k.value))});function T(){const l=(e.path+`?baselineRoot=${m.value}&newRoot=${p.value}`).split("?"),s=l[0],M=Object.fromEntries(l[1].split("&").map(h=>h.split("=")));V.replace({path:s,query:M}).catch(h=>{if(h.name!=="NavigationDuplicated")throw Error(h)})}const{showSuccessNotification:q}=ge();function W(){const t=m.value;m.value=p.value,p.value=t,q("Configs swapped.")}const G={};async function R(t){if(t!==void 0&&L.value!=="Error"&&G[t]===void 0){L.value="Loading",G[t]=null;try{const s=(await A.get(`/gameConfig/${t}`)).data;s.status!=="Success"?(E.value=new ne(`Failed to load diff source: ${t}`,`The status of the game config was ${s.status}, expected status was Success. You can't compare against this game config because it failed to build.`),L.value="Error"):(G[t]=s,L.value!=="Error"&&!Object.values(G).some(M=>M==null)&&(I.value=P(m.value),o.value=P(p.value),L.value="Loaded"))}catch{E.value=new ne("Oh no, something went wrong while trying to compare two game configs:",`Failed to load diff source: ${t}`),L.value="Error"}}}const L=D("Loading"),E=D(),Y=D(),I=D(),o=D();function H(t){return t==="Added"||t==="Added Library"}function _(t){return t==="Removed"||t==="Removed Library"}const X=x(()=>{const t=I.value,l=o.value;if(!t||!l)return[];const s=[],M=Object.keys(l),h=Object.keys(t);return M.forEach(i=>{const b=l[i],v=t[i];if(!v){s.push({anchorName:`${i}-whole-library`,displayName:i,libraryName:i,itemName:"",reason:"Added Library"});return}Object.keys(b).forEach(f=>{Object.prototype.hasOwnProperty.call(v,f)||s.push({anchorName:`${i}-${f}`,displayName:`${i}.${f}`,libraryName:i,itemName:f,reason:"Added"})})}),h.forEach(i=>{const b=t[i],v=l[i];if(!v){s.push({anchorName:`${i}-whole-library`,displayName:i,libraryName:i,itemName:"",reason:"Removed Library"});return}Object.keys(b).forEach(f=>{Object.prototype.hasOwnProperty.call(v,f)||s.push({anchorName:`${i}-${f}`,displayName:`${i}.${f}`,libraryName:i,itemName:f,reason:"Removed"})})}),h.forEach(i=>{const b=t[i],v=l[i];v&&Object.keys(b).forEach(f=>{if(Object.prototype.hasOwnProperty.call(v,f)){const N=JSON.stringify(b[f]),$=JSON.stringify(v[f]);N!==$&&s.push({anchorName:`${i}-${f}`,displayName:`${i}.${f}`,libraryName:i,itemName:f,reason:"Modified"})}})}),s.sort((i,b)=>{const v=i.anchorName.toLowerCase(),f=b.anchorName.toLowerCase();return v<f?-1:v>f?1:0}),s});function P(t){const l=G[t??""];if(l){const s=JSON.parse(JSON.stringify(Object.assign({},l.contents.sharedConfig,l.contents.serverConfig))),M=["archiveVersion","defaultLanguage","defaultParseOptions","metaplay.Core.Config.ISharedGameConfig.ArchiveVersion"],h=Object.keys(s);for(const i of h){if(!M.includes(i)&&s[i]){const b=i.charAt(0).toUpperCase()+i.slice(1),v=Object.getOwnPropertyDescriptor(s,i);v?Object.defineProperty(s,b,v):console.warn(`Failed to fixup config for '${i}'`)}delete s[i]}return s}else return}function Oe(t,l){let s={};Object.prototype.hasOwnProperty.call(I.value?.[t]??{},l)&&(s=I.value?.[t][l]);let M={};Object.prototype.hasOwnProperty.call(o.value?.[t]??{},l)&&(M=o.value?.[t][l]);const h=Z(s),i=Z(M),b=pe(h,i),v=[];return b.forEach(f=>{let N="Unchanged";f.added?N="Added":f.removed&&(N="Removed");const $=f.value.split(/\r?\n/).slice(0,f.count);v.push(...$.map(re=>{const se=re.split(":")[0],Re=se.replace(/"/g,""),Ve=re.replace(se,Re);return{reason:N,text:Ve}}))}),v}function Z(t){return typeof t=="string"?`  "${t}"`:typeof t=="number"?`  ${t}`:Object.keys(t).length===0?" ":JSON.stringify(t,(l,s)=>s,2).slice(2,-2)}const Ie=[{label:"Baseline",value:"Baseline"},{label:"Full Diff",value:"Diff"},{label:"Only Additions",value:"Additions"},{label:"New",value:"Destination"}],j=D("Diff");function Me(t){return j.value==="Diff"||j.value==="Additions"&&!_(t)||j.value==="Baseline"&&!H(t)?!0:j.value==="Destination"&&!_(t)}function De(t){return!(t==="Added Library"||t==="Removed Library")}const F=D([]);function ke(t){const l=F.value.indexOf(t);l===-1?F.value.push(t):F.value.splice(l,1)}function Le(t){return!F.value.includes(t)}const Ae=x(()=>[oe.asDynamicFilterSet(X.value,"library",t=>t.libraryName),new oe("reason",[new K("Modified",t=>t.reason==="Modified"),new K("Added",t=>t.reason==="Added"),new K("Removed",t=>t.reason==="Removed")])]),Ge=[new U("Name","displayName",z.Ascending),new U("Name","displayName",z.Descending),new U("Reason","reason",z.Ascending),new U("Reason","reason",z.Descending)],xe=x(()=>m.value===p.value?"You are comparing a game config version against itself. Unsurprisingly, this means that there are no differences to be found ðŸ¤”":"No differences found between the two game config versions ðŸ¤”"),Be=x(()=>ie.value.map(t=>{const l=O.value?.find(s=>s.id===t);return{id:`${t} - ${l?.name??"No name available"} - ${l?.description??"No description available"}`,value:t}})),ie=x(()=>(O.value??[]).filter(t=>t.bestEffortStatus==="Success"&&(!t.isArchived||t.id===m.value||t.id===p.value)).map(t=>t.id)),ae={gameServerApi:A,route:e,router:V,activeGameConfigIdData:k,allGameConfigsData:O,baselineGameConfigId:m,newGameConfigId:p,updateBrowserAddressBar:T,showSuccessNotification:q,swapGameConfigs:W,sourceGameConfigs:G,LoadingState:Ce,loadGameConfig:R,loadingState:L,loadingError:E,errorExtendedInfo:Y,baselineGameConfig:I,newGameConfig:o,DiffItemReason:be,isAddition:H,isRemoval:_,items:X,fetchLoadedGameConfig:P,DiffTextReason:he,itemDiffText:Oe,makeIntoText:Z,DiffViewType:Se,diffViewTypeOptions:Ie,diffViewType:j,shouldShowDiffItemEntry:Me,shouldShowDiffItemBody:De,openDiffItems:F,toggleItemCollapsed:ke,isItemCollapsed:Le,overviewFilterSets:Ae,overviewSortOptions:Ge,emptyChangeOverviewMessage:xe,gameConfigOptions:Be,gameConfigIds:ie,get diffLines(){return pe},computed:x,onBeforeMount:fe,ref:D,watch:te,watchEffect:ue,get useRoute(){return de},get useRouter(){return le},get useGameServerApi(){return ce},get MetaListFilterOption(){return K},get MetaListFilterSet(){return oe},get MetaListSortDirection(){return z},get MetaListSortOption(){return U},get DisplayError(){return ne},get MBadge(){return Te},get MIconButton(){return Ee},get MInputSingleSelectSwitch(){return ze},get MListItem(){return Pe},get MPageOverviewCard(){return Ne},get MTextButton(){return je},get MViewContainer(){return Ue},get useNotifications(){return ge},get useSubscription(){return J},GameConfigSelectOption:Xe,CoreUiPlacement:Je,get extractSingleValueFromQueryStringOrUndefined(){return ee},get getActiveGameConfigIdSubscriptionOptions(){return we},get getAllGameConfigsSubscriptionOptions(){return Q}};return Object.defineProperty(ae,"__isScriptSetup",{enumerable:!1,value:!0}),ae}}),$e={class:"hacked-height"},et={style:{"line-height":"1.5"}},tt={class:"text-right tw-w-full"},nt={class:"hacked-height"},ot={style:{"line-height":"1.5"}},it={class:"text-right tw-w-full"},at={class:"mr-2"},rt={class:"tw-flex tw-items-center tw-justify-between"},st=["id","onClick"],dt={class:"font-weight-bold mr-2"},lt={key:5,class:"tw-ml-1 tw-text-xs tw-text-blue-400"},ft={key:0,class:"mt-2"},ut={class:"diff text-monospace"},ct={key:0},gt={key:1},mt={class:"added"},vt={key:2},pt={class:"removed"};function wt(r,n,A,e,V,k){const O=C("meta-input-select"),m=C("b-col"),p=C("fa-icon"),T=C("b-row"),q=C("meta-list-card"),W=C("b-card-title"),G=C("b-card-body"),R=C("meta-lazy-loader"),L=C("b-list-group-item"),E=C("b-list-group"),Y=C("b-card"),I=C("meta-raw-data");return d(),w(e.MViewContainer,{permission:"api.game_config.view","is-loading":!e.activeGameConfigIdData||!e.allGameConfigsData,error:e.loadingError,"full-width-overview":""},{overview:a(()=>[u(e.MPageOverviewCard,{title:"Compare Game Config Versions"},{default:a(()=>[n[7]||(n[7]=c("p",null,"Select two game configs to see the differences between them.",-1)),u(T,{"align-v":"center"},{default:a(()=>[u(m,{class:"tw-mb-4"},{default:a(()=>[c("div",$e,[n[4]||(n[4]=c("h6",null,"Baseline game config",-1)),u(O,{value:e.baselineGameConfigId,options:e.gameConfigOptions,"no-clear":"",style:{height:"5rem"},onInput:n[0]||(n[0]=o=>e.baselineGameConfigId=o)},{option:a(({option:o})=>[o?(d(),w(e.GameConfigSelectOption,{key:0,gameConfigId:o},null,8,["gameConfigId"])):g("",!0)]),selectedOption:a(({option:o})=>[c("div",et,[o?(d(),w(e.GameConfigSelectOption,{key:0,gameConfigId:o},null,8,["gameConfigId"])):g("",!0)])]),_:1},8,["value","options"]),c("div",tt,[c("small",null,[u(e.MTextButton,{to:`/gameConfigs/${e.baselineGameConfigId}`},{default:a(()=>n[3]||(n[3]=[y("View baseline game config")]),void 0,!0),_:1},8,["to"])])])])],void 0,!0),_:1}),u(m,{class:"tw-mb-4 tw-text-center",md:"1"},{default:a(()=>[u(e.MIconButton,{"aria-label":"Swap the baseline and new game configs.",onClick:e.swapGameConfigs},{default:a(()=>[u(p,{icon:"right-left"})],void 0,!0),_:1})],void 0,!0),_:1}),u(m,{class:"tw-mb-4"},{default:a(()=>[c("div",nt,[n[6]||(n[6]=c("h6",null,"New game config",-1)),u(O,{value:e.newGameConfigId,options:e.gameConfigOptions,"no-clear":"",style:{height:"5rem"},onInput:n[1]||(n[1]=o=>e.newGameConfigId=o)},{option:a(({option:o})=>[o?(d(),w(e.GameConfigSelectOption,{key:0,gameConfigId:o},null,8,["gameConfigId"])):g("",!0)]),selectedOption:a(({option:o})=>[c("div",ot,[o?(d(),w(e.GameConfigSelectOption,{key:0,gameConfigId:o},null,8,["gameConfigId"])):g("",!0)])]),_:1},8,["value","options"]),c("div",it,[c("small",null,[u(e.MTextButton,{to:`/gameConfigs/${e.newGameConfigId}`},{default:a(()=>n[5]||(n[5]=[y("View new game config")]),void 0,!0),_:1},8,["to"])])])])],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1})]),default:a(()=>[u(e.CoreUiPlacement,{placementId:"GameConfig/Diff"}),u(T,{"align-h":"center"},{default:a(()=>[u(m,{md:"7"},{default:a(()=>[u(q,{class:"tw-mb-4",title:"Overview of changes",itemList:e.loadingState===e.LoadingState.Loading?void 0:e.items,searchFields:["displayName"],filterSets:e.overviewFilterSets,sortOptions:e.overviewSortOptions,emptyMessage:e.emptyChangeOverviewMessage,"page-size":15},{"item-card":a(o=>[u(e.MListItem,null,{default:a(()=>[e.isAddition(o.item.reason)?(d(),w(e.MBadge,{key:0,class:"mr-2",variant:"success",tooltip:"Added"},{default:a(()=>n[8]||(n[8]=[y("A")]),void 0,!0),_:1})):g("",!0),e.isRemoval(o.item.reason)?(d(),w(e.MBadge,{key:1,class:"mr-2",variant:"danger",tooltip:"Removed"},{default:a(()=>n[9]||(n[9]=[y("R")]),void 0,!0),_:1})):g("",!0),o.item.reason===e.DiffItemReason.Modified?(d(),w(e.MBadge,{key:2,class:"mr-2",variant:"primary",tooltip:"Modified"},{default:a(()=>n[10]||(n[10]=[y("M")]),void 0,!0),_:1})):g("",!0),c("span",at,B(o.item.displayName),1)],void 0,!0),_:2},1024)]),_:1},8,["itemList","filterSets","emptyMessage"])],void 0,!0),_:1})],void 0,!0),_:1}),e.items.length>0?(d(),w(Y,{key:0,class:"shadow-sm mb-3","no-body":""},{default:a(()=>[u(G,null,{default:a(()=>[c("div",rt,[u(W,{class:"tw-pt-3"},{default:a(()=>n[11]||(n[11]=[y("Detailed Changes")]),void 0,!0),_:1}),u(e.MInputSingleSelectSwitch,{"model-value":e.diffViewType,options:e.diffViewTypeOptions,"onUpdate:modelValue":n[2]||(n[2]=o=>e.diffViewType=o)},null,8,["model-value"])])],void 0,!0),_:1}),u(E,{class:"list-group-stripes",flush:""},{default:a(()=>[(d(!0),S(ve,null,me(e.items,(o,H)=>(d(),S("div",{key:o.anchorName},[e.shouldShowDiffItemEntry(o.reason)?(d(),w(L,{key:0},{default:a(()=>[u(R,null,{default:a(()=>[c("div",{id:o.anchorName,style:{cursor:"pointer"},onClick:_=>e.toggleItemCollapsed(o.anchorName)},[c("span",{class:Fe({"not-collapsed":!e.isItemCollapsed(o.anchorName)})},[e.shouldShowDiffItemBody(o.reason)?(d(),w(p,{key:0,class:"mr-2",icon:"angle-right"})):g("",!0)],2),c("span",dt,B(o.displayName),1),o.reason===e.DiffItemReason.Added?(d(),w(e.MBadge,{key:0,variant:"success"},{default:a(()=>n[12]||(n[12]=[y("Added")]),void 0,!0),_:1})):g("",!0),o.reason===e.DiffItemReason.AddedLibrary?(d(),w(e.MBadge,{key:1,variant:"success",tooltip:"Whole library missing or failing to import in base game config"},{default:a(()=>n[13]||(n[13]=[y("Added Library")]),void 0,!0),_:1})):g("",!0),o.reason===e.DiffItemReason.Removed?(d(),w(e.MBadge,{key:2,variant:"danger"},{default:a(()=>n[14]||(n[14]=[y("Removed")]),void 0,!0),_:1})):g("",!0),o.reason===e.DiffItemReason.RemovedLibrary?(d(),w(e.MBadge,{key:3,variant:"danger",tooltip:"Whole library missing or failing to import in new game config"},{default:a(()=>n[15]||(n[15]=[y("Removed Library")]),void 0,!0),_:1})):g("",!0),o.reason===e.DiffItemReason.Modified?(d(),w(e.MBadge,{key:4,variant:"primary"},{default:a(()=>n[16]||(n[16]=[y("Modified")]),void 0,!0),_:1})):g("",!0),e.shouldShowDiffItemBody(o.reason)?(d(),S("span",lt,B(e.isItemCollapsed(o.anchorName)?"Show":"Hide"),1)):g("",!0)],8,st),!e.isItemCollapsed(o.anchorName)&&e.shouldShowDiffItemBody(o.reason)?(d(),S("div",ft,[(d(!0),S(ve,null,me(e.itemDiffText(o.libraryName,o.itemName),(_,X)=>(d(),S("div",ut,[[e.DiffViewType.Diff,e.DiffViewType.Baseline,e.DiffViewType.Destination].includes(e.diffViewType)&&_.reason==e.DiffTextReason.Unchanged?(d(),S("div",ct,B(_.text),1)):[e.DiffViewType.Diff,e.DiffViewType.Additions,e.DiffViewType.Destination].includes(e.diffViewType)&&_.reason==e.DiffTextReason.Added?(d(),S("div",gt,[n[17]||(n[17]=c("span",{class:"text-success"},"+",-1)),n[18]||(n[18]=y()),c("span",mt,B(_.text.slice(2,_.text.length)),1)])):[e.DiffViewType.Diff,e.DiffViewType.Baseline].includes(e.diffViewType)&&_.reason==e.DiffTextReason.Removed?(d(),S("div",vt,[n[19]||(n[19]=c("span",{class:"text-danger"},"-",-1)),n[20]||(n[20]=y()),c("span",pt,B(_.text.slice(2,_.text.length)),1)])):g("",!0)]))),256))])):g("",!0)],void 0,!0),_:2},1024)],void 0,!0),_:2},1024)):g("",!0)]))),128))],void 0,!0),_:1})],void 0,!0),_:1})):g("",!0),u(I,{kvPair:e.baselineGameConfig,name:"baselineGameConfig"},null,8,["kvPair"]),u(I,{kvPair:e.newGameConfig,name:"newGameConfig"},null,8,["kvPair"])],void 0,!0),_:1},8,["is-loading","error"])}const At=_e(Ze,[["render",wt],["__file","GameConfigDiffView.vue"]]);export{At as default};
