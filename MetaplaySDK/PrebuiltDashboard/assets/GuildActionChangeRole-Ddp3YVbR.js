import{d as K,x as T,c as h,f as c,dT as L,C as k,ad as V,M as Q,s as U,v as W,a8 as X,ae as O,b,o as m,e as _,w as o,n as f,k as d,p as v,t as g,$ as j,a as P,F as Z,r as $,_ as ee}from"./index-B7jvAjdE.js";import{M as te}from"./MActionModalButton-CvWVuTB-.js";import{g as E}from"./guilds-LGK3Q8Wf.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";const ae=K({__name:"GuildActionChangeRole",props:{guildId:{}},setup(G,{expose:a}){a();const R=G,e=V(),{data:r,refresh:M}=T(E(R.guildId)),y=h(()=>Object.keys(r.value.model.members).length!==0),u=c([]),l=c(),C=h(()=>["Leader","MiddleTier","LowTier"].map(n=>({id:n,value:{id:n,displayName:L(n)},disabled:l.value?.roleId===n}))),i=c(),t=c(),s=c(),S=c(!1),F=h(()=>u.value.length===1?"This guild has only one member. You cannot change their role.":l.value?i.value?t.value?void 0:"Change is not valid.":"Select a role to proceed.":"Select a player to proceed.");function z(){l.value=void 0,i.value=void 0,t.value=void 0,s.value=void 0;const n=[];for(const p in r.value.model.members){const w=r.value.model.members[p];n.push({id:p,value:{playerId:p,displayName:w.displayName,roleId:L(w.role)}})}u.value=n,u.value.length===1&&(l.value=u.value[0].value)}k(l,I),k(i,I);async function I(){if(s.value=void 0,t.value=void 0,l.value&&i.value){S.value=!0;const n=await e.post(`/guilds/${r.value.id}/validateEditRole`,{playerId:l.value.playerId,role:i.value.id}),p=n.data.changes;s.value=[],Object.entries(p).forEach(w=>{const[N,J]=w;s.value.push({playerId:N,newRole:J,displayName:r.value.model.members[N].displayName||"n/a",oldRole:r.value.model.members[N].role});const x=s.value.findIndex(B=>B.playerId===l.value?.playerId);if(x>0){const B=s.value[x];s.value.splice(x,1),s.value.unshift(B)}}),Object.keys(p).length>0&&(t.value=n.data),S.value=!1}else l.value||(i.value=void 0)}const{showSuccessNotification:D}=O();async function Y(){await e.post(`/guilds/${r.value.id}/editRole`,{playerId:l.value?.playerId,role:i.value?.id,expectedChanges:t.value?.changes}),D(`${l.value?.displayName} is now a ${i.value?.displayName}.`),M()}function q(n){return n==="Leader"?"primary":"neutral"}const H=h(()=>r.value.model.lifecyclePhase==="Closed"?"Guild is closed.":y.value?void 0:"Guild has no members."),A={props:R,gameServerApi:e,guildData:r,guildRefresh:M,hasMembers:y,playerList:u,chosenPlayer:l,roleList:C,chosenRole:i,roleChanges:t,roleChangePreview:s,roleChangePreviewLoading:S,okButtonDisabledReason:F,resetModal:z,validateEdit:I,showSuccessNotification:D,changeRole:Y,getRoleVariant:q,triggerButtonDisabledReason:H,computed:h,ref:c,watch:k,get useGameServerApi(){return V},get MActionModalButton(){return te},get MBadge(){return Q},get MList(){return U},get MListItem(){return W},get MTextButton(){return X},get useNotifications(){return O},get useSubscription(){return T},get guildRoleDisplayString(){return L},get getSingleGuildSubscriptionOptions(){return E}};return Object.defineProperty(A,"__isScriptSetup",{enumerable:!1,value:!0}),A}}),le={class:"tw-text-xs+"},oe={key:0},ne={key:1,class:"text-muted mb-3 small tw-pt-4 tw-text-center tw-italic"};function ie(G,a,R,e,r,M){const y=b("meta-input-select"),u=b("b-spinner"),l=b("b-row"),C=b("meta-alert"),i=b("fa-icon");return m(),_(e.MActionModalButton,{"modal-title":"Change a Guild Member's Role",action:e.changeRole,"trigger-button-label":"Change a Role","trigger-button-disabled-tooltip":e.triggerButtonDisabledReason,"ok-button-label":"Change Role","ok-button-disabled-tooltip":e.okButtonDisabledReason,permission:"api.guilds.edit_roles",onShow:e.resetModal,"data-testid":"action-change-role"},{default:o(()=>[a[5]||(a[5]=f("div",{class:"tw-mb-1 tw-font-semibold"},"1. Select a Guild Member",-1)),d(y,{value:e.chosenPlayer,options:e.playerList,placeholder:"Select a player...",searchFields:["displayName","playerId","roleId"],onInput:a[0]||(a[0]=t=>e.chosenPlayer=t)},{option:o(({option:t})=>[d(e.MListItem,{class:"!tw-px-0 !tw-py-0"},{"top-right":o(()=>[v(g(t?.playerId),1)]),default:o(()=>[f("span",le,g(t?.displayName)+" - "+g(t?.roleId),1)],void 0,!0),_:2},1024)]),_:1},8,["value","options"]),f("div",{class:j(["tw-font-semibold tw-my-3",{"tw-text-neutral-400":!e.chosenPlayer}])},"2. Select a New Role",2),d(y,{value:e.chosenRole,options:e.roleList,placeholder:e.chosenPlayer?"Select a role...":"Select a guild member first",searchFields:["displayName","id"],disabled:!e.chosenPlayer,onInput:a[1]||(a[1]=t=>e.chosenRole=t)},{option:o(({option:t})=>[f("div",null,g(t?.displayName),1)]),_:1},8,["value","options","placeholder","disabled"]),f("div",{class:j(["tw-mb-1",["tw-my-3 tw-font-semibold",{"tw-text-neutral-400":!e.chosenPlayer||!e.chosenRole}]])},"3. Preview Role Changes",2),e.roleChangePreviewLoading?(m(),P("div",oe,[d(l,{class:"justify-content-center mt-5"},{default:o(()=>[d(u,{class:"mt-4",label:"Loading..."})],void 0,!0),_:1})])):e.roleChangePreview?e.roleChangePreview.length==0?(m(),_(C,{key:2,variant:"warning",title:"No Changes to Roles",message:"This change is no-op, invalid, or the resulting guild state would break the role invariants. Contact Metaplay if you think this is a bug!"})):(m(),_(e.MList,{key:3,showBorder:""},{default:o(()=>[(m(!0),P(Z,null,$(e.roleChangePreview,t=>(m(),_(e.MListItem,{class:"tw-px-5",key:t.displayName},{"top-right":o(()=>[d(e.MTextButton,{to:`/players/${t.playerId}`},{default:o(()=>a[2]||(a[2]=[v("View player")]),void 0,!0),_:2},1032,["to"])]),"bottom-left":o(()=>[a[3]||(a[3]=v("Role will be changed from ")),d(e.MBadge,{variant:e.getRoleVariant(t.oldRole)},{default:o(()=>[v(g(e.guildRoleDisplayString(t.oldRole)),1)],void 0,!0),_:2},1032,["variant"]),a[4]||(a[4]=v(" to ")),d(e.MBadge,{variant:e.getRoleVariant(t.newRole)},{default:o(()=>[v(g(e.guildRoleDisplayString(t.newRole)),1)],void 0,!0),_:2},1032,["variant"])]),default:o(()=>[f("span",null,[d(i,{icon:"user"}),v(" "+g(t.displayName||"n/a"),1)])],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})):(m(),P("div",ne,"Choose a player and a role to preview the results."))],void 0,!0),_:1},8,["trigger-button-disabled-tooltip","ok-button-disabled-tooltip"])}const me=ee(ae,[["render",ie],["__file","GuildActionChangeRole.vue"]]);export{me as default};
