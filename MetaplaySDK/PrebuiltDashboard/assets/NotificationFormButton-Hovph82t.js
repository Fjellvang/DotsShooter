import{bj as P,bk as D,bl as R,bm as z,d as q,aa as S,f as F,N as m,c as f,ad as x,ae as k,b as K,o as L,e as B,B as Z,w as g,n as l,k as r,l as H,_ as J}from"./index-B7jvAjdE.js";import{M as Q}from"./MActionModalButton-CvWVuTB-.js";import{M as W}from"./MInputDateTime-DL6Zd7-d.js";import{M as X}from"./MInputNumber-BOzPEn49.js";import{M as Y}from"./MInputSwitch-C-Z-JJsG.js";import{M as $}from"./MInputText-CzhsT8yb.js";import{M as ee}from"./MetaGeneratedForm-BcVgOIy3.js";import{M as U}from"./MessageAudienceForm-Bn0DOLdW.js";function pe(){return{permission:"api.notifications.view",pollingPolicy:P(5e3),fetcherPolicy:D("/notifications"),cacheRetentionPolicy:R()}}function be(u){return{permission:"api.notifications.view",pollingPolicy:P(5e3),fetcherPolicy:D(`/notifications/${u}`),cacheRetentionPolicy:z(1e4)}}const p=50,te=q({__name:"NotificationFormButton",props:{modalTitle:{},buttonText:{},oldNotification:{},update:{type:Boolean},buttonIcon:{}},emits:["refresh"],setup(u,{expose:i,emit:s}){i();const e=u,c=x(),I=S(),t=F(n());function n(){return{name:"",targetTime:m.now(),content:{title:void 0,body:void 0},debugEntityIdValueUpperBound:100,debugFakeNotificationMode:!1,firebaseAnalyticsLabel:"",audience:U.props.modelValue.default()}}function _(a){t.value.name=a,h()}const b=f(()=>!(!t.value.name||t.value.name.length===0));function h(){t.value.firebaseAnalyticsLabel=C(t.value.name)}const M=["-","_",".","~","%"];function C(a){let o="";for(let y=0;y<a.length;y++){const N=a.charAt(y);v(N)?o+=N:N===" "?o+="_":o+="%"}return o.length>p&&(o=o.substring(0,p)),o}function v(a){return a>="a"&&a<="z"||a>="A"&&a<="Z"||a>="0"&&a<="9"||M.includes(a)}const A=f(()=>{const a=t.value.firebaseAnalyticsLabel;if(a.length>p)return!1;for(let o=0;o<a.length;o++)if(!v(a.charAt(o)))return!1;return a?!0:null}),d=F(!1),E=f(()=>{if(!b.value&&!d.value)return"Fill in the required fields to proceed.";if(!b.value)return"Fill in a valid name to proceed.";if(!d.value)return"Fill in the notification message in all selected locales to proceed.";if(!t.value.audience.valid)return"The audience targeting is invalid. Check that it is filled out correctly to proceed.";if(!A.value)return"The Firebase analytics label is invalid. Check that it is set correctly to proceed."});function O(a){a&&(t.value.targetTime=a)}const T=s,{showSuccessNotification:w}=k();async function G(){const a={name:t.value.name,targetTime:t.value.targetTime.toISO(),content:t.value.content,firebaseAnalyticsLabel:t.value.firebaseAnalyticsLabel,targetPlayers:t.value.audience.targetPlayers,targetCondition:t.value.audience.targetCondition};if(t.value.debugFakeNotificationMode&&(a.debugFakeNotificationMode=!0,a.debugEntityIdValueUpperBound=t.value.debugEntityIdValueUpperBound),e.update){if(a.id=e.oldNotification?.id,!a.id)throw new Error("Cannot update campaign without ID.");await c.put(`/notifications/${a.id}`,a),w("Campaign updated.")}else await c.post("/notifications",a),w("New push notification campaign created.");T("refresh")}function j(){e.oldNotification?(t.value.name=e.update?e.oldNotification.name:e.oldNotification.name+" (copy)",t.value.targetTime=e.update?m.fromISO(e.oldNotification.targetTime):m.now(),t.value.content=e.oldNotification.content,t.value.debugFakeNotificationMode=e.oldNotification.debugFakeNotificationMode??!1,t.value.debugEntityIdValueUpperBound=e.oldNotification.debugEntityIdValueUpperBound??100,t.value.firebaseAnalyticsLabel=e.oldNotification.firebaseAnalyticsLabel,t.value.audience.targetPlayers=e.oldNotification.targetPlayers,t.value.audience.targetCondition=e.oldNotification.targetCondition,d.value=!0):t.value=n()}const V={props:e,gameServerApi:c,uiStore:I,campaignFormInfo:t,getNewCampaignFormInfo:n,onCampaignNameChange:_,isNameValid:b,autofillFirebaseAnalyticsLabelFromName:h,firebaseAnalyticsLabelSpecialCharacters:M,firebaseAnalyticsLabelMaxLength:p,convertToValidFirebaseAnalyticsLabel:C,isValidFirebaseAnalyticsCharacter:v,isFirebaseAnalyticsLabelValid:A,isContentValid:d,isFormValid:E,onTargetDateTimeChange:O,emits:T,showSuccessNotification:w,createOrUpdateCampaign:G,resetNewCampaign:j,get DateTime(){return m},computed:f,ref:F,get useGameServerApi(){return x},get useUiStore(){return S},get MActionModalButton(){return Q},get MInputDateTime(){return W},get MInputNumber(){return X},get MInputSwitch(){return Y},get MInputText(){return $},get useNotifications(){return k},MetaGeneratedForm:ee,MessageAudienceForm:U};return Object.defineProperty(V,"__isScriptSetup",{enumerable:!1,value:!0}),V}}),ae={class:"tw-inline-flex tw-w-full tw-gap-x-4"},ie={class:"tw-@container"},ne={class:"tw-mt-4 tw-bg-neutral-100 tw-p-3 tw-border tw-rounded tw-border-neutral-200"},oe={class:"tw-flex tw-justify-between tw-mt-2"};function le(u,i,s,e,c,I){const t=K("fa-icon");return L(),B(e.MActionModalButton,{"modal-title":s.modalTitle,action:e.createOrUpdateCampaign,"trigger-button-label":s.buttonText,"ok-button-label":"Start Campaign","ok-button-disabled-tooltip":e.isFormValid,permission:"api.notifications.edit",onShow:e.resetNewCampaign},Z({"trigger-button-icon":g(()=>[s.buttonIcon?(L(),B(t,{key:0,class:"tw-h-3.5 tw-w-4 tw-mb-[0.05rem] tw-space-x-2",icon:s.buttonIcon},null,8,["icon"])):H("",!0)]),"right-panel":g(()=>[l("div",ie,[r(e.MetaGeneratedForm,{class:"tw-mt-3",typeName:"Metaplay.Server.NotificationCampaign.NotificationContent",value:e.campaignFormInfo.content,page:"NotificationFormButton",onInput:i[2]||(i[2]=n=>e.campaignFormInfo.content=n),onStatus:i[3]||(i[3]=n=>e.isContentValid=n),"is-targeting-multiple-players":""},null,8,["value"])])]),default:g(()=>[l("div",ae,[r(e.MInputText,{class:"tw-grow",label:"Campaign Name","model-value":e.campaignFormInfo.name,variant:e.isNameValid?"success":"danger",placeholder:"Campaign name here...","onUpdate:modelValue":e.onCampaignNameChange},null,8,["model-value","variant"]),r(e.MInputDateTime,{class:"tw-grow","model-value":e.campaignFormInfo.targetTime,"min-date-time":"utcNow",label:"Date","onUpdate:modelValue":e.onTargetDateTimeChange},null,8,["model-value"])]),r(e.MInputText,{class:"tw-mt-3",label:"Firebase Analytics Label","model-value":e.campaignFormInfo.firebaseAnalyticsLabel,variant:e.isFirebaseAnalyticsLabelValid!==null?e.isFirebaseAnalyticsLabelValid?"success":"danger":"default",placeholder:"Optional analytics label...","hint-message":`At most ${e.firebaseAnalyticsLabelMaxLength} characters; ASCII alphanumerics and ${e.firebaseAnalyticsLabelSpecialCharacters.join(" ")}`,"onUpdate:modelValue":i[0]||(i[0]=n=>e.campaignFormInfo.firebaseAnalyticsLabel=n)},null,8,["model-value","variant","hint-message"]),r(e.MessageAudienceForm,{class:"tw-mt-3","model-value":e.campaignFormInfo.audience,"onUpdate:modelValue":i[1]||(i[1]=n=>e.campaignFormInfo.audience=n)},null,8,["model-value"])],void 0,!0),_:2},[e.uiStore.showDeveloperUi?{name:"bottom-panel",fn:g(()=>[l("div",ne,[i[7]||(i[7]=l("span",{class:"tw-font-semibold tw-mr-1"},"Debug Options",-1)),i[8]||(i[8]=l("span",{class:"tw-text-xs+ tw-normal-case tw-space-x-1 tw-text-neutral-500"},[l("span",null,"Visible in developer mode."),l("span",{class:"tw-text-red-500"},"Do not use these in production!")],-1)),l("div",oe,[i[6]||(i[6]=l("span",{class:"tw-font-semibold"},"Fake notification mode",-1)),r(e.MInputSwitch,{class:"tw-relative tw-top-1","model-value":e.campaignFormInfo.debugFakeNotificationMode,name:"fakeNotificationModeEnabled",size:"small","onUpdate:modelValue":i[4]||(i[4]=n=>e.campaignFormInfo.debugFakeNotificationMode=n)},null,8,["model-value"])]),r(e.MInputNumber,{label:"Debug Entity ID Bound","model-value":e.campaignFormInfo.debugEntityIdValueUpperBound,disabled:!e.campaignFormInfo.debugFakeNotificationMode,min:1,"hint-message":"Set this to the number of bots you are running for best results.","onUpdate:modelValue":i[5]||(i[5]=n=>e.campaignFormInfo.debugEntityIdValueUpperBound=n)},null,8,["model-value","disabled"])])]),key:"0"}:void 0]),1032,["modal-title","trigger-button-label","ok-button-disabled-tooltip"])}const ve=J(te,[["render",le],["__file","NotificationFormButton.vue"]]);export{ve as N,be as a,pe as g};
