import{d as L,f as s,N as C,c as D,ck as h,ad as S,M as A,a0 as E,ac as O,ai as j,s as G,v as z,ae as T,b as P,o as n,e as p,w as r,n as l,k as i,a as c,F as Y,r as q,t as I,p as v,$ as H,l as B,_ as J}from"./index-B7jvAjdE.js";import{M as K}from"./MActionModalButton-CvWVuTB-.js";import{M as Q}from"./MInputCheckbox-BqateWtE.js";import{M as W}from"./MInputDateTime-DL6Zd7-d.js";import{M as X}from"./MInputSwitch-C-Z-JJsG.js";import{M as Z}from"./MInputSingleFile-Dbi3mt5D.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";import"./index-B_QkKjtG.js";import"./MInputHintMessage-DbuBS4Kn.js";import"./index-DZuvHjnn.js";const $=L({__name:"RedeletePlayersCard",setup(R,{expose:t}){t();const y=S(),e=s(null),d=s(C.now()),M=s(null),u=s(),m=s(!1),a=s(),b=D(()=>e.value!==null&&m.value),g=D(()=>{const o=h.fromDurationLike({days:60});return C.now().minus(o)});function F(){e.value=null,M.value=null,m.value=!1,d.value=g.value,a.value=void 0,u.value=void 0}const{showSuccessNotification:x}=T();function N(o){a.value=o,k()}async function U(){if(!a.value)return;const o=new FormData;o.append("file",a.value),o.append("cutoffTime",d.value.toISO()),e.value.filter(f=>f.redelete).forEach(f=>{o.append("playerIds",f.playerId)}),await y.post("redeletePlayers/execute",o,{headers:{"Content-Type":"multipart/form-data"}}),x("Player re-deletion started.")}async function V(o){o&&(d.value=o,a.value!==null&&await k())}async function k(){if(e.value=null,m.value=!1,u.value=void 0,!a.value)return;const o=new FormData;o.append("file",a.value),o.append("cutoffTime",d.value.toISO());try{const w=(await y.post("redeletePlayers/list",o,{headers:{"Content-Type":"multipart/form-data"}})).data;e.value=w.playerInfos.map(f=>({...f,redelete:!0}))}catch(w){u.value=w.response.data.error}}const _={gameServerApi:y,players:e,cutoffTime:d,result:M,error:u,confirmRedeletion:m,file:a,isFormValid:b,defaultCutoffTime:g,resetModal:F,showSuccessNotification:x,onFileUpdated:N,redeletePlayers:U,onDateUpdated:V,fetchRedeletionList:k,get DateTime(){return C},get Duration(){return h},computed:D,ref:s,get useGameServerApi(){return S},get MActionModalButton(){return K},get MBadge(){return A},get MCallout(){return E},get MCard(){return O},get MErrorCallout(){return j},get MInputCheckbox(){return Q},get MInputDateTime(){return W},get MInputSingleFile(){return Z},get MInputSwitch(){return X},get MList(){return G},get MListItem(){return z},get useNotifications(){return T}};return Object.defineProperty(_,"__isScriptSetup",{enumerable:!1,value:!0}),_}}),ee={class:"tw-flex tw-justify-end"},te={class:"tw-space-y-2"},ae={key:0},le={class:"tw-text-xs+ tw-text-neutral-500 tw-break-words"},oe={class:"tw-mt-2"},re={key:1},ne={key:2},ie={class:"tw-flex tw-justify-between"};function se(R,t,y,e,d,M){const u=P("meta-time"),m=P("meta-no-seatbelts");return n(),p(e.MCard,{title:"Re-Delete Players"},{subtitle:r(()=>t[2]||(t[2]=[l("p",null,"Batch re-delete players that have been marked for deletion, but the deletion was un-done during a backup restore.",-1)])),default:r(()=>[l("div",ee,[i(e.MActionModalButton,{"modal-title":"Re-Delete Players",action:e.redeletePlayers,"trigger-button-label":"Open Re-Delete Menu","ok-button-label":"Re-Delete Players","ok-button-disabled-tooltip":e.isFormValid?void 0:"Upload a valid log file to proceed.",permission:"api.system.player_redelete",onShow:t[1]||(t[1]=a=>e.resetModal())},{default:r(()=>[t[3]||(t[3]=l("p",null,"You can use this tool to upload player deletion logs and recover the deletion status of players in case something may have been lost during backup recovery.",-1)),t[4]||(t[4]=l("p",{class:"tw-text-sm tw-mt-2 tw-text-neutral-500 tw-mb-2"},"This feature is a practical way to respect GDPR and the right for your players to be forgotten even during backup recovery scenarios!",-1)),l("div",te,[i(e.MInputSingleFile,{label:"Log File","model-value":e.file,variant:e.file?e.error?"danger":"success":"default","onUpdate:modelValue":e.onFileUpdated},null,8,["model-value","variant"]),i(e.MInputDateTime,{label:"Re-Delete Cutoff Time (UTC)","model-value":e.cutoffTime,"max-date-time":"utcNow","onUpdate:modelValue":e.onDateUpdated},null,8,["model-value"])])]),"right-panel":r(()=>[t[13]||(t[13]=l("h6",{class:"tw-mb-2"},"Select Players",-1)),e.players&&e.players.length>0?(n(),c("div",ae,[i(e.MList,{showBorder:!0},{default:r(()=>[(n(!0),c(Y,null,q(e.players,(a,b)=>(n(),p(e.MListItem,{class:"tw-px-3",key:b},{"top-right":r(()=>[l("span",null,I(a.playerId),1)]),"bottom-left":r(()=>[l("div",le,[t[5]||(t[5]=v("Deleted ")),i(u,{date:a.scheduledDeletionTime},null,8,["date"]),v(" by "+I(a.deletionSource),1)]),l("span",null,[t[6]||(t[6]=l("span",null,"Marked for re-deletion:",-1)),i(e.MInputCheckbox,{"model-value":a.redelete,name:"isPlayerMarkedForRedeletion","onUpdate:modelValue":g=>a.redelete=g},null,8,["model-value","onUpdate:modelValue"])]),l("div",oe,[a.redelete?(n(),p(e.MBadge,{key:0,variant:"danger"},{default:r(()=>t[7]||(t[7]=[v("To Be Deleted")]),void 0,!0),_:1})):(n(),p(e.MBadge,{key:1},{default:r(()=>t[8]||(t[8]=[v("Skip")]),void 0,!0),_:1}))])]),default:r(()=>[l("span",null,I(a.playerName||"n/a"),1)],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})])):e.players&&e.players.length==0?(n(),c("div",re,[i(e.MCallout,{variant:"danger",title:"No Players Found"},{default:r(()=>t[9]||(t[9]=[v("Based on the selected log file and cutoff time, there are no players who are eligible for re-deletion.")]),void 0,!0),_:1})])):(n(),c("div",ne,t[10]||(t[10]=[l("p",{class:"tw-text-neutral-500 tw-italic"},"Choose a valid log file to preview players for re-deletion.",-1)]))),e.players?(n(),c("div",{key:3,class:H(["tw-mt-2",[{"tw-text-neutral-500":e.players},"tw-mb-3"]])},[t[12]||(t[12]=l("h6",{class:"tw-mb-1"},"Confirm",-1)),l("div",ie,[t[11]||(t[11]=l("span",null,"I know what I am doing",-1)),i(e.MInputSwitch,{class:"true","model-value":e.confirmRedeletion,disabled:!e.players||e.players.length==0,name:"confirmRedeletion",size:"small","onUpdate:modelValue":t[0]||(t[0]=a=>e.confirmRedeletion=a)},null,8,["model-value","disabled"])])],2)):B("",!0),e.error?(n(),p(e.MErrorCallout,{key:4,error:e.error},null,8,["error"])):B("",!0)]),"bottom-panel":r(()=>[i(m,{class:"tw-w-7/12 tw-mx-auto"})]),_:1},8,["ok-button-disabled-tooltip"])])],void 0,!0),_:1})}const be=J($,[["render",se],["__file","RedeletePlayersCard.vue"]]);export{be as default};
