import{d as se,f as D,h as Y,c as Z,ad as $,M as le,a8 as de,b as v,o as p,e as N,w as a,k as i,n as d,p as b,t as m,a as O,r as oe,$ as B,bd as ee,l as te,F as fe,_ as re}from"./index-B7jvAjdE.js";import{M as ue,a as ve}from"./MViewContainer-BTeE2xDT.js";const me=se({__name:"DatabaseEntityDetailView",props:{id:{}},setup(G,{expose:s}){s();const k=G,l=$(),h=D("none"),S=D(),T=D();Y(async()=>{try{const o=await l.get(`/entities/${k.id}/dbinfo`);S.value=o.data,r.value=new Set,w().forEach(t=>{t.sizePercent>=10&&r.value.add(t.id)})}catch(o){T.value=o}});const f=Z(()=>w(r.value));function w(o){if(!S.value?.structure)return[];const t=S.value.structure.EnvelopeEndOffset-S.value.structure.EnvelopeStartOffset;function _(y,e,g,c,x,ne){const R=e.EnvelopeEndOffset-e.EnvelopeStartOffset,F=e.PayloadEndOffset-e.PayloadStartOffset,j=e.EnvelopeStartOffset!==e.PayloadStartOffset,H=e.EnvelopeEndOffset!==e.PayloadEndOffset,L=e.PrimitiveValue!==void 0,U=e.Members!==void 0,q=e.Elements!==void 0,J=e.Dictionary!==void 0,Q=o?o.has(g):!0,u=[];if(u.push({size:R,fn:()=>y.push({id:g,depth:c,name:ne||e.FieldName||e.TagId&&`[member ${e.TagId}]`||e.TypeName||"[unknown]",size:R,sizePercent:R*100/t,type:e.TypeName,wireType:e.WireType,value:e.PrimitiveValue,tagId:e.TagId,hasChildren:j||H||L||U||q||J,isExpanded:Q})}),Q){if(j&&u.push({size:e.PayloadStartOffset-e.EnvelopeStartOffset,fn:()=>y.push({id:g+".i",depth:c+1,name:"[header]",size:e.PayloadStartOffset-e.EnvelopeStartOffset,sizePercent:(e.PayloadStartOffset-e.EnvelopeStartOffset)*100/t,type:void 0,wireType:void 0,value:void 0,tagId:void 0,hasChildren:!1,isExpanded:!1})}),L&&u.push({size:F,fn:()=>y.push({id:g+".p",depth:c+1,name:"[payload]",size:F,sizePercent:F*100/t,type:void 0,wireType:void 0,value:void 0,tagId:void 0,hasChildren:!1,isExpanded:!1})}),U)for(let n=0;n<e.Members.length;++n)u.push({size:e.Members[n].EnvelopeEndOffset-e.Members[n].EnvelopeStartOffset,fn:()=>{_(y,e.Members[n],`${g}.m${n}`,c+1,x)}});if(q)for(let n=0;n<e.Elements.length;++n)u.push({size:e.Elements[n].EnvelopeEndOffset-e.Elements[n].EnvelopeStartOffset,fn:()=>{_(y,e.Elements[n],`${g}.e${n}`,c+1,x)}});if(J)for(let n=0;n<e.Dictionary.length;++n){const C=e.Dictionary[n].Key.EnvelopeEndOffset-e.Dictionary[n].Key.EnvelopeStartOffset,ie=e.Dictionary[n].Value.EnvelopeEndOffset-e.Dictionary[n].Value.EnvelopeStartOffset,K=C+ie,I=`${g}.e${n}`,X=o?o.has(I):!0;u.push({size:K,fn:()=>{y.push({id:I,depth:c+1,name:`[entry ${n}]`,size:K,sizePercent:K*100/t,type:void 0,wireType:void 0,value:void 0,tagId:void 0,hasChildren:!0,isExpanded:X}),X&&(_(y,e.Dictionary[n].Key,`${I}.k`,c+2,x,e.Dictionary[n].Key.TypeName?`[key: ${e.Dictionary[n].Key.TypeName}]`:"[key]"),_(y,e.Dictionary[n].Value,`${I}.v`,c+2,x,e.Dictionary[n].Value.TypeName?`[value: ${e.Dictionary[n].Value.TypeName}]`:"[value]"))}})}H&&u.push({size:e.EnvelopeEndOffset-e.PayloadEndOffset,fn:()=>y.push({id:g+".t",depth:c+1,name:"[trailer]",size:e.EnvelopeEndOffset-e.PayloadEndOffset,sizePercent:(e.EnvelopeEndOffset-e.PayloadEndOffset)*100/t,type:void 0,wireType:void 0,value:void 0,tagId:void 0,hasChildren:!1,isExpanded:!1})})}const ae=u.shift();x==="ascending"?u.sort((n,C)=>C.size-n.size):x==="descending"&&u.sort((n,C)=>n.size-C.size),u.unshift(ae),u.forEach(n=>n?.fn())}const W=[];return _(W,S.value.structure,"1",0,h.value),W}function E(o){return o>=512?"medium":o>=1024?"large":o>=10240?"huge":""}const r=D(new Set);function P(o){r.value.has(o)?r.value.delete(o):r.value.add(o),r.value=new Set(r.value)}function V(){h.value==="none"?h.value="ascending":h.value==="ascending"?h.value="descending":h.value="none"}const z=D([]);function A(o){const t=z.value.indexOf(o);t>-1?z.value.splice(t,1):z.value.push(o)}const M={props:k,gameServerApi:l,sortOrder:h,databaseEntityData:S,databaseEntityError:T,visibleRows:f,getAllRows:w,rowSizeToCssClass:E,expandedKeys:r,toggleExpandedKey:P,sort:V,selectedRows:z,toggleRowDetails:A,computed:Z,onMounted:Y,ref:D,get useGameServerApi(){return $},get MBadge(){return le},get MPageOverviewCard(){return ue},get MTextButton(){return de},get MViewContainer(){return ve}};return Object.defineProperty(M,"__isScriptSetup",{enumerable:!1,value:!0}),M}}),ye={class:"font-weight-bold"},ce=["ariaSort"],pe=["onClick"],be={class:"tw-mr-1"},he={key:1,class:"inspect-button"},Ee={key:1};function _e(G,s,k,l,h,S){const T=v("fa-icon"),f=v("b-td"),w=v("meta-time"),E=v("b-tr"),r=v("meta-abbreviate-number"),P=v("b-tbody"),V=v("b-table-simple"),z=v("b-card-title"),A=v("b-thead"),M=v("meta-alert"),o=v("b-card");return p(),N(l.MViewContainer,{permission:"api.database.inspect_entity","is-loading":!l.databaseEntityData,error:l.databaseEntityError},{overview:a(()=>[i(l.MPageOverviewCard,{id:k.id,title:"Database Entity","data-testid":"database-entity-overview-card"},{default:a(()=>[d("div",ye,[i(T,{icon:"chart-bar"}),s[0]||(s[0]=b(" Overview"))]),i(V,{class:"tw-mt-1",small:"",responsive:""},{default:a(()=>[i(P,null,{default:a(()=>[i(E,null,{default:a(()=>[i(f,null,{default:a(()=>s[1]||(s[1]=[b("Persisted At")]),void 0,!0),_:1}),i(f,{class:"tw-text-right",style:{"min-width":"12rem"}},{default:a(()=>[i(w,{date:l.databaseEntityData.persistedAt,showAs:"datetime"},null,8,["date"])],void 0,!0),_:1})],void 0,!0),_:1}),i(E,null,{default:a(()=>[i(f,null,{default:a(()=>s[2]||(s[2]=[d("div",null,"Entry Schema Version",-1),d("div",{class:"small text-muted"},"The version of the payload in the database. This can be lower than the latest version if entity is not yet migrated.",-1)]),void 0,!0),_:1}),i(f,{class:"tw-text-right"},{default:a(()=>[b(m(l.databaseEntityData.schemaVersion),1)],void 0,!0),_:1})],void 0,!0),_:1}),i(E,null,{default:a(()=>[i(f,null,{default:a(()=>s[3]||(s[3]=[d("div",null,"Actor Schema Version",-1),d("div",{class:"small text-muted"},"The current schema version in use. Entities on older versions will be migrated on the next actor wake-up.",-1)]),void 0,!0),_:1}),i(f,{class:"tw-text-right"},{default:a(()=>[b(m(l.databaseEntityData.currentSchemaVersion),1)],void 0,!0),_:1})],void 0,!0),_:1}),i(E,null,{default:a(()=>[i(f,null,{default:a(()=>s[4]||(s[4]=[d("div",null,"Is Final",-1),d("div",{class:"small text-muted"},"An entity is 'final' when it is not currently in use and has been written to the database cleanly.",-1)]),void 0,!0),_:1}),i(f,{class:"tw-text-right"},{default:a(()=>[i(l.MBadge,{variant:l.databaseEntityData.isFinal?"success":"danger"},{default:a(()=>[b(m(l.databaseEntityData.isFinal),1)],void 0,!0),_:1},8,["variant"])],void 0,!0),_:1})],void 0,!0),_:1}),i(E,null,{default:a(()=>[i(f,null,{default:a(()=>s[5]||(s[5]=[d("div",null,"Size on database",-1),d("div",{class:"small text-muted"},"The number of bytes this entity takes when stored in the database. The entity may be compressed.",-1)]),void 0,!0),_:1}),i(f,{class:"tw-text-right"},{default:a(()=>[i(r,{value:l.databaseEntityData.compressedSize,unit:"byte"},null,8,["value"])],void 0,!0),_:1})],void 0,!0),_:1}),i(E,null,{default:a(()=>[i(f,null,{default:a(()=>s[6]||(s[6]=[d("div",null,"Uncompressed Size",-1),d("div",{class:"small text-muted"},"The size of the entity state when read from the database and uncompressed.",-1)]),void 0,!0),_:1}),i(f,{class:"tw-text-right"},{default:a(()=>[i(r,{value:l.databaseEntityData.uncompressedSize,unit:"byte"},null,8,["value"])],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1},8,["id"])]),default:a(()=>[i(o,{class:"mb-2 table-container tw-mt-4","data-testid":"database-entity-data-card"},{default:a(()=>[i(z,null,{default:a(()=>s[7]||(s[7]=[b("Stored Data")]),void 0,!0),_:1}),l.databaseEntityData?.structure?(p(),N(V,{key:0,class:"text-break",small:"",responsive:""},{default:a(()=>[i(A,null,{default:a(()=>[d("tr",null,[s[8]||(s[8]=d("th",null,"Property",-1)),d("th",{class:"text-right pr-4",colspan:"2",ariaSort:l.sortOrder,onClick:l.sort},"Size",8,ce)])],void 0,!0),_:1}),i(P,{class:"text-monospace small"},{default:a(()=>[(p(!0),O(fe,null,oe(l.visibleRows,t=>(p(),O("tr",{class:B(["small",{highlight:t.hasChildren}]),key:t.id,onClick:_=>l.toggleExpandedKey(t.id)},[d("td",null,[d("div",{class:B(["table-row",{open:t.isExpanded,"table-row-link":t.hasChildren}]),style:ee("padding-left: "+t.depth+"rem")},[t.hasChildren?(p(),N(T,{key:0,class:"tw-mr-1",icon:"angle-right"})):te("",!0),d("span",be,m(t.name),1),l.selectedRows.includes(t.id)?(p(),N(l.MTextButton,{key:2,onClick:_=>l.toggleRowDetails(t.id)},{default:a(()=>s[10]||(s[10]=[b("Close")]),void 0,!0),_:2},1032,["onClick"])):(p(),O("span",he,[i(l.MTextButton,{onClick:_=>l.toggleRowDetails(t.id)},{default:a(()=>s[9]||(s[9]=[b("Inspect")]),void 0,!0),_:2},1032,["onClick"])]))],6),l.selectedRows.includes(t.id)?(p(),O("div",{class:"bg-light rounded border p-2 small",key:t.id+".info",style:ee("margin-left: "+t.depth+"rem")},[d("div",null,"Tag ID: "+m(t.tagId||"-"),1),d("div",null,"Wire Type: "+m(t.wireType||"-"),1),d("div",null,"Type: "+m(t.type||"-"),1),d("div",null,"Value: "+m(t.value!==void 0?t.value:"-"),1)],4)):te("",!0)]),d("td",{class:B(["tw-text-right",l.rowSizeToCssClass(t.size)]),style:{width:"6rem"}},[b(m(t.size),1),s[11]||(s[11]=d("small",{class:"text-muted"},"bytes",-1))],2),d("td",{class:B(["tw-text-right",l.rowSizeToCssClass(t.size)]),style:{width:"5rem"}},"("+m(t.sizePercent.toFixed(2))+"%)",3)],10,pe))),128))],void 0,!0),_:1})],void 0,!0),_:1})):(p(),O("div",Ee,[i(M,{title:"Entity State Not Available."},{default:a(()=>s[12]||(s[12]=[d("div",null,"This entity's state has not yet been initialized. This usually means that the entity has been created, but it's initial data has not yet been set. It is normal that this initialization can take time to complete - try again in a few seconds.",-1),d("div",{class:"mt-2"},"If the problems persists then it may point to an issue.",-1)]),void 0,!0),_:1})]))],void 0,!0),_:1})],void 0,!0),_:1},8,["is-loading","error"])}const ze=re(me,[["render",_e],["__scopeId","data-v-0cc76498"],["__file","DatabaseEntityDetailView.vue"]]);export{ze as default};
