import{d as T,aa as L,f as g,c as v,C as P,x as A,ad as S,M as V,a0 as G,O as U,a8 as R,ae as B,a9 as E,b as W,o as n,a as p,e as x,w as c,p as e,k as h,n as a,t as f,l as j,F,$ as q,_ as H}from"./index-B7jvAjdE.js";import{M as J}from"./MActionModal-coQLkvWs.js";import{M as K}from"./MInputSwitch-C-Z-JJsG.js";import{g as I}from"./localization-Z8p1s5Vr.js";const Q=T({__name:"LocalizationActionPublish",props:{localizationId:{},link:{type:Boolean},publishBlocked:{type:Boolean},textButton:{type:Boolean}},setup(y,{expose:t}){t();const s=S(),i=L(),r=y,M=g(),d=v(()=>{const u=b.value?.find(l=>l.id===r.localizationId);return u?(b.value??[]).filter(l=>!l.isArchived&&!(l.publishedAt!==null||l.unpublishedAt!==null||l.isActive)&&l.buildStartedAt<u.buildStartedAt).map(l=>l.id):[]}),o=g(!1);P(()=>o.value,u=>{i.toggleAutoArchiveWhenPublishing(u)});const C=v(()=>m.value?.name??"No name available"),{data:b,refresh:D}=A(I()),m=v(()=>{if(b.value)return b.value.find(u=>u.id===r.localizationId)}),N=v(()=>m.value?.isActive?"This localization is already active.":m.value?.publishBlockingErrors.length??r.publishBlocked?"Cannot publish a localization that contains errors.":void 0),w=g();function O(){w.value=void 0,setTimeout(()=>{w.value=!!m.value?.publishBlockingErrors.length},1e3),o.value=i.autoArchiveWhenPublishing}const{showSuccessNotification:z}=B();async function _(){await s.post("/localization/publish?parentMustMatchActive=false",{Id:r.localizationId}),z("Localization published."),o.value&&d.value.length>0&&(await s.post("/localization/archive",d.value),z(`Archived ${d.value.length} localizations.`)),window.location.reload()}const k={gameServerApi:s,uiStore:i,props:r,localizationPublishModal:M,archivableLocalizationIds:d,archiveOlderLocalizations:o,localizationName:C,allLocalizationsData:b,allLocalizationsRefresh:D,singleLocalizationWithoutContents:m,bestGuessDisallowPublishReason:N,validatedDisallowPublish:w,onShow:O,showSuccessNotification:z,publishLocalization:_,computed:v,ref:g,watch:P,get useGameServerApi(){return S},get useUiStore(){return L},get MActionModal(){return J},get MBadge(){return V},get MCallout(){return G},get MInputSwitch(){return K},get MButton(){return U},get MTextButton(){return R},get useNotifications(){return B},get maybePluralString(){return E},get useSubscription(){return A},get getAllLocalizationsSubscriptionOptions(){return I}};return Object.defineProperty(k,"__isScriptSetup",{enumerable:!1,value:!0}),k}}),X={key:0,class:"my-5 tw-w-full tw-text-center"},Y={key:1},Z={key:2},$={key:3,class:q(["tw-mt-4 tw-border tw-rounded-md tw-py-2 tw-px-3 tw-border-neutral-200 tw-bg-neutral-100 tw-text-neutral-600"])},tt={class:"tw-mb-1 tw-flex tw-justify-between"},it={class:"tw-font-semibold"},at={class:"small text-muted"};function et(y,t,s,i,r,M){const d=W("b-spinner");return n(),p(F,null,[s.textButton?(n(),x(i.MTextButton,{key:0,"disabled-tooltip":i.bestGuessDisallowPublishReason,permission:"api.localization.edit",onClick:i.localizationPublishModal?.open,"data-testid":"`publish-localization-${localizationId}`"},{default:c(()=>t[2]||(t[2]=[e("Publish")]),void 0,!0),_:1},8,["disabled-tooltip","onClick"])):(n(),x(i.MButton,{key:1,"disabled-tooltip":i.bestGuessDisallowPublishReason,permission:"api.localization.edit",onClick:t[0]||(t[0]=o=>i.localizationPublishModal?.open()),"data-testid":"`publish-localization-${localizationId}`"},{default:c(()=>t[3]||(t[3]=[e("Publish")]),void 0,!0),_:1},8,["disabled-tooltip"])),h(i.MActionModal,{ref:"localizationPublishModal",title:"Publish Localization",action:i.publishLocalization,"ok-button-label":"Publish Localization","ok-button-disabled-tooltip":i.validatedDisallowPublish?"Cannot publish a localization that contains errors.":void 0,onShow:i.onShow,"data-testid":"`publish-localization-${localizationId}`"},{default:c(()=>[i.validatedDisallowPublish===void 0?(n(),p("div",X,[t[4]||(t[4]=a("div",{class:"font-weight-bold"},"Validating Localization",-1)),t[5]||(t[5]=a("div",{class:"small text-muted tw-mt-1"},"Please wait while we check that this localization is valid for publishing.",-1)),h(d,{class:"tw-mt-3",label:"Validating..."})])):i.validatedDisallowPublish?(n(),p("div",Y,[h(i.MCallout,{title:"Cannot Publish Localization",variant:"danger"},{default:c(()=>[t[9]||(t[9]=a("span",null,"This localization cannot be validated for publishing because it contains errors.",-1)),a("span",null,[t[7]||(t[7]=e("Please view the ")),h(i.MTextButton,{to:`/localizations/${s.localizationId}`},{default:c(()=>t[6]||(t[6]=[e("localization's details page")]),void 0,!0),_:1},8,["to"]),t[8]||(t[8]=e(" to see the errors."))])],void 0,!0),_:1})])):(n(),p("div",Z,[a("div",null,[t[10]||(t[10]=e("Publishing ")),h(i.MBadge,{variant:"neutral"},{default:c(()=>[e(f(i.localizationName),1)],void 0,!0),_:1}),t[11]||(t[11]=e(" will make it the active localization, effective immediately."))]),t[12]||(t[12]=a("div",{class:"small text-muted tw-mt-2"},"Any player logging in after this publish action will download and use the new localization.",-1)),t[13]||(t[13]=a("div",{class:"small text-muted tw-mt-2"},[e("Live players will download the new localization in the background and, depending on the client's "),a("span",{class:"text-monospace small tw-break-all"},"IMetaplayLocalizationDelegate.AutoActivateLanguageUpdates"),e(" setting, will either switch to it immediately when the download completes or on the next login. By default, live players will switch to the new localization only on the next login.")],-1)),t[14]||(t[14]=a("div",{class:"small text-muted tw-mt-2"},"Other people using the LiveOps Dashboard at the moment may be disrupted by the game data changing while they work, so make sure to let them know you are publishing an update!",-1))])),(i.archivableLocalizationIds?.length??[])>0?(n(),p("div",$,[a("div",tt,[a("div",it,"Archive "+f(i.maybePluralString(i.archivableLocalizationIds?.length,"Older Unpublished Localization")),1),h(i.MInputSwitch,{"model-value":i.archiveOlderLocalizations,size:"small","onUpdate:modelValue":t[1]||(t[1]=o=>i.archiveOlderLocalizations=o)},null,8,["model-value"])]),a("div",at,"At the same time as publishing this localization, you can also automatically archive "+f(i.maybePluralString(i.archivableLocalizationIds?.length,"older unpublished localization"))+". This is useful in keeping your localization history manageable.",1)])):j("",!0)],void 0,!0),_:1},8,["ok-button-disabled-tooltip"])],64)}const rt=H(Q,[["render",et],["__file","LocalizationActionPublish.vue"]]);export{rt as L};
