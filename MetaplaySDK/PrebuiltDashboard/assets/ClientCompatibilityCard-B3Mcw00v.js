import{d as de,x as E,a3 as z,A as D,c as d,f,ad as G,M as ce,a0 as ue,ac as ge,a8 as me,ae as j,O as ve,ba as we,bN as fe,a9 as q,dZ as be,o as l,e as O,w as c,n as i,p as b,k as s,l as P,t as u,a as g,F as h,r as k,$ as pe,_ as Ve}from"./index-B7jvAjdE.js";import{M as Se}from"./MActionModalButton-CvWVuTB-.js";import{M as Me}from"./MInputHintMessage-DbuBS4Kn.js";import{M as xe}from"./MInputSwitch-C-Z-JJsG.js";import{M as he}from"./MInputNumber-BOzPEn49.js";import{M as ye}from"./MInputSingleSelectDropdown-D7-YpE7w.js";import{M as _e}from"./MInputSingleSelectRadio-BukGu4ZH.js";import{M as Ce}from"./MInputText-CzhsT8yb.js";import{t as Le}from"./toString-DMHXP3G8.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";import"./index-B_QkKjtG.js";import"./index-DZuvHjnn.js";import"./index-qTA83-by.js";import"./index-CDBqmjrS.js";import"./debounce-B8gTqdZO.js";import"./isSymbol-B7ZrWRtH.js";function Re(){var S=arguments,t=Le(S[0]);return S.length<3?t:t.replace(S[1],S[2])}const Pe=de({__name:"ClientCompatibilityCard",setup(S,{expose:t}){t();const I=G(),{data:e,refresh:A,error:U}=E(z()),{data:o}=E(D()),a=d(()=>{if(!e.value)return[];const n=e.value.clientCompatibilitySettings.activeLogicVersionRange.minVersion,r=e.value.clientCompatibilitySettings.activeLogicVersionRange.maxVersion;return(o.value?.supportedLogicVersionOptions??[]).filter(N=>N>=n&&N<=r)});function M(n){return e.value?e.value.clientCompatibilitySettings.clientPatchVersionRequirements.filter(r=>r.forLogicVersion===n):[]}const m=f(0),v=f(0),K=d(()=>o.value?.supportedLogicVersionOptions?o.value.supportedLogicVersionOptions.map(n=>({label:n===e.value?.clientCompatibilitySettings.activeLogicVersionRange.minVersion?`${n} (current)`:String(n),value:n})):[]),W=d(()=>y.value?"warning":"primary"),Z=d(()=>{if(y.value)return"Rolling back the current selection! Are you sure?"}),J=d(()=>o.value?.supportedLogicVersionOptions?o.value.supportedLogicVersionOptions.map(n=>({label:n===e.value?.clientCompatibilitySettings.activeLogicVersionRange.maxVersion?`${n} (current)`:String(n),value:n,disabled:n<m.value})):[]),Q=d(()=>V.value?"danger":_.value?"warning":"primary"),X=d(()=>V.value?"This must not be smaller than the min version.":_.value?"Rolling back the current selection! Are you sure?":void 0),Y=d(()=>o.value?.supportedLogicVersionOptions?o.value.supportedLogicVersionOptions.filter(r=>r>=m.value&&r<=v.value):[]),V=d(()=>m.value>v.value),y=d(()=>V.value||!e.value?!1:m.value!==void 0&&m.value<e.value.clientCompatibilitySettings.activeLogicVersionRange.minVersion),_=d(()=>V.value||!e.value?!1:v.value!==void 0&&v.value<e.value.clientCompatibilitySettings.activeLogicVersionRange.maxVersion),$=d(()=>V.value||!e.value?!1:y.value||_.value),w=f([]);function ee(n){return w.value.filter(r=>r.forLogicVersion===n)}function te(n,r,p){w.value=w.value.map(B=>B===r?p:B)}function ie(n){const r={forLogicVersion:n,forPlatform:null,minPatchVersion:1};w.value=[...w.value,r]}const ne=[{label:"all platforms",value:null},{label:"iOS",value:"iOS"},{label:"Android",value:"Android"},{label:"WebGL",value:"WebGL"},{label:"unknown",value:"Unknown"}];function oe(n){const r=w.value.some(p=>p!==n&&p.forLogicVersion===n.forLogicVersion&&(p.forPlatform===n.forPlatform||p.forPlatform===null)&&p.minPatchVersion>=n.minPatchVersion);return{variant:r?"warning":"default",hintMessage:r?"This rule is unnecessary as it is covered by another rule.":`Clients with patch ${q(n.minPatchVersion,"version",!1)} ${n.minPatchVersion-1<=0?"0":`0-${n.minPatchVersion-1}`} on ${n.forPlatform==="Unknown"?"unknown":n.forPlatform} will be refused.`}}const C=f(""),L=f(9339),F=f(!0),R=f(""),x=f(!1);function se(n){return x.value?n?"success":"danger":"default"}const re=d(()=>(!x.value||!!C.value&&!!L.value&&!!R.value)&&!!m.value&&!!v.value&&!V.value),{showSuccessNotification:T}=j();async function ae(){if(!m.value||!v.value)return;const n={activeLogicVersionRange:{minVersion:m.value,maxVersion:v.value},redirectEnabled:x.value,redirectServerEndpoint:{serverHost:C.value,serverPort:L.value,enableTls:F.value,cdnBaseUrl:R.value},clientPatchVersionRequirements:w.value};await I.post("/clientCompatibilitySettings",n),T("Client compatibility settings updated."),A()}function le(){if(!e.value)return;const n=e.value.clientCompatibilitySettings,r=n.redirectServerEndpoint;m.value=n.activeLogicVersionRange.minVersion,v.value=n.activeLogicVersionRange.maxVersion,w.value=n.clientPatchVersionRequirements,x.value=n.redirectEnabled,C.value=r?r.serverHost:"",L.value=r?r.serverPort:9339,F.value=r?r.enableTls:!0,R.value=r?r.cdnBaseUrl:""}const H={gameServerApi:I,backendStatusData:e,backendStatusTriggerRefresh:A,backendStatusError:U,staticConfig:o,activeLogicVersions:a,getLogicVersionPatchesForVersion:M,selectedActiveLogicVersionMin:m,selectedActiveLogicVersionMax:v,activeLogicVersionMinOptions:K,minVersionSelectVariant:W,minVersionSelectHintMessage:Z,activeLogicVersionMaxOptions:J,maxVersionSelectVariant:Q,maxVersionSelectHintMessage:X,selectedActiveLogicVersions:Y,isInvalidLogicVersionRange:V,isRollingBackMinLogicVersion:y,isRollingBackMaxLogicVersion:_,isRollingBackLogicVersion:$,selectedClientPatchRequirements:w,getLogicVersionPatchesForSelectedVersion:ee,replacePatchVersionRequirement:te,addNewSelectedClientPatch:ie,platformOptions:ne,evaluateRule:oe,selectedRedirectHost:C,selectedRedirectPort:L,selectedRedirectTls:F,selectedRedirectCdnUrl:R,selectedRedirectEnabled:x,getFormVariant:se,isLogicVersionFormValid:re,showSuccessNotification:T,setClientCompatibilitySettings:ae,resetModal:le,get replace(){return Re},computed:d,ref:f,get useGameServerApi(){return G},get MActionModalButton(){return Se},get MBadge(){return ce},get MCallout(){return ue},get MCard(){return ge},get MInputSingleSelectRadio(){return _e},get MInputSwitch(){return xe},get MInputText(){return Ce},get MTextButton(){return me},get MInputHintMessage(){return Me},get useNotifications(){return j},get MInputNumber(){return he},get MButton(){return ve},get MButtonGroupLayout(){return we},get MInputSingleSelectDropdown(){return ye},get MIconButton(){return fe},get maybePluralString(){return q},get useSubscription(){return E},get FontAwesomeIcon(){return be},get getBackendStatusSubscriptionOptions(){return z},get getStaticConfigSubscriptionOptions(){return D}};return Object.defineProperty(H,"__isScriptSetup",{enumerable:!1,value:!0}),H}}),ke={class:"tw-divide-y tw-divide-neutral-300"},Ie={class:"tw-flex tw-px-4 tw-py-2"},Ae={class:"tw-w-12"},Fe={class:"tw-text-sm tw-text-neutral-400"},Be={class:"tw-flex tw-px-4 tw-py-2"},Ee={class:"tw-w-12"},Oe={class:"tw-flex tw-grow tw-items-center tw-gap-2 tw-py-2"},Ue={class:"tw-font-semibold"},Te={class:"tw-text-right"},He={class:"tw-flex tw-px-4 tw-py-2"},Ne={class:"tw-w-12"},ze={class:"tw-grow tw-py-2"},De={class:"tw-font-semibold"},Ge={class:"tw-pl-2"},je={key:0,class:"tw-flex tw-items-center tw-gap-2"},qe={class:"tw-text-right"},Ke={class:"tw-flex tw-items-center tw-gap-2"},We={class:"tw-text-sm"},Ze={class:"tw-text-right"},Je={class:"tw-flex tw-items-center tw-gap-2"},Qe={class:"tw-text-right"},Xe={class:"tw-flex tw-px-4 tw-py-2"},Ye={class:"tw-w-12"},$e={class:"tw-flex tw-grow tw-items-center tw-gap-2 tw-pb-0.5 tw-pt-2"},et={class:"tw-font-semibold"},tt={class:"tw-text-right"},it={key:0,class:"tw-text-sm tw-text-neutral-400"},nt={class:"tw-divide-y tw-divide-neutral-200 tw-rounded-md tw-border tw-border-neutral-200 tw-bg-neutral-50"},ot={class:"tw-flex tw-px-4 tw-py-3"},st={class:"tw-w-12"},rt={class:"tw-text-sm tw-text-neutral-400"},at={class:"tw-flex tw-px-4 tw-py-2"},lt={class:"tw-w-12"},dt={class:"tw-grow tw-py-2"},ct={class:"tw-flex tw-px-4 tw-py-2"},ut={class:"tw-w-12"},gt={class:"tw-grow tw-space-y-2 tw-py-2"},mt={class:"tw-font-semibold"},vt={class:"tw-flex tw-gap-2 tw-text-sm"},wt={key:0},ft={key:1},bt={class:"tw-flex tw-px-4 tw-py-2"},pt={class:"tw-w-12"},Vt={class:"tw-grow tw-py-2"},St={class:"tw-rounded-md tw-border tw-border-neutral-200 tw-bg-neutral-50 tw-p-3"},Mt={class:"tw-flex tw-justify-between"},xt={key:1,class:"tw-mt-2 tw-space-y-4 tw-border-t tw-border-neutral-300 tw-pt-1"},ht={class:"tw-flex tw-justify-between"};function yt(S,t,I,e,A,U){return l(),O(e.MCard,{isLoading:!e.backendStatusData||!e.staticConfig,title:"Client Compatibility Settings",error:e.backendStatusError,"no-body-padding":"","data-testid":"system-client-compatibility-card"},{subtitle:c(()=>[i("p",null,[t[8]||(t[8]=b("Prevent incompatible clients from connecting based on their logic version. For more details, see the ")),s(e.MTextButton,{to:"https://docs.metaplay.io/game-logic/utilities/logic-versions.html"},{default:c(()=>t[7]||(t[7]=[b("logic versioning documentation")]),void 0,!0),_:1}),t[9]||(t[9]=b("."))])]),buttons:c(()=>[s(e.MActionModalButton,{"modal-title":"Update Client Compatibility Settings",action:e.setClientCompatibilitySettings,"trigger-button-label":"Edit Settings","trigger-button-disabled-tooltip":e.staticConfig?.supportedLogicVersions?void 0:"Logic versions are not yet loaded.","ok-button-label":"Save Settings","ok-button-disabled-tooltip":e.isLogicVersionFormValid?void 0:"Invalid settings. Please fix the errors.",permission:"api.system.edit_logicversioning",onShow:e.resetModal,"data-testid":"client-redirect-settings"},{"bottom-panel":c(()=>[e.isRollingBackLogicVersion?(l(),O(e.MCallout,{key:0,title:"Tread Carefully, Brave Knight"},{default:c(()=>[t[22]||(t[22]=b("Rolling back the active ")),s(e.MBadge,null,{default:c(()=>t[21]||(t[21]=[b("LogicVersion")]),void 0,!0),_:1}),t[23]||(t[23]=b(" can have very bad unintended consequences and should ideally never be done. Please make sure you know what you are doing before saving this action!"))],void 0,!0),_:1})):P("",!0)]),"right-panel":c(()=>[i("div",St,[i("div",Mt,[t[24]||(t[24]=i("span",{class:"tw-text-sm tw-font-bold tw-leading-6"},"Redirect New Clients",-1)),s(e.MInputSwitch,{class:"tw-relative tw-top-0.5","model-value":e.selectedRedirectEnabled,size:"small","onUpdate:modelValue":t[2]||(t[2]=o=>e.selectedRedirectEnabled=o),"data-testid":"client-redirect-enabled"},null,8,["model-value"])]),e.selectedRedirectEnabled?P("",!0):(l(),O(e.MInputHintMessage,{key:0},{default:c(()=>[b("Optionally redirect clients with logic versions newer than "+u(e.selectedActiveLogicVersionMax)+" to connect to a different game server.",1)],void 0,!0),_:1})),e.selectedRedirectEnabled?(l(),g("div",xt,[s(e.MInputText,{label:"Host","model-value":e.selectedRedirectHost,disabled:!e.selectedRedirectEnabled,variant:e.getFormVariant(e.selectedRedirectHost),hintMessage:e.selectedRedirectHost?void 0:"This field is required.","onUpdate:modelValue":t[3]||(t[3]=o=>e.selectedRedirectHost=o),"data-testid":"input-text-host"},null,8,["model-value","disabled","variant","hintMessage"]),s(e.MInputNumber,{label:"Port","model-value":e.selectedRedirectPort,disabled:!e.selectedRedirectEnabled,variant:e.getFormVariant(e.selectedRedirectPort),hintMessage:e.selectedRedirectPort?void 0:"This field is required.","onUpdate:modelValue":t[4]||(t[4]=o=>e.selectedRedirectPort=o??9339),"data-testid":"input-text-port"},null,8,["model-value","disabled","variant","hintMessage"]),s(e.MInputText,{label:"CDN URL","model-value":e.selectedRedirectCdnUrl,disabled:!e.selectedRedirectEnabled,variant:e.getFormVariant(e.selectedRedirectCdnUrl),hintMessage:e.selectedRedirectCdnUrl?void 0:"This field is required.","onUpdate:modelValue":t[5]||(t[5]=o=>e.selectedRedirectCdnUrl=o),"data-testid":"input-text-cdn-url"},null,8,["model-value","disabled","variant","hintMessage"]),i("div",ht,[t[25]||(t[25]=i("span",{class:"tw-font-semibold"},"TLS Enabled",-1)),s(e.MInputSwitch,{class:"tw-relative tw-top-1 tw-mr-1","model-value":e.selectedRedirectTls,disabled:!e.selectedRedirectEnabled,name:"redirectTls",size:"small","onUpdate:modelValue":t[6]||(t[6]=o=>e.selectedRedirectTls=o)},null,8,["model-value","disabled"])])])):P("",!0)])]),default:c(()=>[t[26]||(t[26]=i("p",{class:"tw-mb-4"},"Changing the active logic version range will not kick connected clients as only new connections will be refused. Maintenance mode can be used to disconnect clients.",-1)),i("div",nt,[i("div",ot,[i("div",st,[s(e.FontAwesomeIcon,{icon:"arrow-down-long",size:"xl",transform:"down-4"})]),i("div",null,[t[17]||(t[17]=i("p",{class:"tw-font-semibold"},"Incoming connection",-1)),i("p",rt,"Known logic versions: "+u(e.staticConfig?.supportedLogicVersionOptions.join(", ")),1)])]),i("div",at,[i("div",lt,[s(e.FontAwesomeIcon,{class:"tw-pt-2",icon:"arrow-turn-up",size:"xl",transform:"right-7 rotate-90"})]),i("div",dt,[s(e.MInputSingleSelectRadio,{label:"Refuse logic versions older than...","model-value":e.selectedActiveLogicVersionMin,options:e.activeLogicVersionMinOptions,size:"small",variant:e.minVersionSelectVariant,hintMessage:e.minVersionSelectHintMessage,"onUpdate:modelValue":t[0]||(t[0]=o=>e.selectedActiveLogicVersionMin=o)},null,8,["model-value","options","variant","hintMessage"])])]),(l(!0),g(h,null,k(e.selectedActiveLogicVersions,o=>(l(),g("div",ct,[i("div",ut,[s(e.FontAwesomeIcon,{class:"tw-pt-2",icon:"arrow-turn-up",size:"xl",transform:"right-7 rotate-90"})]),i("div",gt,[i("p",mt,"Logic version "+u(o),1),(l(!0),g(h,null,k(e.getLogicVersionPatchesForSelectedVersion(o),a=>(l(),g("div",null,[i("div",vt,[s(e.MInputNumber,{class:"tw-basis-44",label:"Refuse patches under...",min:1,"model-value":a.minPatchVersion,variant:e.evaluateRule(a).variant,"onUpdate:modelValue":M=>e.replacePatchVersionRequirement(o,a,{...a,minPatchVersion:M??1})},null,8,["model-value","variant","onUpdate:modelValue"]),s(e.MInputSingleSelectDropdown,{class:"tw-grow",label:"...on this platform",options:e.platformOptions,"model-value":a.forPlatform,"onUpdate:modelValue":M=>e.replacePatchVersionRequirement(o,a,{...a,forPlatform:M})},null,8,["model-value","onUpdate:modelValue"]),s(e.MIconButton,{variant:"danger",onClick:M=>e.selectedClientPatchRequirements=e.selectedClientPatchRequirements.filter(m=>m!==a)},{default:c(()=>[s(e.FontAwesomeIcon,{icon:"trash-alt",size:"sm"})],void 0,!0),_:2},1032,["onClick"])]),s(e.MInputHintMessage,{variant:e.evaluateRule(a).variant},{default:c(()=>[b(u(e.evaluateRule(a).hintMessage),1)],void 0,!0),_:2},1032,["variant"])]))),256)),e.getLogicVersionPatchesForSelectedVersion(o).length===0?(l(),g("div",wt,t[18]||(t[18]=[i("p",{class:"tw-text-sm"},"Allow all patch versions.",-1)]))):(l(),g("div",ft,t[19]||(t[19]=[i("p",{class:"tw-text-sm"},"...and allow all other patch versions.",-1)]))),s(e.MButtonGroupLayout,null,{default:c(()=>[s(e.MButton,{size:"small",onClick:a=>e.addNewSelectedClientPatch(o)},{default:c(()=>t[20]||(t[20]=[b("Add New Rule")]),void 0,!0),_:2},1032,["onClick"])],void 0,!0),_:2},1024)])]))),256)),i("div",bt,[i("div",pt,[s(e.FontAwesomeIcon,{class:"tw-pt-2",icon:"arrow-turn-up",size:"xl",transform:"right-7 rotate-90"})]),i("div",Vt,[s(e.MInputSingleSelectRadio,{label:`${e.selectedRedirectEnabled?"Redirect":"Refuse"} logic versions newer than...`,"model-value":e.selectedActiveLogicVersionMax,options:e.activeLogicVersionMaxOptions,size:"small",variant:e.maxVersionSelectVariant,hintMessage:e.maxVersionSelectHintMessage,"onUpdate:modelValue":t[1]||(t[1]=o=>e.selectedActiveLogicVersionMax=o)},null,8,["label","model-value","options","variant","hintMessage"])])])])],void 0,!0),_:1},8,["trigger-button-disabled-tooltip","ok-button-disabled-tooltip"])]),default:c(()=>[i("div",ke,[i("div",Ie,[i("div",Ae,[s(e.FontAwesomeIcon,{icon:"arrow-down-long",size:"xl",transform:"down-4"})]),i("div",null,[t[10]||(t[10]=i("p",{class:"tw-font-semibold"},"Incoming connection",-1)),i("p",Fe,"Known logic versions: "+u(e.staticConfig?.supportedLogicVersionOptions.join(", ")),1)])]),i("div",Be,[i("div",Ee,[s(e.FontAwesomeIcon,{class:"tw-pt-2",icon:"arrow-turn-up",size:"xl",transform:"right-7 rotate-90"})]),i("div",Oe,[i("p",Ue,"Logic versions older than "+u(e.backendStatusData?.clientCompatibilitySettings.activeLogicVersionRange.minVersion),1),i("div",Te,[s(e.FontAwesomeIcon,{icon:"arrow-right-long"})]),t[11]||(t[11]=i("p",{class:"tw-font-semibold tw-text-red-500"},"Refused",-1))])]),(l(!0),g(h,null,k(e.activeLogicVersions,o=>(l(),g("div",He,[i("div",Ne,[s(e.FontAwesomeIcon,{class:"tw-pt-2",icon:"arrow-turn-up",size:"xl",transform:"right-7 rotate-90"})]),i("div",ze,[i("p",De,"Logic version "+u(o),1),i("ul",Ge,[e.getLogicVersionPatchesForVersion(o).length===0?(l(),g("li",je,[s(e.FontAwesomeIcon,{icon:"arrow-turn-up",transform:"rotate-90"}),t[12]||(t[12]=i("p",{class:"tw-text-sm"},"All patch versions",-1)),i("div",qe,[s(e.FontAwesomeIcon,{icon:"arrow-right-long"})]),t[13]||(t[13]=i("p",{class:"tw-font-semibold tw-text-green-500"},"Allowed",-1))])):(l(),g(h,{key:1},[(l(!0),g(h,null,k(e.getLogicVersionPatchesForVersion(o),a=>(l(),g("li",Ke,[s(e.FontAwesomeIcon,{icon:"arrow-turn-up",transform:"rotate-90"}),i("p",We,"Patch "+u(e.maybePluralString(a.minPatchVersion,"version",!1))+" "+u(a.minPatchVersion-1<=0?"0":`0-${a.minPatchVersion-1}`)+" on "+u(a.forPlatform==="Unknown"?"unknown":a.forPlatform??"all platforms"),1),i("div",Ze,[s(e.FontAwesomeIcon,{icon:"arrow-right-long"})]),t[14]||(t[14]=i("p",{class:"tw-font-semibold tw-text-red-500"},"Refused",-1))]))),256)),i("li",Je,[s(e.FontAwesomeIcon,{icon:"arrow-turn-up",transform:"rotate-90"}),t[15]||(t[15]=i("p",{class:"tw-text-sm"},"All other patch versions",-1)),i("div",Qe,[s(e.FontAwesomeIcon,{icon:"arrow-right-long"})]),t[16]||(t[16]=i("p",{class:"tw-font-semibold tw-text-green-500"},"Allowed",-1))])],64))])])]))),256)),i("div",Xe,[i("div",Ye,[s(e.FontAwesomeIcon,{class:"tw-pt-2",icon:"arrow-turn-up",size:"xl",transform:"right-7 rotate-90"})]),i("div",null,[i("div",$e,[i("p",et,"Logic versions newer than "+u(e.backendStatusData?.clientCompatibilitySettings.activeLogicVersionRange.maxVersion),1),i("div",tt,[s(e.FontAwesomeIcon,{icon:"arrow-right-long"})]),i("p",{class:pe(["tw-font-semibold",{"tw-text-red-500":!e.backendStatusData?.clientCompatibilitySettings.redirectEnabled,"tw-text-blue-500":e.backendStatusData?.clientCompatibilitySettings.redirectEnabled}]),"data-testid":"client-redirect-status"},u(e.backendStatusData?.clientCompatibilitySettings.redirectEnabled?"Redirected":"Refused"),3)]),e.backendStatusData?.clientCompatibilitySettings.redirectEnabled?(l(),g("p",it,"Redirecting to "+u(e.backendStatusData?.clientCompatibilitySettings.redirectServerEndpoint?.serverHost)+":"+u(e.backendStatusData?.clientCompatibilitySettings.redirectServerEndpoint?.serverPort),1)):P("",!0)])])])],void 0,!0),_:1},8,["isLoading","error"])}const Dt=Ve(Pe,[["render",yt],["__file","ClientCompatibilityCard.vue"]]);export{Dt as default};
