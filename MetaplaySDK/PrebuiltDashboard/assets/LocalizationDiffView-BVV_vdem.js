import{d as we,x as K,c as R,b as g,o as c,a as D,n as f,t as k,p as h,k as d,l as v,_ as ye,aj as se,ab as le,f as A,cf as Z,cg as re,C as $,ch as de,ak as ee,ad as ce,M as Ae,bN as Be,v as Re,a8 as Ce,ae as ue,e as y,w as i,F as fe,r as me,$ as Ve}from"./index-B7jvAjdE.js";import{d as ve}from"./index-DOK9ROJo.js";import{M as Te,a as Ee}from"./MViewContainer-BTeE2xDT.js";import{M as Pe}from"./MInputSingleSelectSwitch-CuptGC6e.js";import{b as te,c as W,M as q,a as J}from"./metaListUtils-B-xQ0HnD.js";import{g as H,b as pe}from"./localization-Z8p1s5Vr.js";import{C as je}from"./CoreUiPlacement-CPf1fwrN.js";import"./index-CDBqmjrS.js";import"./index-B_QkKjtG.js";import"./MInputSimpleSelectDropdown-DIlBEFcs.js";import"./index-qTA83-by.js";import"./MInputHintMessage-DbuBS4Kn.js";const Fe=we({__name:"LocalizationSelectOption",props:{localizationId:{}},setup(l,{expose:n}){n();const B=l,{data:e}=K(H()),V=R(()=>(e.value??[]).find(O=>O.id===B.localizationId)),z={props:B,allLocalizationsData:e,localizationFromId:V,computed:R,get useSubscription(){return K},get getAllLocalizationsSubscriptionOptions(){return H}};return Object.defineProperty(z,"__isScriptSetup",{enumerable:!1,value:!0}),z}}),Ue={style:{"font-size":"0.95rem"}},qe={class:"font-weight-bold"},Je={class:"small font-mono"},Ke={key:0,class:"small"};function Ye(l,n,B,e,V,z){const O=g("meta-time");return c(),D("div",Ue,[f("div",qe,k(e.localizationFromId?.name??"No name available"),1),f("div",Je,k(B.localizationId),1),e.localizationFromId?(c(),D("div",Ke,[n[0]||(n[0]=h("Built ")),d(O,{date:e.localizationFromId?.buildStartedAt},null,8,["date"])])):v("",!0)])}const Ge=ye(Fe,[["render",Ye],["__file","LocalizationSelectOption.vue"]]);var _e=(l=>(l.Loading="Loading",l.Loaded="Loaded",l.Error="Error",l))(_e||{}),ge=(l=>(l.Added="Added",l.Removed="Removed",l.Modified="Modified",l))(ge||{}),be=(l=>(l.Unchanged="Unchanged",l.Added="Added",l.Removed="Removed",l))(be||{}),he=(l=>(l.Diff="Diff",l.Additions="Additions",l.Baseline="Baseline",l.Destination="Destination",l))(he||{});const Qe=we({__name:"LocalizationDiffView",setup(l,{expose:n}){n();const B=ce(),e=se(),V=le(),{data:z}=K(pe("$active")),{data:O}=K(H()),b={},p=A(Z(e.query,"baselineRoot")),w=A(Z(e.query,"newRoot"));re(async()=>{await Promise.all([C(p.value),C(w.value)])}),$(p,async()=>{N.value=T(p.value),N.value||await C(p.value),P()}),$(w,async()=>{I.value=T(w.value),I.value||await C(w.value),P()}),de(()=>{z.value&&(b[z.value.info.id]=z.value,p.value||(p.value=z.value.info.id),w.value||(w.value=z.value.info.id))});function P(){const s=(e.path+`?baselineRoot=${p.value}&newRoot=${w.value}`).split("?"),u=s[0],M=Object.fromEntries(s[1].split("&").map(S=>S.split("=")));V.replace({path:u,query:M}).catch(S=>{if(S.name!=="NavigationDuplicated")throw Error(S)})}const{showSuccessNotification:Y}=ue();function X(){const t=p.value;p.value=w.value,w.value=t,Y("Localizations swapped.")}async function C(t){if(t!==void 0&&x.value!=="Error"&&b[t]===void 0){x.value="Loading",b[t]=null;try{const u=(await B.get(`/localization/${t}`)).data;u.info.bestEffortStatus!=="Success"?(j.value=new ee(`Failed to load diff source ${t}`,`The status of the localization was ${u.info.bestEffortStatus}, expected status was Success. You can't compare against this localization because it failed to build.`),x.value="Error"):(b[t]=u,x.value!=="Error"&&!Object.values(b).some(M=>M==null)&&(N.value=T(p.value),I.value=T(w.value),x.value="Loaded"))}catch(s){j.value=new ee("Oh no, something went wrong while trying to compare two localizations:",s.message),x.value="Error"}}}const x=A("Loading"),j=A(),N=A(),I=A(),o=R(()=>{const t=N.value,s=I.value;if(!t||!s)return[];const u=[],M=Object.keys(s),S=Object.keys(t);return M.forEach(a=>{const _=s[a]??null,m=t[a]??null;if(_===null){m&&u.push({anchorName:`${a}-whole-library`,displayName:a,languageName:a,itemName:"",reason:"Added"});return}m!==null&&Object.keys(_).forEach(r=>{Object.prototype.hasOwnProperty.call(m,r)||u.push({anchorName:`${a}-${r}`,displayName:`${a}.${r}`,languageName:a,itemName:r,reason:"Added"})})}),S.forEach(a=>{const _=t[a]??null,m=s[a]??null;if(_===null){m&&u.push({anchorName:`${a}-whole-library`,displayName:a,languageName:a,itemName:"",reason:"Removed"});return}m!==null&&Object.keys(_).forEach(r=>{Object.prototype.hasOwnProperty.call(m,r)||u.push({anchorName:`${a}-${r}`,displayName:`${a}.${r}`,languageName:a,itemName:r,reason:"Removed"})})}),S.forEach(a=>{const _=t[a]??null,m=s[a]??null;!_||!m||Object.keys(_).forEach(r=>{if(Object.prototype.hasOwnProperty.call(m,r)){const E=JSON.stringify(_[r]),Q=JSON.stringify(m[r]);E!==Q&&!E.startsWith('"#missing#')&&!Q.startsWith('"#missing#')&&u.push({anchorName:`${a}-${r}`,displayName:`${a}.${r}`,languageName:a,itemName:r,reason:"Modified"})}})}),u.sort((a,_)=>{const m=a.anchorName.toLowerCase(),r=_.anchorName.toLowerCase();return m<r?-1:m>r?1:0}),u});function T(t){const s=b[t??""];if(s){const u={};return Object.entries(s.locs).forEach(([M,S])=>{u[M]=S.translations}),u}else return}function L(t,s){let u={};Object.prototype.hasOwnProperty.call(N.value?.[t],s)&&(u=N.value?.[t][s]);let M={};Object.prototype.hasOwnProperty.call(I.value?.[t],s)&&(M=I.value?.[t][s]);const S=G(u),a=G(M),_=ve(S,a),m=[];return _.forEach(r=>{let E="Unchanged";r.added?E="Added":r.removed&&(E="Removed");const Q=r.value.split(/\r?\n/).slice(0,r.count);m.push(...Q.map(ie=>{const ae=ie.split(":")[0],xe=ae.replace(/"/g,""),Ne=ie.replace(ae,xe);return{reason:E,text:Ne}}))}),m}function G(t){return typeof t=="string"?`  "${t}"`:typeof t=="number"?`  ${t}`:Object.keys(t).length===0?" ":JSON.stringify(t,(s,u)=>u,2).slice(2,-2)}const ze=[{label:"baseline",value:"Baseline"},{label:"Full Diff",value:"Diff"},{label:"Only Additions",value:"Additions"},{label:"New",value:"Destination"}],F=A("Diff");function Le(t){return F.value==="Diff"||F.value==="Additions"&&t!=="Removed"||F.value==="Baseline"&&t!=="Added"?!0:F.value==="Destination"&&t!=="Removed"}const U=A([]);function Se(t){const s=U.value.indexOf(t);s===-1?U.value.push(t):U.value.splice(s,1)}function Oe(t){return!U.value.includes(t)}const Ie=R(()=>[te.asDynamicFilterSet(o.value,"library",t=>t.languageName),new te("reason",[new W("Modified",t=>t.reason==="Modified"),new W("Added",t=>t.reason==="Added"),new W("Removed",t=>t.reason==="Removed")])]),Me=[new q("Name","displayName",J.Ascending),new q("Name","displayName",J.Descending),new q("Reason","reason",J.Ascending),new q("Reason","reason",J.Descending)],De=R(()=>p.value===w.value?"You are comparing a localization version against itself. Unsurprisingly, this means that there are no differences to be found ðŸ¤”":"No differences found between the two localization versions ðŸ¤”"),ke=R(()=>ne.value.map(t=>{const s=O.value?.find(u=>u.id===t);return{id:`${t} - ${s?.name??"No name available"} - ${s?.description??"No description available"}`,value:t}})),ne=R(()=>(O.value??[]).filter(t=>t.bestEffortStatus==="Success"&&!t.isArchived).map(t=>t.id)),oe={gameServerApi:B,route:e,router:V,activeLocalizationIdData:z,allLocalizationData:O,sourceLocalizations:b,baselineLocalizationId:p,newLocalizationId:w,updateBrowserAddressBar:P,showSuccessNotification:Y,swapLocalizations:X,LoadingState:_e,loadLocalization:C,loadingState:x,loadingError:j,baselineLocalization:N,newLocalization:I,DiffItemReason:ge,items:o,fetchLoadedLocalization:T,DiffTextReason:be,itemDiffText:L,makeIntoText:G,DiffViewType:he,diffViewTypeOptions:ze,diffViewType:F,shouldShowDiffItemBody:Le,openDiffItems:U,toggleItemCollapsed:Se,isItemCollapsed:Oe,overviewFilterSets:Ie,overviewSortOptions:Me,emptyChangeOverviewMessage:De,localizationOptions:ke,localizationIds:ne,get diffLines(){return ve},computed:R,onBeforeMount:re,ref:A,watch:$,watchEffect:de,get useRoute(){return se},get useRouter(){return le},get useGameServerApi(){return ce},get MetaListFilterOption(){return W},get MetaListFilterSet(){return te},get MetaListSortDirection(){return J},get MetaListSortOption(){return q},get DisplayError(){return ee},get MBadge(){return Ae},get MIconButton(){return Be},get MInputSingleSelectSwitch(){return Pe},get MListItem(){return Re},get MPageOverviewCard(){return Te},get MTextButton(){return Ce},get MViewContainer(){return Ee},get useNotifications(){return ue},get useSubscription(){return K},LocalizationSelectOption:Ge,CoreUiPlacement:je,get extractSingleValueFromQueryStringOrUndefined(){return Z},get getSingleLocalizationSubscriptionOptions(){return pe},get getAllLocalizationsSubscriptionOptions(){return H}};return Object.defineProperty(oe,"__isScriptSetup",{enumerable:!1,value:!0}),oe}}),We={class:"hacked-height"},He={style:{"line-height":"1.5"}},Xe={class:"text-right tw-w-full"},Ze={class:"hacked-height"},$e={style:{"line-height":"1.5"}},et={class:"text-right tw-w-full"},tt={class:"tw-flex tw-items-center tw-justify-between"},nt=["id","onClick"],ot={class:"font-weight-bold mr-2"},it={key:3,class:"tw-ml-1 tw-text-xs tw-text-blue-400"},at={key:4,class:"mt-2"},st={class:"diff text-monospace"},lt={key:0},rt={key:1},dt={class:"added"},ct={key:2},ut={class:"removed"};function ft(l,n,B,e,V,z){const O=g("meta-input-select"),b=g("b-col"),p=g("fa-icon"),w=g("b-row"),P=g("meta-list-card"),Y=g("b-card-title"),X=g("b-card-body"),C=g("meta-lazy-loader"),x=g("b-list-group-item"),j=g("b-list-group"),N=g("b-card"),I=g("meta-raw-data");return c(),y(e.MViewContainer,{permission:"api.localization.view","is-loading":!e.activeLocalizationIdData||!e.allLocalizationData,error:e.loadingError,"full-width-overview":""},{overview:i(()=>[d(e.MPageOverviewCard,{title:"Compare Localizations Versions"},{default:i(()=>[n[7]||(n[7]=f("p",{class:"tw-mb-3"},"Select two localizations to compare the differences between them. You can view the differences in the full diff, or filter them to only show additions, removals, or modifications.",-1)),d(w,{"align-v":"center"},{default:i(()=>[d(b,{class:"tw-mb-4"},{default:i(()=>[f("div",We,[n[4]||(n[4]=f("h6",null,"Baseline localization",-1)),d(O,{value:e.baselineLocalizationId,options:e.localizationOptions,"no-clear":"",style:{height:"5rem"},onInput:n[0]||(n[0]=o=>e.baselineLocalizationId=o)},{option:i(({option:o})=>[o?(c(),y(e.LocalizationSelectOption,{key:0,localizationId:o},null,8,["localizationId"])):v("",!0)]),selectedOption:i(({option:o})=>[f("div",He,[o?(c(),y(e.LocalizationSelectOption,{key:0,localizationId:o},null,8,["localizationId"])):v("",!0)])]),_:1},8,["value","options"]),f("div",Xe,[f("small",null,[d(e.MTextButton,{to:`/localizations/${e.baselineLocalizationId}`},{default:i(()=>n[3]||(n[3]=[h("View baseline localization")]),void 0,!0),_:1},8,["to"])])])])],void 0,!0),_:1}),d(b,{class:"tw-mb-4 tw-text-center",md:"1"},{default:i(()=>[d(e.MIconButton,{variant:"primary","aria-label":"Swap the baseline and new localizations",onClick:e.swapLocalizations},{default:i(()=>[d(p,{icon:"right-left"})],void 0,!0),_:1})],void 0,!0),_:1}),d(b,{class:"tw-mb-4"},{default:i(()=>[f("div",Ze,[n[6]||(n[6]=f("h6",null,"New localization",-1)),d(O,{value:e.newLocalizationId,options:e.localizationOptions,"no-clear":"",style:{height:"5rem"},onInput:n[1]||(n[1]=o=>e.newLocalizationId=o)},{option:i(({option:o})=>[o?(c(),y(e.LocalizationSelectOption,{key:0,localizationId:o},null,8,["localizationId"])):v("",!0)]),selectedOption:i(({option:o})=>[f("div",$e,[o?(c(),y(e.LocalizationSelectOption,{key:0,localizationId:o},null,8,["localizationId"])):v("",!0)])]),_:1},8,["value","options"]),f("div",et,[f("small",null,[d(e.MTextButton,{to:`/localizations/${e.newLocalizationId}`},{default:i(()=>n[5]||(n[5]=[h("View new localization")]),void 0,!0),_:1},8,["to"])])])])],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1})]),default:i(()=>[d(e.CoreUiPlacement,{placementId:"Localizations/Diff"}),d(w,{class:"tw-mb-3","align-h":"center"},{default:i(()=>[d(b,{class:"tw-z-0",md:"7"},{default:i(()=>[d(P,{title:"Overview of changes",itemList:e.loadingState===e.LoadingState.Loading?void 0:e.items,searchFields:["displayName"],filterSets:e.overviewFilterSets,sortOptions:e.overviewSortOptions,emptyMessage:e.emptyChangeOverviewMessage,"page-size":15},{"item-card":i(o=>[d(e.MListItem,null,{default:i(()=>[o.item.reason===e.DiffItemReason.Added?(c(),y(e.MBadge,{key:0,class:"mr-2",variant:"success",tooltip:"Added"},{default:i(()=>n[8]||(n[8]=[h("A")]),void 0,!0),_:1})):v("",!0),o.item.reason===e.DiffItemReason.Removed?(c(),y(e.MBadge,{key:1,class:"mr-2",variant:"danger",tooltip:"Removed"},{default:i(()=>n[9]||(n[9]=[h("R")]),void 0,!0),_:1})):v("",!0),o.item.reason===e.DiffItemReason.Modified?(c(),y(e.MBadge,{key:2,class:"mr-2",variant:"primary",tooltip:"Modified"},{default:i(()=>n[10]||(n[10]=[h("M")]),void 0,!0),_:1})):v("",!0),f("span",null,k(o.item.displayName),1)],void 0,!0),_:2},1024)]),_:1},8,["itemList","filterSets","emptyMessage"])],void 0,!0),_:1})],void 0,!0),_:1}),e.items.length>0?(c(),y(N,{key:0,class:"shadow-sm mb-3 tw-mx-3","no-body":""},{default:i(()=>[d(X,null,{default:i(()=>[f("div",tt,[d(Y,{class:"tw-pt-3"},{default:i(()=>n[11]||(n[11]=[h("Detailed Changes")]),void 0,!0),_:1}),d(e.MInputSingleSelectSwitch,{"model-value":e.diffViewType,options:e.diffViewTypeOptions,"onUpdate:modelValue":n[2]||(n[2]=o=>e.diffViewType=o)},null,8,["model-value"])])],void 0,!0),_:1}),d(j,{class:"list-group-stripes",flush:""},{default:i(()=>[(c(!0),D(fe,null,me(e.items,(o,T)=>(c(),y(x,{key:o.anchorName},{default:i(()=>[d(C,{renderAfterDelayInMs:50},{default:i(()=>[f("div",{id:o.anchorName,style:{cursor:"pointer"},onClick:L=>e.toggleItemCollapsed(o.anchorName)},[f("span",{class:Ve({"not-collapsed":!e.isItemCollapsed(o.anchorName)})},[e.shouldShowDiffItemBody(o.reason)?(c(),y(p,{key:0,class:"mr-2",icon:"angle-right"})):v("",!0)],2),f("span",ot,k(o.languageName)+k(o.itemName!==""?".":"")+k(o.itemName),1),o.reason===e.DiffItemReason.Added?(c(),y(e.MBadge,{key:0,variant:"success"},{default:i(()=>n[12]||(n[12]=[h("Added")]),void 0,!0),_:1})):v("",!0),o.reason===e.DiffItemReason.Removed?(c(),y(e.MBadge,{key:1,variant:"danger"},{default:i(()=>n[13]||(n[13]=[h("Removed")]),void 0,!0),_:1})):v("",!0),o.reason===e.DiffItemReason.Modified?(c(),y(e.MBadge,{key:2,variant:"primary"},{default:i(()=>n[14]||(n[14]=[h("Modified")]),void 0,!0),_:1})):v("",!0),e.shouldShowDiffItemBody(o.reason)?(c(),D("span",it,k(e.isItemCollapsed(o.anchorName)?"Show":"Hide"),1)):v("",!0),!e.isItemCollapsed(o.anchorName)&&e.shouldShowDiffItemBody(o.reason)?(c(),D("div",at,[(c(!0),D(fe,null,me(e.itemDiffText(o.languageName,o.itemName),(L,G)=>(c(),D("div",st,[[e.DiffViewType.Diff,e.DiffViewType.Baseline,e.DiffViewType.Destination].includes(e.diffViewType)&&L.reason==e.DiffTextReason.Unchanged?(c(),D("div",lt,k(L.text),1)):v("",!0),[e.DiffViewType.Diff,e.DiffViewType.Additions,e.DiffViewType.Destination].includes(e.diffViewType)&&L.reason==e.DiffTextReason.Added?(c(),D("div",rt,[n[15]||(n[15]=f("span",{class:"text-success"},"+",-1)),n[16]||(n[16]=h()),f("span",dt,k(L.text.slice(2,L.text.length)),1)])):[e.DiffViewType.Diff,e.DiffViewType.Baseline].includes(e.diffViewType)&&L.reason==e.DiffTextReason.Removed?(c(),D("div",ct,[n[17]||(n[17]=f("span",{class:"text-danger"},"-",-1)),n[18]||(n[18]=h()),f("span",ut,k(L.text.slice(2,L.text.length)),1)])):v("",!0)]))),256))])):v("",!0)],8,nt)],void 0,!0),_:2},1024)],void 0,!0),_:2},1024))),128))],void 0,!0),_:1})],void 0,!0),_:1})):v("",!0),d(I,{kvPair:e.baselineLocalization,name:"baselineLocalization"},null,8,["kvPair"]),d(I,{kvPair:e.newLocalization,name:"newLocalization"},null,8,["kvPair"])],void 0,!0),_:1},8,["is-loading","error"])}const Ot=ye(Qe,[["render",ft],["__file","LocalizationDiffView.vue"]]);export{Ot as default};
