import{d as Y,x as R,af as I,f as c,c as B,ad as _,O as K,ai as Q,s as X,v as Z,a8 as $,ae as V,cj as N,b as s,o as l,e as S,w as a,p as r,k as n,n as i,a as g,l as T,t as f,_ as ee}from"./index-B7jvAjdE.js";import{C as F,p as L,c as A,a as z,b as G,d as j}from"./chart-DSWP3kjQ.js";import{M as te}from"./MActionModalButton-CvWVuTB-.js";import{M as ae}from"./MModal-CihxrIfO.js";import{a as ne,M as re}from"./MViewContainer-BTeE2xDT.js";import{M as ie}from"./MetaGeneratedForm-BcVgOIy3.js";import{C as oe}from"./CoreUiPlacement-CPf1fwrN.js";import{a as U,b as H}from"./matchmaking-3j4jzqL_.js";import{a as J}from"./players-CydHenLG.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";import"./MInputMultiSelectCheckbox-D_9f7ub1.js";import"./MInputCheckbox-BqateWtE.js";import"./index-B_QkKjtG.js";import"./MInputHintMessage-DbuBS4Kn.js";import"./GeneratedUiFormDynamicComponent-DrqrTIRR.js";const le=Y({__name:"MatchmakerDetailView",props:{matchmakerId:{}},setup(O,{expose:t}){t(),F.register(L,A,z,G,j);const o=O,{data:e,error:P,refresh:v}=R(U(o.matchmakerId));I().setDynamicTitle(e,m=>`Manage ${m.value?.data.name??"Matchmaker"}`);const C=c(),{refresh:k}=R(H(o.matchmakerId));async function d(){await _().post(`matchmakers/${o.matchmakerId}/reset`),v(),k()}const{showSuccessNotification:p}=V();async function w(){await _().post(`matchmakers/${o.matchmakerId}/rebalance`),p(`${o.matchmakerId} rebalanced successfully.`),v()}const h=c(null),D=c(!1),u=c(null),y=c(),b=c(!1);async function M(){try{b.value=!0;const m=await _().post(`matchmakers/${o.matchmakerId}/test`,h.value);if(u.value=m.data,u.value.response?.responseType==="Success"){const W=u.value.response.bestCandidate;y.value=await N(J(W))}b.value=!1}catch(m){u.value={response:{data:{error:m}}}}}const x=B(()=>e.value?.data.scannedPlayersCount&&e.value.data.playerScanErrorCount?e.value.data.playerScanErrorCount/e.value.data.scannedPlayersCount*100:0),q=B(()=>{const m=[];return x.value>5&&m.push({title:"Warning: Errors encountered",message:`The matchmaker encountered ${x.value.toFixed(2)}% error rate while scanning for players (${e.value?.data.playerScanErrorCount} out of ${e.value?.data.scannedPlayersCount} players scanned). See the server logs for more information.`,variant:"warning"}),m}),E={props:o,singleMatchmakerData:e,singleMatchmakerError:P,singleMatchmakerRefresh:v,simulateModal:C,topPlayersRefresh:k,resetMatchmaker:d,showSuccessNotification:p,rebalanceMatchmaker:w,simulationData:h,isSimulationFormValid:D,simulationResult:u,previewCandidateData:y,isSimulationRunning:b,simulateMatchmaking:M,scanningErrorRate:x,alerts:q,get ChartJS(){return F},get Title(){return L},get Tooltip(){return A},get BarElement(){return z},get CategoryScale(){return G},get LogarithmicScale(){return j},ref:c,computed:B,get useGameServerApi(){return _},get MActionModalButton(){return te},get MButton(){return K},get MModal(){return ae},get MErrorCallout(){return Q},get MList(){return X},get MListItem(){return Z},get MTextButton(){return $},get useHeaderbar(){return I},get MViewContainer(){return ne},get MPageOverviewCard(){return re},get useNotifications(){return V},get fetchSubscriptionDataOnceOnly(){return N},get useSubscription(){return R},MetaGeneratedForm:ie,CoreUiPlacement:oe,get getSingleMatchmakerSubscriptionOptions(){return U},get getTopPlayersOfSingleMatchmakerSubscriptionOptions(){return H},get getSinglePlayerSubscriptionOptions(){return J}};return Object.defineProperty(E,"__isScriptSetup",{enumerable:!1,value:!0}),E}}),se={class:"font-weight-bold"},de={class:"font-weight-bold"},me={key:0,class:"small text-muted"},ue={class:"font-weight-bold"},ce={class:"font-weight-bold"},ge={class:"font-weight-bold"},fe={class:"tw-mt-3 tw-flex tw-justify-end tw-gap-2"},pe={class:"tw-border-r-2 tw-border-neutral-200 tw-pr-4"},ke={key:0,class:"tw-text-xs tw-normal-case"},he={key:0,class:"tw-pt-3 tw-text-center tw-italic tw-text-neutral-400"},be={key:1},Me={key:2},ve={key:3,class:"tw-pt-4"},we={key:4,class:"tw-pt-3 tw-text-center tw-italic tw-text-neutral-400"};function ye(O,t,o,e,P,v){const C=s("meta-abbreviate-number"),k=s("fa-icon"),d=s("b-td"),p=s("b-tr"),w=s("b-tbody"),h=s("b-table-simple"),D=s("meta-time"),u=s("meta-plural-label"),y=s("b-alert"),b=s("meta-raw-data");return l(),S(e.MViewContainer,{"is-loading":!e.singleMatchmakerData,error:e.singleMatchmakerError,alerts:e.alerts,permission:"api.matchmakers.view"},{overview:a(()=>[e.singleMatchmakerData?(l(),S(e.MPageOverviewCard,{key:0,id:o.matchmakerId,title:e.singleMatchmakerData.data.name,subtitle:e.singleMatchmakerData.data.description,"data-testid":"matchmaker-overview-card"},{caption:a(()=>[t[2]||(t[2]=r("Save file size: ")),n(e.MTextButton,{permission:"api.database.inspect_entity",to:`/entities/${o.matchmakerId}/dbinfo`,"data-testid":"model-size-link"},{default:a(()=>[n(C,{value:e.singleMatchmakerData.data.stateSizeInBytes,unit:"byte"},null,8,["value"])],void 0,!0),_:1},8,["to"])]),buttons:a(()=>[i("div",fe,[n(e.MButton,{onClick:e.simulateModal?.open,"data-testid":"simulate-matchmaking-button"},{default:a(()=>t[13]||(t[13]=[r("Simulate")]),void 0,!0),_:1},8,["onClick"]),n(e.MModal,{ref:"simulateModal",title:"Simulate Matchmaking","data-testid":"simulate-matchmaking-modal"},{default:a(()=>[i("div",pe,[t[15]||(t[15]=i("p",null,"You can use this tool to preview the matches this matchmaker would return for a given matchmaking ranking (MMR).",-1)),n(e.MetaGeneratedForm,{class:"tw-mb-3",modelValue:e.simulationData,"onUpdate:modelValue":t[0]||(t[0]=M=>e.simulationData=M),typeName:e.singleMatchmakerData.queryJsonType,addTypeSpecifier:"",onStatus:t[1]||(t[1]=M=>e.isSimulationFormValid=M)},null,8,["modelValue","typeName"]),n(e.MButton,{"disabled-tooltip":e.isSimulationFormValid?void 0:"Please complete the form before simulating matchmaking.",onClick:e.simulateMatchmaking,"data-testid":"simulate-matchmaking-ok-button"},{default:a(()=>t[14]||(t[14]=[r("Simulate")]),void 0,!0),_:1},8,["disabled-tooltip"])])]),"right-panel":a(()=>[i("h5",null,[t[17]||(t[17]=r("Matchmaking Results ")),e.simulationResult?.numTries?(l(),g("span",ke,[t[16]||(t[16]=r("After ")),n(u,{value:e.simulationResult.numTries,label:"iteration"},null,8,["value"])])):T("",!0)]),e.isSimulationRunning?(l(),g("div",he,t[18]||(t[18]=[i("span",null,"Simulating...",-1)]))):e.simulationResult?.response?.data?.error?(l(),g("div",be,[n(e.MErrorCallout,{error:e.simulationResult.response.data.error},null,8,["error"])])):e.simulationResult?.response?.responseType==="Success"&&e.previewCandidateData?(l(),g("div",Me,[n(e.MList,{class:"tw-px-3",showBorder:"","data-testid":"simulation-results-list"},{default:a(()=>[n(e.MListItem,null,{"top-right":a(()=>[r(f(e.previewCandidateData.id),1)]),"bottom-right":a(()=>[n(e.MTextButton,{permission:"api.players.view",to:`/players/${e.simulationResult.response.bestCandidate}`},{default:a(()=>t[19]||(t[19]=[r("View player")]),void 0,!0),_:1},8,["to"])]),default:a(()=>[r(f(e.previewCandidateData.model.playerName),1)],void 0,!0),_:1})],void 0,!0),_:1})])):e.simulationResult?.response?.responseType?(l(),g("div",ve,t[20]||(t[20]=[i("p",null,"No matches found!",-1)]))):(l(),g("div",we,"Simulation not run yet."))]),_:1},512),n(e.MActionModalButton,{"modal-title":"Rebalance Matchmaker",action:e.rebalanceMatchmaker,"trigger-button-label":"Rebalance","ok-button-label":"Rebalance","ok-button-disabled-tooltip":e.singleMatchmakerData.data.hasEnoughDataForBucketRebalance?void 0:"This matchmaker does not have enough data to rebalance.",permission:"api.matchmakers.admin","data-testid":"rebalance-matchmaker"},{default:a(()=>[t[22]||(t[22]=i("p",null,"Rebalancing this matchmaker will re-distribute participants to the configured matchmaking buckets.",-1)),t[23]||(t[23]=i("p",{class:"text-muted small"},"Matchmakers automatically rebalance themselves over time. Manually triggering the rebalancing is mostly useful for manual testing during development.",-1)),n(y,{show:!e.singleMatchmakerData.data.hasEnoughDataForBucketRebalance,variant:"danger","data-testid":"rebalance-matchmaker-not-enough-data"},{default:a(()=>t[21]||(t[21]=[r("This matchmaker does not have enough data to rebalance. Please wait until the matchmaker has been populated with enough data from players.")]),void 0,!0),_:1},8,["show"])],void 0,!0),_:1},8,["ok-button-disabled-tooltip"]),n(e.MActionModalButton,{"modal-title":"Reset Matchmaker",action:e.resetMatchmaker,"trigger-button-label":"Reset","ok-button-label":"Reset",variant:"warning",permission:"api.matchmakers.admin","data-testid":"reset-matchmaker"},{default:a(()=>t[24]||(t[24]=[i("p",null,"Resetting this matchmaker will immediately re-initialize it.",-1),i("p",{class:"text-muted small"},"Resetting is safe to do in a production environment, but might momentarily degrade the matchmaking experience for live players as it takes a few minutes for the matchmaker to re-populate.",-1)]),void 0,!0),_:1})])]),default:a(()=>[i("div",se,[n(k,{icon:"chart-bar"}),t[3]||(t[3]=r(" Overview"))]),n(h,{small:"",responsive:""},{default:a(()=>[n(w,null,{default:a(()=>[n(p,null,{default:a(()=>[n(d,null,{default:a(()=>t[4]||(t[4]=[r("Number of participants")]),void 0,!0),_:1}),n(d,{class:"text-right"},{default:a(()=>[r(f(e.singleMatchmakerData.data.playersInBuckets),1)],void 0,!0),_:1})],void 0,!0),_:1}),n(p,null,{default:a(()=>[n(d,null,{default:a(()=>t[5]||(t[5]=[r("Current capacity")]),void 0,!0),_:1}),e.singleMatchmakerData?.data?.bucketsOverallFillPercentage>0?(l(),S(d,{key:0,class:"text-right"},{default:a(()=>[r(f(Math.round(e.singleMatchmakerData.data.bucketsOverallFillPercentage*1e4)/100)+"%",1)],void 0,!0),_:1})):(l(),S(d,{key:1,class:"text-right text-muted tw-italic"},{default:a(()=>t[6]||(t[6]=[r("None")]),void 0,!0),_:1}))],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1}),i("div",de,[n(k,{icon:"scale-unbalanced"}),t[7]||(t[7]=r(" Rebalancing"))]),n(h,{small:"",responsive:""},{default:a(()=>[n(w,null,{default:a(()=>[n(p,null,{default:a(()=>[n(d,null,{default:a(()=>t[8]||(t[8]=[r("Last rebalanced")]),void 0,!0),_:1}),n(d,{class:"tw-text-right"},{default:a(()=>[n(D,{date:e.singleMatchmakerData.data.lastRebalanceOperationTime},null,8,["date"])],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1})],void 0,!0),_:1}),e.singleMatchmakerData.data.playerScanErrorCount&&e.singleMatchmakerData.data.playerScanErrorCount>0?(l(),g("p",me,[t[9]||(t[9]=r("The matchmaker encountered (")),i("span",ue,f(e.scanningErrorRate.toFixed(2)),1),t[10]||(t[10]=r(")% error rate while scanning for players (")),i("span",ce,f(e.singleMatchmakerData.data.playerScanErrorCount),1),t[11]||(t[11]=r(" out of ")),i("span",ge,f(e.singleMatchmakerData.data.scannedPlayersCount),1),t[12]||(t[12]=r(" players scanned). See the server logs for more information."))])):T("",!0)],void 0,!0),_:1},8,["id","title","subtitle"])):T("",!0)]),default:a(()=>[n(e.CoreUiPlacement,{placementId:"Matchmakers/Details",matchmakerId:o.matchmakerId},null,8,["matchmakerId"]),n(b,{kvPair:e.singleMatchmakerData,name:"singleMatchmakerData"},null,8,["kvPair"])]),_:1},8,["is-loading","error","alerts"])}const Ae=ee(le,[["render",ye],["__file","MatchmakerDetailView.vue"]]);export{Ae as default};
