import{d as R,aa as P,f as b,c as h,C as A,x as G,ad as B,M as z,O as E,a0 as F,a8 as W,ae as x,a9 as L,cj as _,b as q,o as a,a as u,e as O,w as m,p as l,k as d,n as i,t as w,l as H,F as J,$ as K,_ as Q}from"./index-B7jvAjdE.js";import{M as X}from"./MActionModal-coQLkvWs.js";import{M as Y}from"./MInputSwitch-C-Z-JJsG.js";import{g as I,b as D}from"./gameConfigs-DlpfRS5r.js";const Z=R({__name:"GameConfigActionPublish",props:{gameConfigId:{},textButton:{type:Boolean},publishBlocked:{type:Boolean}},setup(y,{expose:e}){e();const g=B(),t=P(),r=y,k=b(),f=h(()=>{const s=c.value?.find(o=>o.id===r.gameConfigId);return s?(c.value??[]).filter(o=>!o.isArchived&&!(o.publishedAt!==null||o.unpublishedAt!==null||o.isActive)&&o.buildStartedAt<s.buildStartedAt).map(o=>o.id):[]}),n=b(!1),S=b(!1);A(()=>n.value,s=>{t.toggleAutoArchiveWhenPublishing(s)});const N=h(()=>v.value?.name??"No name available"),{data:c,refresh:T}=G(I()),v=h(()=>{if(c.value)return c.value.find(s=>s.id===r.gameConfigId)}),V=h(()=>v.value?.isActive?"This game config is already active.":v.value?.publishBlockingErrors.length??r.publishBlocked?"Cannot publish a game config that contains errors.":void 0),p=b();function U(){p.value=void 0,setTimeout(()=>{_(D(r.gameConfigId)).then(s=>{p.value=s.publishBlockingErrors.length>0})},1e3),n.value=t.autoArchiveWhenPublishing}const{showSuccessNotification:C}=x();async function j(){await g.post(`/gameConfig/publish?parentMustMatchActive=false&kickConnectedClients=${S.value}`,{Id:r.gameConfigId}),C("Game config published."),n.value&&f.value.length>0&&(await g.post("/gameConfig/archive",f.value),C(`Archived ${f.value.length} game configs.`)),window.location.reload()}const M={gameServerApi:g,uiStore:t,props:r,gameConfigPublishModal:k,archivableGameConfigIds:f,archiveOlderConfigs:n,kickConnectedClients:S,gameConfigName:N,allGameConfigsData:c,allGameConfigsRefresh:T,singleGameConfigWithoutContents:v,bestGuessDisallowPublishReason:V,validatedDisallowPublish:p,onShow:U,showSuccessNotification:C,publishConfig:j,computed:h,ref:b,watch:A,get useGameServerApi(){return B},get useUiStore(){return P},get MActionModal(){return X},get MBadge(){return z},get MButton(){return E},get MCallout(){return F},get MInputSwitch(){return Y},get MTextButton(){return W},get useNotifications(){return x},get maybePluralString(){return L},get fetchSubscriptionDataOnceOnly(){return _},get useSubscription(){return G},get getAllGameConfigsSubscriptionOptions(){return I},get getSingleGameConfigCountsSubscriptionOptions(){return D}};return Object.defineProperty(M,"__isScriptSetup",{enumerable:!1,value:!0}),M}}),$={key:0,class:"my-5 tw-w-full tw-text-center"},ee={key:1},te={key:2},ie={class:"tw-mb-1 tw-flex tw-justify-between"},ne={class:"small text-muted"},oe={key:0,class:"tw-ml-1"},ae={key:1,class:"tw-ml-1"},le={key:3,class:K(["tw-mt-4 tw-border tw-rounded-md tw-py-2 tw-px-3 tw-border-neutral-200 tw-bg-neutral-100 tw-text-neutral-600"])},se={class:"tw-mb-1 tw-flex tw-justify-between"},re={class:"tw-font-semibold"},ue={class:"small text-muted"};function de(y,e,g,t,r,k){const f=q("b-spinner");return a(),u(J,null,[g.textButton?(a(),O(t.MTextButton,{key:0,"disabled-tooltip":t.bestGuessDisallowPublishReason,permission:"api.game_config.edit",onClick:t.gameConfigPublishModal?.open},{default:m(()=>e[3]||(e[3]=[l("Publish")]),void 0,!0),_:1},8,["disabled-tooltip","onClick"])):(a(),O(t.MButton,{key:1,"disabled-tooltip":t.bestGuessDisallowPublishReason,permission:"api.game_config.edit","full-width":"",onClick:e[0]||(e[0]=n=>t.gameConfigPublishModal?.open())},{default:m(()=>e[4]||(e[4]=[l("Publish")]),void 0,!0),_:1},8,["disabled-tooltip"])),d(t.MActionModal,{ref:"gameConfigPublishModal",title:"Publish Game Config",action:t.publishConfig,"ok-button-label":"Publish Config","ok-button-disabled-tooltip":t.validatedDisallowPublish?"Cannot publish a game config that contains errors.":void 0,onShow:t.onShow},{default:m(()=>[t.validatedDisallowPublish===void 0?(a(),u("div",$,[e[5]||(e[5]=i("div",{class:"font-weight-bold"},"Validating Game Config",-1)),e[6]||(e[6]=i("div",{class:"small text-muted tw-mt-1"},"Please wait while we check that this config is valid for publishing.",-1)),d(f,{class:"tw-mt-3",label:"Validating..."})])):t.validatedDisallowPublish?(a(),u("div",ee,[d(t.MCallout,{title:"Cannot Publish Game Config",variant:"danger"},{default:m(()=>[e[10]||(e[10]=i("span",null,"This config cannot be validated for publishing because it contains errors.",-1)),i("span",null,[e[8]||(e[8]=l("Please view the ")),d(t.MTextButton,{to:`/gameConfigs/${g.gameConfigId}`},{default:m(()=>e[7]||(e[7]=[l("config's details page")]),void 0,!0),_:1},8,["to"]),e[9]||(e[9]=l(" to see the errors."))])],void 0,!0),_:1})])):(a(),u("div",te,[i("p",null,[e[11]||(e[11]=l("Publishing ")),d(t.MBadge,{variant:"neutral"},{default:m(()=>[l(w(t.gameConfigName),1)],void 0,!0),_:1}),e[12]||(e[12]=l(" will make it the active game config, effective immediately."))]),e[15]||(e[15]=i("p",{class:"small text-muted"},"Other people using the LiveOps Dashboard at the moment may be disrupted by the game data changing while they work, so make sure to let them know you are publishing an update!",-1)),i("div",ie,[e[13]||(e[13]=i("div",{class:"tw-font-semibold"},"Force Clients to Update",-1)),d(t.MInputSwitch,{"model-value":t.kickConnectedClients,size:"small","onUpdate:modelValue":e[1]||(e[1]=n=>t.kickConnectedClients=n)},null,8,["model-value"])]),i("p",ne,[e[14]||(e[14]=l("Players will download the new config the next time they login.")),t.kickConnectedClients?(a(),u("span",oe,"Currently live players will be immediately disconnected and forced to update to the new config.")):(a(),u("span",ae,"Currently live players will continue using the config they started with until the end of their current play session."))])])),(t.archivableGameConfigIds?.length??[])>0?(a(),u("div",le,[i("div",se,[i("div",re,"Archive "+w(t.maybePluralString(t.archivableGameConfigIds?.length,"Older Unpublished Config")),1),d(t.MInputSwitch,{"model-value":t.archiveOlderConfigs,size:"small","onUpdate:modelValue":e[2]||(e[2]=n=>t.archiveOlderConfigs=n)},null,8,["model-value"])]),i("div",ue,"At the same time as publishing this game config, you can also automatically archive "+w(t.maybePluralString(t.archivableGameConfigIds?.length,"older unpublished config"))+". This is useful in keeping your game config history manageable.",1)])):H("",!0)],void 0,!0),_:1},8,["ok-button-disabled-tooltip"])],64)}const be=Q(Z,[["render",de],["__file","GameConfigActionPublish.vue"]]);export{be as G};
