import{ak as T,d as R,f as b,c as M,h as U,cj as j,M as W,ac as X,ai as Z,b as K,o as r,e as k,w as v,k as P,a as o,n as w,t as m,p as I,l as x,F as y,r as C,$ as L,bd as A,_ as $}from"./index-B7jvAjdE.js";import{b as Y,c as q}from"./gameConfigs-DlpfRS5r.js";function D(p,c){if(p===null)return[];const s=[];function e(S,N,f){S.forEach(u=>{const a=`${N}${u.title}`,_=u.children&&u.children.length>0,n=_&&c.includes(a),B={path:a,indentation:f,title:u.title,subtitle:u.subtitle??void 0,type:u.type,values:u.values,differences:u.differences??void 0,clickAction:n?"Collapse":_?"Expand":void 0};s.push(B),n&&u.children&&e(u.children,a+":",f+1)})}return e(p,"",0),s}function H(p){const c={Build:"This error is most likely caused by an issue in the source data.",Import:"This game config could not be imported successfully with the current server deployment. This is most likely caused by code changes."};if(p.errorType==="Exception"){const s=p;return new T("Exception",s.message,s.phaseType,c[s.phaseType],[{title:"Exception Type",content:s.exceptionType},{title:"Full Exception",content:s.fullException}])}else if(p.errorType==="LibraryImport"){const s=p;return new T("Unexpected Error","Unexpected error.",s.phaseType,c[s.phaseType])}else if(p.errorType==="StringException"){const s=p;return new T("Exception","An exception occurred.",s.phaseType,c[s.phaseType],[{title:"Full Exception",content:s.fullException}])}else if(p.errorType==="TaskDisappeared"){const s=p;return new T("Task Disappeared","The build task mysteriously disappeared, likely due to the server stopping or crashing.",s.phaseType,c[s.phaseType])}else if(p.errorType==="BlockingMessages"){const s=p;return new T("Blocking Messages","The build or validation logs contain errors. Please resolve them and try building again.",s.phaseType,c[s.phaseType])}else{const s=p;return new T("Unknown Error","Unknown error type",s.phaseType,c[s.phaseType],[{title:"Source Error",content:p}])}}const ee=R({__name:"ConfigContentsCard",props:{gameConfigId:{default:"$active"},experimentId:{default:"Baseline"},showExperimentSelector:{type:Boolean},hideNoDiffs:{type:Boolean},excludeServerLibraries:{type:Boolean}},setup(p,{expose:c}){c();const s=p,e=b([]),S=b(),N=M(()=>s.hideNoDiffs?e.value.filter(t=>f.value[n.value].patchedLibraries.includes(t.id)):e.value);U(async()=>{await j(Y(s.gameConfigId)).then(t=>{let l={...t.contents.sharedLibraries};s.excludeServerLibraries||(l={...l,...t.contents.serverLibraries}),f.value={Baseline:{displayName:"Baseline",variants:[],patchedLibraries:[]}},Object.values(t.experiments).forEach(d=>{const i=d.id,h={displayName:d.displayName,variants:d.variants,patchedLibraries:d.patchedLibraries};f.value[i]=h}),e.value=Object.keys(l).sort((d,i)=>d.localeCompare(i)).filter(d=>t.libraryImportErrors&&t.libraryImportErrors[d]===void 0).map(d=>({id:d,numTopLevelItems:l[d]})),Object.entries(t.libraryImportErrors??[]).forEach(([d,i])=>{e.value.push({id:d,error:H(i)})}),e.value=e.value.sort((d,i)=>d.id.localeCompare(i.id))}).catch(t=>{S.value=t})});const f=b({}),u=b({});async function a(t,l){const d=e.value.find(h=>h.id===t);if(d===void 0||d.error)return;u.value[t]=u.value[t]||{experimentConfigItems:{},flattenedConfigItems:[]};const i=u.value[t];if(i.experimentConfigItems[l]){if(V(t)){const h=i.experimentConfigItems[n.value];i.flattenedConfigItems=D(h,g[t]||[])}}else i.experimentConfigItems[l]===void 0&&(i.experimentConfigItems[l]=null,await j(q(s.gameConfigId,t,l==="Baseline"?void 0:l)).then(h=>{const z=h.config[t].children??[];i.experimentConfigItems[l]=z,V(t)&&(i.flattenedConfigItems=D(z,g[t]||[]))}).catch(h=>{d.error=h}))}const _=b(s.experimentId),n=M(()=>_.value??"Baseline"),B=M(()=>Object.keys(f.value).filter(t=>t!=="Baseline").map(t=>({id:t,value:{experimentId:t,displayName:f.value[t].displayName}})));function O(t){_.value=t?.experimentId,E.value.forEach(l=>{if(!e.value.find(i=>i.id===l)?.error){const i=u.value[l];if(i.flattenedConfigItems=[],i.experimentConfigItems[n.value]){const h=i.experimentConfigItems[n.value];i.flattenedConfigItems=D(h,g[l]||[])}else a(l,n.value)}})}const F=M(()=>f.value[n.value].variants),E=b([]);function V(t){return E.value.includes(t)}function J(t){V(t)?E.value=E.value.filter(l=>l!==t):(E.value.push(t),a(t,n.value))}const g={};function Q(t,l){const d=g[t];d?d.includes(l)?g[t]=g[t].filter(h=>h!==l):g[t].push(l):g[t]=[l];const i=u.value[t];i.flattenedConfigItems=D(i.experimentConfigItems[n.value],g[t])}const G={props:s,libraries:e,error:S,librariesToShow:N,allExperiments:f,libraryContents:u,tryLoadLibrary:a,selectedExperimentIdInput:_,selectedExperimentId:n,experimentSelectionOptions:B,onSelectedExperimentIdChanged:O,selectedExperimentVariantIds:F,expandedLibraries:E,isLibraryExpanded:V,toggleLibraryExpanded:J,expandedPaths:g,togglePathExpanded:Q,computed:M,ref:b,onMounted:U,get MBadge(){return W},get MCard(){return X},get MErrorCallout(){return Z},get fetchSubscriptionDataOnceOnly(){return j},get flattenLibraryConfigItems(){return D},get gameConfigErrorToDisplayError(){return H},get getSingleGameConfigCountsSubscriptionOptions(){return Y},get getSingleGameConfigLibraryContentSubscriptionOptions(){return q}};return Object.defineProperty(G,"__isScriptSetup",{enumerable:!1,value:!0}),G}}),te={key:0},ne={key:1,class:"text-sm"},re={key:0,class:"tw-my-auto tw-px-3 tw-py-10 tw-text-center tw-text-neutral-400"},se={key:0},oe={key:1},ae={key:1,class:"tw-overflow-x-auto"},ie={class:"tw-w-full"},le={key:0,class:"tw-h-4"},de=["onClick"],ce={class:"tw-inline-flex tw-items-center tw-p-2"},ue={class:"tw-ml-2 tw-font-semibold"},pe={class:"tw-px-2 tw-text-right"},fe={key:0},he={key:0,class:"tw-p-0",colspan:"999"},we={class:"tw-border-x tw-border-neutral-200 tw-text-xs"},me={class:"tw-font-light tw-text-neutral-600"},xe={key:0,class:"tw-border-x tw-border-b tw-border-neutral-200"},ge={key:1,class:"tw-border-x tw-border-b tw-border-neutral-200"},ve=["onClick"],ye={class:"tw-mr-1 tw-font-mono"},_e={key:2,class:"tw-mr-1 tw-text-neutral-400"},be={class:"tw-break-words tw-border-l tw-border-neutral-200 tw-pl-2 tw-pt-0.5"},ke={key:0},Ce={key:0},Ee={key:1,class:"tw-italic tw-text-orange-400"},Te={key:0};function Ie(p,c,s,e,S,N){const f=K("fa-icon"),u=K("meta-input-select");return r(),k(e.MCard,{title:"Game Config Contents",isLoading:e.libraries.length===0,error:e.error,"data-testid":"game-config-contents-card"},{icon:v(()=>[P(f,{icon:"table"})]),"header-right":v(()=>[e.error?x("",!0):(r(),o("div",te,[s.showExperimentSelector?(r(),k(u,{key:0,value:e.selectedExperimentIdInput,options:e.experimentSelectionOptions,searchFields:["displayName","experimentId"],placeholder:"Select an experiment...",onInput:c[0]||(c[0]=a=>e.onSelectedExperimentIdChanged(a))},{option:v(({option:a})=>[w("div",null,m(a===void 0?"error":`${a.displayName} / ${a.experimentId}`),1)]),_:1},8,["value","options"])):(r(),o("div",ne,[c[1]||(c[1]=I("Showing variants from ")),P(e.MBadge,{variant:"primary"},{default:v(()=>[I(m(e.selectedExperimentId),1)],void 0,!0),_:1})]))]))]),default:v(()=>[s.hideNoDiffs&&e.librariesToShow.length===0?(r(),o("div",re,[e.selectedExperimentId==="Baseline"?(r(),o("span",se,"You have not selected an experiment, so there are no differences to the baseline configuration to display.")):(r(),o("span",oe,"The selected experiment contains no differences to the baseline configuration."))])):(r(),o("div",ae,[w("table",ie,[(r(!0),o(y,null,C(e.librariesToShow,(a,_)=>(r(),o("tbody",{key:a.id},[_>0?(r(),o("tr",le)):x("",!0),w("tr",{class:"tw-cursor-pointer tw-border tw-border-neutral-200 tw-bg-neutral-100 tw-font-normal hover:tw-bg-neutral-200 active:tw-bg-neutral-300",onClick:n=>e.toggleLibraryExpanded(a.id),"data-testid":"library-title-row"},[w("td",ce,[P(f,{icon:"angle-right",class:L({"tw-rotate-90":e.isLibraryExpanded(a.id)})},null,8,["class"]),w("span",ue,m(a.id),1),a.error?(r(),k(e.MBadge,{key:1,class:"tw-ml-2 tw-text-xs",variant:"danger",shape:"pill"},{default:v(()=>c[2]||(c[2]=[I("Error")]),void 0,!0),_:1})):(r(),k(e.MBadge,{key:0,class:"tw-ml-2 tw-text-xs",variant:e.isLibraryExpanded(a.id)?"primary":"neutral",shape:"pill"},{default:v(()=>[I(m(a.numTopLevelItems),1)],void 0,!0),_:2},1032,["variant"]))]),(r(!0),o(y,null,C(e.selectedExperimentVariantIds.length+1,n=>(r(),o("td",pe,[n===e.selectedExperimentVariantIds.length+1?(r(),o("span",fe,[e.allExperiments[e.selectedExperimentId].patchedLibraries.includes(a.id)?(r(),k(e.MBadge,{key:0,size:"small",variant:"primary"},{default:v(()=>c[3]||(c[3]=[I("Variants")]),void 0,!0),_:1})):x("",!0)])):x("",!0)]))),256))],8,de),e.isLibraryExpanded(a.id)?(r(),o(y,{key:1},[a.error?(r(),o("td",he,[P(e.MErrorCallout,{class:"tw-rounded-none",error:a.error},null,8,["error"])])):(r(),o(y,{key:1},[w("tr",we,[w("th",{class:"tw-pl-2",style:A(e.selectedExperimentId!=="Baseline"?{"min-width":"14rem"}:{"min-width":""})},"Key",4),w("th",{class:"tw-border-l tw-border-neutral-200 tw-pl-2",style:A(e.selectedExperimentId!=="Baseline"?{"max-width":"9rem"}:{"max-width":""})},m(e.selectedExperimentVariantIds.length===0?"Value":"Control"),5),(r(!0),o(y,null,C(e.selectedExperimentVariantIds,n=>(r(),o("th",{class:"tw-border-l tw-border-neutral-200 tw-pl-2",key:n},[w("div",me,m(e.allExperiments[e.selectedExperimentId].displayName),1),w("div",null,m(n),1)]))),128))]),!e.libraryContents[a.id]||e.libraryContents[a.id].experimentConfigItems[e.selectedExperimentId]===null?(r(),o("tr",xe,[(r(!0),o(y,null,C(e.selectedExperimentVariantIds.length+2,n=>(r(),o("td",{class:L(["tw-px-2 tw-text-xs tw-italic tw-text-neutral-400 tw-border-neutral-200 tw-border-t",{"tw-border-l":n>1}])},"Loading...",2))),256))])):e.libraryContents[a.id].flattenedConfigItems.length===0?(r(),o("tr",ge,[(r(!0),o(y,null,C(e.selectedExperimentVariantIds.length+2,n=>(r(),o("td",{class:L(["tw-px-2 tw-text-xs tw-italic tw-text-neutral-400 tw-border-neutral-200 tw-border-t",{"tw-border-l":n>1}])},"Library is empty.",2))),256))])):(r(!0),o(y,{key:2},C(e.libraryContents[a.id].flattenedConfigItems,(n,B)=>(r(),o("tr",{key:n.path,class:L(["tw-text-xs tw-font-mono hover:tw-bg-neutral-50 tw-border-x tw-border-neutral-200",{"tw-border-t":n.indentation===0,"tw-border-b":B===e.libraryContents[a.id].flattenedConfigItems.length-1}])},[w("td",{class:L(["tw-pl-2 tw-pt-0.5",{"tw-cursor-pointer hover:tw-bg-neutral-200 active:tw-bg-neutral-300":n.clickAction}]),onClick:O=>n.clickAction?e.togglePathExpanded(a.id,n.path):null},[n.indentation>=1?(r(),o("span",{key:0,class:"tw-mr-1 tw-text-neutral-700",style:A(`padding-left: ${.8*(n.indentation-1)}rem`)},"┗━",4)):x("",!0),n.clickAction?(r(),k(f,{key:1,icon:"angle-right",class:L(["tw-mr-1",{"tw-rotate-90":e.expandedPaths[a.id]?.includes(n.path)}])},null,8,["class"])):x("",!0),w("span",ye,m(n.title),1),n.subtitle?(r(),o("span",_e,m(n.subtitle),1)):x("",!0),n.differences?(r(),k(e.MBadge,{key:3,class:"tw-relative",size:"small",style:{bottom:"0.1rem"},variant:"primary"},{default:v(()=>c[4]||(c[4]=[I("V")]),void 0,!0),_:1})):x("",!0)],10,ve),w("td",be,[n.values?(r(),o("span",ke,[n.values.Baseline!==void 0?(r(),o("span",Ce,m(n.values.Baseline),1)):(r(),o("span",Ee,"missing"))])):x("",!0)]),(r(!0),o(y,null,C(e.selectedExperimentVariantIds,(O,F)=>(r(),o("td",{class:"tw-break-words tw-border-l tw-border-neutral-200 tw-pl-2 tw-pt-0.5",key:n.path},[n.values?(r(),o("span",Te,m(n.values[`${e.selectedExperimentId}.${O}`]),1)):x("",!0)]))),128))],2))),128))],64))],64)):x("",!0)]))),128))])]))],void 0,!0),_:1},8,["isLoading","error"])}const Be=$(ee,[["render",Ie],["__file","ConfigContentsCard.vue"]]);export{Be as C,H as g};
