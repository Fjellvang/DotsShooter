import{d as L,x as I,f as n,c as B,cI as k,ad as N,M as Y,a0 as K,ai as Q,ak as g,ae as D,b as W,o as d,e as b,B as X,w as v,k as E,n as o,p as c,t as F,a as T,F as Z,r as $,l as w,_ as ee}from"./index-B7jvAjdE.js";import{M as te}from"./MActionModalButton-CvWVuTB-.js";import{M as ae}from"./MInputSingleFileContents-tOi-WM9p.js";import{M as re}from"./MInputTextArea-BMdoSBpm.js";import{a as j}from"./players-CydHenLG.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";import"./MInputSingleFile-Dbi3mt5D.js";import"./MInputHintMessage-DbuBS4Kn.js";import"./debounce-B8gTqdZO.js";import"./isSymbol-B7ZrWRtH.js";const ie=L({__name:"PlayerActionOverwrite",props:{playerId:{}},setup(_,{expose:a}){a();const x=_,e=N(),{data:p,refresh:M}=I(j(x.playerId)),u=n(""),y=n(),l=n(),m=n(!1),A=n(),s=n(),f=n(),G=B(()=>{const r=u.value!==""||y.value;return!r||r&&!s.value&&!l.value?null:!!(l.value&&m.value)});function R(r){u.value=r,C(r)}function U(r){y.value=r,C(r)}function q(){u.value="",y.value=void 0,l.value=void 0,m.value=!1,s.value=void 0}async function C(r){if(s.value=void 0,l.value=void 0,A.value=void 0,m.value=!1,r){let t;try{t=S(r)}catch(i){s.value=new g("Calculating payload failed",i.message);return}try{f.value&&f.value.cancel("Request canceled by user interaction."),f.value=k.CancelToken.source();const i=(await e.post(`/players/${p.value.id}/validateOverwrite`,t,{cancelToken:f.value.token})).data;i.error?s.value=new g("Validation failed",i.error.message,500,void 0,[{title:"Details",content:i.error.details}]):i.data.diff===""?l.value=`No differences in player model data.
Did you paste in the correct player?`:(l.value=i.data.diff,m.value=!0)}catch(i){k.isCancel(i)||i.response&&(s.value=new g("Validaiton failed",i.response.data.error.message))}}}const{showSuccessNotification:V}=D();async function z(r){const t=S(r);await e.post(`/players/${p.value.id}/importOverwrite`,t),V("Player import succeeded."),M()}function S(r){let t;try{t=JSON.parse(r)}catch(h){throw new Error(`Could not parse archive. Got '${h.message}'.`)}if(typeof t!="object")throw new Error(`Entity archive must be an object. Got '${typeof t}'.`);if(Array.isArray(t))throw new Error("Entity archive must be an object. Got 'array'.");if(!("entities"in t))throw new Error("Entity archive must contain entities but none found.");if(!("player"in t.entities))throw new Error("Entity archive must contain player entities but none found.");const i=Object.keys(t.entities.player);if(i.length!==1)throw new Error(`Entity archive may only contain exactly one player entity. Got ${i.length}.`);const P=Object.keys(t.entities).filter(h=>h!=="player");P.forEach(h=>delete t.entities[h]),P.length&&(A.value=P);const H=i[0],J=p.value.id;return t.remaps={player:{}},t.remaps.player[H]=J,t}const O={props:x,gameServerApi:e,playerData:p,playerRefresh:M,entityArchiveText:u,entityArchiveFile:y,validationResultString:l,playerModelValidToOverwrite:m,entityContainedExtraTypes:A,displayError:s,cancelTokenSource:f,isFormValid:G,onEntityArchiveTextChange:R,onEntityArchiveFileChange:U,resetModal:q,validatePlayer:C,showSuccessNotification:V,overwritePlayer:z,calculatePayload:S,get axios(){return k},computed:B,ref:n,get useGameServerApi(){return N},get MActionModalButton(){return te},get MBadge(){return Y},get MInputTextArea(){return re},get MInputSingleFileContents(){return ae},get MCallout(){return K},get MErrorCallout(){return Q},get DisplayError(){return g},get useNotifications(){return D},get useSubscription(){return I},get getSinglePlayerSubscriptionOptions(){return j}};return Object.defineProperty(O,"__isScriptSetup",{enumerable:!1,value:!0}),O}}),ne={class:"tw-mb-2"},oe={class:"tw-mr-1"},le={key:3},se={class:"code-box text-monospace border rounded bg-light tw-w-full",style:{"max-height":"20.3rem"}};function de(_,a,x,e,p,M){const u=W("meta-no-seatbelts");return e.playerData?(d(),b(e.MActionModalButton,{key:0,"modal-title":"Overwrite Player",action:()=>e.overwritePlayer(e.entityArchiveFile??e.entityArchiveText),"trigger-button-label":"Overwrite Player",variant:"danger","ok-button-label":"Overwrite Player","ok-button-disabled-tooltip":e.isFormValid?void 0:"Paste in or upload a valid player to proceed.",permission:"api.players.overwrite",onShow:e.resetModal,onHidden:e.resetModal,"data-testid":"action-overwrite-player"},X({default:v(()=>[a[2]||(a[2]=o("h6",{class:"tw-mb-1"},"Paste Player Data",-1)),o("p",ne,[a[0]||(a[0]=c("You can copy & paste the serialized data of a compatible player here to overwrite parts of ")),E(e.MBadge,null,{default:v(()=>[c(F(e.playerData.model.playerName||"n/a"),1)],void 0,!0),_:1}),a[1]||(a[1]=c("."))]),a[3]||(a[3]=o("p",{class:"tw-mb-4"},[c("This is an "),o("span",{class:"tw-text-danger"},"advanced development feature"),c(" and should probably never be used in production!")],-1)),E(e.MInputTextArea,{class:"tw-mb-2",label:"Paste in an archive...","model-value":e.entityArchiveText,placeholder:e.entityArchiveFile!=null?"File upload selected":"{'entities':{'player':...",variant:e.isFormValid!==null?e.isFormValid?"success":"danger":"default",rows:5,disabled:!!e.entityArchiveFile,"onUpdate:modelValue":e.onEntityArchiveTextChange,"data-testid":"entity-archive-text"},null,8,["model-value","placeholder","variant","disabled"]),E(e.MInputSingleFileContents,{label:"...or upload a file...","model-value":e.entityArchiveFile,placeholder:e.entityArchiveText!==""?"Manual paste selected":"Choose or drop an entity archive file",variant:e.isFormValid!==null?e.isFormValid?"success":"danger":"default",disabled:e.entityArchiveText!=="","accepted-file-types":".json","onUpdate:modelValue":e.onEntityArchiveFileChange,"data-testid":"entity-archive-file"},null,8,["model-value","placeholder","variant","disabled"])]),"right-panel":v(()=>[a[6]||(a[6]=o("h6",{class:"tw-mb-4"},"Preview Incoming Data",-1)),e.entityContainedExtraTypes?(d(),b(e.MCallout,{key:0,class:"tw-mb-2",title:"Extra Entity Types",variant:"warning"},{default:v(()=>[o("p",null,[a[4]||(a[4]=c("Archive contained the following extra entity types that were removed: ")),(d(!0),T(Z,null,$(e.entityContainedExtraTypes,y=>(d(),T("span",oe,F(y),1))),256))])],void 0,!0),_:1})):w("",!0),!e.validationResultString&&!e.displayError?(d(),b(e.MCallout,{key:1,class:"tw-mb-2",title:"Preview",variant:"neutral"},{default:v(()=>a[5]||(a[5]=[c("Paste in a valid player from a compatible game version to preview what data will be copied over.")]),void 0,!0),_:1})):w("",!0),e.displayError?(d(),b(e.MErrorCallout,{key:2,class:"tw-mb-2",error:e.displayError},null,8,["error"])):w("",!0),e.validationResultString?(d(),T("div",le,[o("div",se,[o("pre",null,F(e.validationResultString),1)])])):w("",!0)]),_:2},[e.isFormValid?{name:"bottom-panel",fn:v(()=>[E(u,{class:"tw-mx-auto tw-w-7/12",name:e.playerData.model.playerName||"n/a"},null,8,["name"])]),key:"0"}:void 0]),1032,["action","ok-button-disabled-tooltip"])):w("",!0)}const Ee=ee(ie,[["render",de],["__file","PlayerActionOverwrite.vue"]]);export{Ee as default};
