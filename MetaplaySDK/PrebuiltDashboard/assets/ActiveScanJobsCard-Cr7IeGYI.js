import{d as B,x as M,f as C,c as j,ad as J,q as N,L,M as V,v as q,bN as E,ae as T,b as l,o as r,e as k,w as o,k as i,B as P,n as c,l as x,p as s,t as u,a as m,_ as R}from"./index-B7jvAjdE.js";import{M as D}from"./MActionModal-coQLkvWs.js";import{g as A}from"./scanJobs-A4fyB_UL.js";import"./index-fVjXqxSF.js";const K=B({__name:"ActiveScanJobsCard",setup(w,{expose:n}){n();const{data:b,refresh:e}=M(A()),_=C(),v=J(),p=j(()=>{const a=b.value.activeJobs,I=b.value.upcomingJobs;return a.concat(I)});function g(a){return a.phase==="Paused"?"danger":a.phase==="Running"?"success":a.phase==="Enqueued"?"warning":a.phase==="Scheduled"?"primary":"neutral"}const{showSuccessNotification:f}=T(),d=C();async function S(){const a=(await v.put(`/databaseScanJobs/${d.value.id}/cancel`)).data;f(a.message),e()}function t(a){d.value=a,_.value?.open(a)}function y(a){return a.id}const h={allScanJobsData:b,allScanJobsRefresh:e,cancelScanJobsModal:_,gameServerApi:v,activeAndEnqueuedJobs:p,getJobVariant:g,showSuccessNotification:f,jobToCancel:d,cancelScanJob:S,onCancelScanJobClick:t,getItemKey:y,computed:j,ref:C,get useGameServerApi(){return J},get MCollapse(){return N},get MTooltip(){return L},get MBadge(){return V},get MListItem(){return q},get MIconButton(){return E},get MActionModal(){return D},get useNotifications(){return T},get useSubscription(){return M},get getAllScanJobsSubscriptionOptions(){return A}};return Object.defineProperty(h,"__isScriptSetup",{enumerable:!1,value:!0}),h}}),O={class:"tw-space-x-0.5"},U={key:0},G={key:0},F={key:1},H={class:"code-box border rounded bg-light"},W={key:0},z={key:1};function Q(w,n,b,e,_,v){const p=l("fa-icon"),g=l("meta-time"),f=l("meta-abbreviate-number"),d=l("meta-no-seatbelts"),S=l("meta-list-card");return r(),k(S,{icon:"business-time",title:"Active Scan Jobs",itemList:e.activeAndEnqueuedJobs,getItemKey:e.getItemKey,emptyMessage:"No active scan jobs.","data-testid":"active-scan-jobs-card"},{"item-card":o(t=>[i(e.MCollapse,{extraMListItemMargin:"","data-testid":"scan-jobs-entry"},{header:o(()=>[i(e.MListItem,{noLeftPadding:""},P({"top-right":o(()=>[c("span",O,[i(e.MTooltip,{content:t.item.canCancel&&!e.jobToCancel?"Cancel this scan job.":void 0,"no-underline":""},{default:o(()=>[i(e.MIconButton,{variant:"danger","disabled-tooltip":t.item.cannotCancelReason,permission:"api.scan_jobs.manage","aria-label":"Cancel this scan job.",onClick:y=>e.onCancelScanJobClick(t.item),"data-testid":"cancel-scan-job-button"},{default:o(()=>[i(p,{icon:"trash-alt"})],void 0,!0),_:2},1032,["disabled-tooltip","onClick"])],void 0,!0),_:2},1032,["content"]),t.item.anyWorkersFailed?(r(),k(e.MTooltip,{key:0,class:"mr-2 text-danger",content:"Some workers failed during this job.",noUnderline:""},{default:o(()=>[i(p,{icon:"triangle-exclamation"})],void 0,!0),_:1})):x("",!0),i(e.MBadge,{variant:e.getJobVariant(t.item)},{default:o(()=>[s(u(t.item.phase),1)],void 0,!0),_:2},1032,["variant"])])]),"bottom-left":o(()=>[t.item.phaseCategory==="Upcoming"?(r(),m("div",U,[s(u(t.item.jobDescription),1),t.item.startTime?(r(),m("div",G,[n[1]||(n[1]=s("Scheduled to start ")),i(g,{date:t.item.startTime},null,8,["date"]),n[2]||(n[2]=s("."))])):x("",!0)])):(r(),m("div",F,[n[3]||(n[3]=s("Started ")),i(g,{date:t.item.startTime},null,8,["date"]),n[4]||(n[4]=s("."))]))]),default:o(()=>[s(u(t.item.jobTitle),1)],void 0,!0),_:2},[t.item.phaseCategory==="Active"?{name:"bottom-right",fn:o(()=>[c("div",null,[n[5]||(n[5]=s("Items scanned: ")),i(f,{value:t.item.scanStatistics.numItemsScanned},null,8,["value"])]),c("div",null,"Progress: "+u(Math.round(t.item.scanStatistics.scannedRatioEstimate*1e4)/100)+"%",1)]),key:"0"}:void 0]),1024)]),default:o(()=>[c("pre",H,u(t.item),1)],void 0,!0),_:2},1024),i(e.MActionModal,{ref:"cancelScanJobsModal",title:`Cancel ${e.jobToCancel?.jobTitle}`,action:e.cancelScanJob,onHidden:n[0]||(n[0]=y=>e.jobToCancel=null),"data-testid":"cancel-scan-job-modal"},{default:o(()=>[e.jobToCancel.phaseCategory==="Upcoming"?(r(),m("div",W,n[6]||(n[6]=[c("p",null,"This job has not yet been started. Cancelling an upcoming job will delete it, and it will not appear in the job history list.",-1),c("p",{class:"tw-mt-2 tw-text-xs+ tw-text-neutral-500"},"Note: The job may already be in progress by the time the request is processed.",-1)]))):(r(),m("p",z,"This job has been started and may already have executed partially. Cancelling an active job will terminate it as soon as possible and move it into the job history list.")),i(d,{class:"tw-mt-2",message:"Are you sure you want to cancel this scan job?"})],void 0,!0),_:1},8,["title"])]),_:1},8,["itemList"])}const ee=R(K,[["render",Q],["__scopeId","data-v-9c2ea047"],["__file","ActiveScanJobsCard.vue"]]);export{ee as default};
