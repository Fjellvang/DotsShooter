import{d as te,z as V,a6 as q,x as j,f as G,c as L,a9 as z,N as B,ad as Q,M as ne,q as ie,s as se,v as re,a8 as ae,L as oe,ae as U,b as D,o as s,a as l,k as a,w as n,e as p,p as r,l as m,t as u,n as f,F as Y,r as J,_ as de}from"./index-B7jvAjdE.js";import{M as le}from"./MActionModalButton-CvWVuTB-.js";import{M as b,a as v}from"./metaListUtils-B-xQ0HnD.js";import{a as W}from"./players-CydHenLG.js";import"./MActionModal-coQLkvWs.js";import"./index-fVjXqxSF.js";const ue=te({__name:"PlayerSubscriptionHistoryCard",props:{playerId:{}},setup(E,{expose:e}){e();const I=E,t=Q(),N=V(),k=q(),{data:o,refresh:x}=j(W(I.playerId)),P=[new b("Start time","startTime",v.Ascending),new b("Start time","startTime",v.Descending),new b("Expiry time","expirationTime",v.Ascending),new b("Expiry time","expirationTime",v.Descending)],i=G({}),d=L(()=>k.featureFlags.removeIapSubscriptions||o.value.model.isDeveloper),M=L(()=>{const c={};for(const y of o.value.model.inAppPurchaseHistory){if(y.subscriptionQueryResult===null)continue;const S=y.originalTransactionId;c[S]=y}const C=[];for(const y in o.value.model.iapSubscriptions.subscriptions){const S=o.value.model.iapSubscriptions.subscriptions[y];let R=0;const K={};for(const h in S.subscriptionInstances){const _=S.subscriptionInstances[h],F=c[h],ee=F?.platform,A=F?.referencePrice??0;let w,T;if(_.disabledDueToReuse)w=0,T="Spend is omitted from this subscription, because it is being used on another player account.";else if(_.lastKnownState?.isAcquiredViaFamilySharing??!1)w=0,T="Spend is omitted from this subscription, because this player acquired it via Family Sharing instead of purchasing it themselves.";else{const H=_.lastKnownState?.numPeriods??1;w=H*A,T=`${z(H,"period")}, reference price ${A}`}R+=w,K[h]={platform:ee,spend:w,spendExplanation:T,referencePrice:A,otherPlayers:o.value.iapSubscriptionsExtra.instances[h].otherPlayers,..._}}C.unshift({productId:y,spend:R,...S,subscriptionInstances:K})}return C}),{showSuccessNotification:g}=U();async function X(c){await t.post(`/players/${o.value.model.playerId}/removeIAPSubscription/${c}`),g(`Subscription '${c}' detached from this player.`),x()}function Z(){i.value={}}function $(c){return B.fromISO(o.value.model.currentTime)<B.fromISO(c)}const O={props:I,gameServerApi:t,coreStore:N,staticInfos:k,playerData:o,playerRefresh:x,sortOptions:P,selectedSubscription:i,enableSubscriptionRemoving:d,subscriptionList:M,showSuccessNotification:g,removeSubscription:X,resetModal:Z,isActive:$,get DateTime(){return B},computed:L,ref:G,get useGameServerApi(){return Q},get useStaticInfos(){return q},get MetaListSortDirection(){return v},get MetaListSortOption(){return b},get MActionModalButton(){return le},get MBadge(){return ne},get MCollapse(){return ie},get MList(){return se},get MListItem(){return re},get MTextButton(){return ae},get MTooltip(){return oe},get useNotifications(){return U},get maybePluralString(){return z},get useSubscription(){return j},get useCoreStore(){return V},get getSinglePlayerSubscriptionOptions(){return W}};return Object.defineProperty(O,"__isScriptSetup",{enumerable:!1,value:!0}),O}}),pe={key:0},me={class:"tw-ml-1 tw-text-neutral-500"},ce={key:0,class:"tw-text-red-500"},fe={key:0},ye={key:0},ge={key:1},Se={key:2,class:"tw-text-orange-400"},we={key:1},be={key:2},ve={key:0,class:"font-weight-bold tw-mb-1"},xe={key:0,class:"text-danger"},Me={key:0,class:"tw-text-right"},he={key:1,class:"tw-text-right"},_e={key:2,class:"tw-text-right"},Te={class:"tw-mt-1 tw-inline-flex tw-w-full tw-justify-end"};function Ie(E,e,I,t,N,k){const o=D("meta-time"),x=D("meta-no-seatbelts"),P=D("meta-list-card");return t.playerData?(s(),l("div",pe,[a(P,{class:"tw-mb-4",title:"Subscription History",icon:"money-check-alt",itemList:t.subscriptionList,sortOptions:t.sortOptions,emptyMessage:"No subscriptions... yet!","data-testid":"player-subscriptions-history-card"},{"item-card":n(({item:i})=>[a(t.MCollapse,{extraMListItemMargin:""},{header:n(()=>[a(t.MListItem,{noLeftPadding:""},{badge:n(()=>[t.isActive(i.expirationTime)?(s(),p(t.MBadge,{key:0,variant:"success"},{default:n(()=>e[0]||(e[0]=[r("Active")]),void 0,!0),_:1})):(s(),p(t.MBadge,{key:1},{default:n(()=>e[1]||(e[1]=[r("Expired")]),void 0,!0),_:1}))]),"top-right":n(()=>[a(o,{date:i.startTime,showAs:"date"},null,8,["date"])]),"bottom-left":n(()=>[i.latestInstanceIsDisabledDueToReuse?(s(),l("div",ce,"The subscription was disabled because it was used on another player account.")):m("",!0)]),"bottom-right":n(()=>[t.isActive(i.expirationTime)?(s(),l("div",fe,[i.renewalStatus==="ExpectedToRenew"?(s(),l("span",ye,[e[2]||(e[2]=r("Renewing ")),a(o,{date:i.expirationTime},null,8,["date"])])):i.renewalStatus==="NotExpectedToRenew"?(s(),l("span",ge,[e[3]||(e[3]=r("Set to expire in ")),a(o,{date:i.expirationTime},null,8,["date"])])):(s(),l("span",Se,"Unhandled renewal status: "+u(i.renewalStatus),1))])):(s(),l("div",we,[e[4]||(e[4]=r("Expired ")),a(o,{date:i.expirationTime},null,8,["date"])]))]),default:n(()=>[r(u(i.productId),1),f("span",me,"$"+u(i.spend.toFixed(2)),1)],void 0,!0),_:2},1024)]),default:n(()=>[e[19]||(e[19]=f("div",{class:"font-weight-bold"},"Overview",-1)),a(t.MList,{class:"tw-my-2",showBorder:"",striped:""},{default:n(()=>[a(t.MListItem,{condensed:""},{"top-right":n(()=>[a(o,{date:i.startTime,showAs:"datetime"},null,8,["date"])]),default:n(()=>[e[5]||(e[5]=r("Start time"))],void 0,!0),_:2},1024),a(t.MListItem,{condensed:""},{"top-right":n(()=>[a(o,{date:i.expirationTime,showAs:"datetime"},null,8,["date"])]),default:n(()=>[e[6]||(e[6]=r("Expiration time"))],void 0,!0),_:2},1024),a(t.MListItem,{condensed:""},{"top-right":n(()=>[i.renewalStatus==="ExpectedToRenew"?(s(),p(t.MBadge,{key:0,variant:"success"},{default:n(()=>e[7]||(e[7]=[r("On")]),void 0,!0),_:1})):i.renewalStatus==="NotExpectedToRenew"?(s(),p(t.MBadge,{key:1},{default:n(()=>e[8]||(e[8]=[r("Off")]),void 0,!0),_:1})):(s(),l("span",be,u(i.renewalStatus),1))]),default:n(()=>[e[9]||(e[9]=r("Auto-renewal status"))],void 0,!0),_:2},1024)],void 0,!0),_:2},1024),i.subscriptionInstances?.length>0?(s(),l("div",ve,[e[14]||(e[14]=r("Individual Subscriptions")),a(t.MList,{class:"tw-my-2",showBorder:"",striped:""},{default:n(()=>[(s(!0),l(Y,null,J(i.subscriptionInstances,(d,M)=>(s(),p(t.MListItem,{class:"tw-px-3",key:M,striped:""},{"top-right":n(()=>[t.isActive(d.lastKnownState.expirationTime)?(s(),p(t.MBadge,{key:0,variant:"success"},{default:n(()=>e[10]||(e[10]=[r("Active")]),void 0,!0),_:1})):(s(),p(t.MBadge,{key:1},{default:n(()=>e[11]||(e[11]=[r("Expired")]),void 0,!0),_:1}))]),"bottom-left":n(()=>[f("span",null,u(M),1),d.disabledDueToReuse?(s(),l("div",xe,[f("div",null,"The subscription was disabled because it was used on "+u(t.maybePluralString(d.otherPlayers.length,"other player account"))+":",1),(s(!0),l(Y,null,J(d.otherPlayers,g=>(s(),l("div",null,[a(t.MTextButton,{to:`/players/${g}`},{default:n(()=>[r(u(g),1)],void 0,!0),_:2},1032,["to"])]))),256))])):m("",!0)]),"bottom-right":n(()=>[d.lastKnownState?(s(),l("div",Me,[e[12]||(e[12]=r("Start: ")),a(o,{date:d.lastKnownState.startTime},null,8,["date"])])):m("",!0),d.lastKnownState?(s(),l("div",he,[e[13]||(e[13]=r("Expiry: ")),a(o,{date:d.lastKnownState.expirationTime},null,8,["date"])])):m("",!0),d.lastKnownState?(s(),l("div",_e,"Periods: "+u(d.lastKnownState.numPeriods),1)):m("",!0)]),default:n(()=>[r(u(d.platform),1),a(t.MTooltip,{class:"tw-ml-1",content:d.spendExplanation},{default:n(()=>[r("$"+u(d.spend.toFixed(2)),1)],void 0,!0),_:2},1032,["content"])],void 0,!0),_:2},1024))),128))],void 0,!0),_:2},1024)])):m("",!0),f("div",Te,[t.enableSubscriptionRemoving?(s(),p(t.MActionModalButton,{key:0,"modal-title":"Detach Subscription",action:()=>t.removeSubscription(i.productId),"trigger-button-label":"Detach Subscription",variant:"danger","ok-button-label":"Detach Subscription",permission:"api.players.remove_iap_subscription",onShow:d=>t.selectedSubscription=i},{default:n(()=>[f("p",null,[e[15]||(e[15]=r("You are about to detach the ")),a(t.MBadge,null,{default:n(()=>[r(u(t.selectedSubscription.productId),1)],void 0,!0),_:1}),e[16]||(e[16]=r(" subscription from ")),a(t.MBadge,null,{default:n(()=>[r(u(t.playerData.model.playerName),1)],void 0,!0),_:1}),e[17]||(e[17]=r(". This will also remove the related subscription IAP from the player's purchase history."))]),e[18]||(e[18]=f("div",{class:"tw-text-xs+ tw-text-neutral-500"},"Players can re-activate their subscriptions by reclaiming IAPs from within the game. Detaching a subscription does not refund the purchase and instead is primarily a development-only tool.",-1)),a(x,{class:"tw-mt-4",name:t.playerData.model.playerName},null,8,["name"])],void 0,!0),_:2},1032,["action","onShow"])):m("",!0)])],void 0,!0),_:2},1024)]),_:1},8,["itemList"])])):m("",!0)}const Ee=de(ue,[["render",Ie],["__file","PlayerSubscriptionHistoryCard.vue"]]);export{Ee as default};
